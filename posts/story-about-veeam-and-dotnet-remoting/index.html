<!DOCTYPE html>
<html lang="en" dir="auto" data-theme="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>CÃ¢u chuyá»‡n vá» Veeam vÃ  .NET Remoting (CVE-2025-48983) | nhienit</title>
<meta name="keywords" content="research">
<meta name="description" content=".NET Remoting exploit with CVE-2025-48983">
<meta name="author" content="nhienit">
<link rel="canonical" href="https://nhienit2010.github.io/posts/story-about-veeam-and-dotnet-remoting/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.343cc480b9ffc8f04ccbe5e968ad674880cab773ec19905e93033065c1e7a804.css" integrity="sha256-NDzEgLn/yPBMy&#43;XpaK1nSIDKt3PsGZBekwMwZcHnqAQ=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://nhienit2010.github.io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://nhienit2010.github.io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://nhienit2010.github.io/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://nhienit2010.github.io/apple-touch-icon.png">
<link rel="mask-icon" href="https://nhienit2010.github.io/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="https://nhienit2010.github.io/posts/story-about-veeam-and-dotnet-remoting/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
                color-scheme: dark;
            }

            .list {
                background: var(--theme);
            }

            .toc {
                background: var(--entry);
            }
        }

        @media (prefers-color-scheme: light) {
            .list::-webkit-scrollbar-thumb {
                border-color: var(--code-bg);
            }
        }

    </style>
</noscript>
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.querySelector("html").dataset.theme = 'dark';
    } else if (localStorage.getItem("pref-theme") === "light") {
       document.querySelector("html").dataset.theme = 'light';
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.querySelector("html").dataset.theme = 'dark';
    } else {
        document.querySelector("html").dataset.theme = 'light';
    }

</script><meta property="og:url" content="https://nhienit2010.github.io/posts/story-about-veeam-and-dotnet-remoting/">
  <meta property="og:site_name" content="nhienit">
  <meta property="og:title" content="CÃ¢u chuyá»‡n vá» Veeam vÃ  .NET Remoting (CVE-2025-48983)">
  <meta property="og:description" content=".NET Remoting exploit with CVE-2025-48983">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-11-28T21:34:54+07:00">
    <meta property="article:modified_time" content="2025-11-28T21:34:54+07:00">
    <meta property="article:tag" content="Research">
      <meta property="og:image" content="https://nhienit2010.github.io/images/papermod-cover.png">
      <meta property="og:see_also" content="https://nhienit2010.github.io/posts/me_sqli_to_rce/">
      <meta property="og:see_also" content="https://nhienit2010.github.io/posts/cve-2024-5443-path-traversal-to-rce/">
      <meta property="og:see_also" content="https://nhienit2010.github.io/posts/cve-2022-3133-drawio-xss-to-rce/">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://nhienit2010.github.io/images/papermod-cover.png">
<meta name="twitter:title" content="CÃ¢u chuyá»‡n vá» Veeam vÃ  .NET Remoting (CVE-2025-48983)">
<meta name="twitter:description" content=".NET Remoting exploit with CVE-2025-48983">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://nhienit2010.github.io/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "CÃ¢u chuyá»‡n vá» Veeam vÃ  .NET Remoting (CVE-2025-48983)",
      "item": "https://nhienit2010.github.io/posts/story-about-veeam-and-dotnet-remoting/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "CÃ¢u chuyá»‡n vá» Veeam vÃ  .NET Remoting (CVE-2025-48983)",
  "name": "CÃ¢u chuyá»‡n vá» Veeam vÃ  .NET Remoting (CVE-2025-48983)",
  "description": ".NET Remoting exploit with CVE-2025-48983",
  "keywords": [
    "research"
  ],
  "articleBody": "CÃ³ thá»ƒ xem nhÆ° Ä‘Ã¢y lÃ  bÃ i post Ä‘áº§u tiÃªn cá»§a mÃ¬nh trong nÄƒm nay, cÅ©ng gáº§n cuá»‘i nÄƒm má»›i cÃ³ há»©ng Ä‘á»ƒ viáº¿t bÃ i vÃ  má»™t pháº§n cÅ©ng vÃ¬ dáº¡o nÃ y cÅ©ng cáº£m tháº¥y khÃ´ng cÃ³ gÃ¬ hay ho Ä‘á»ƒ viáº¿t háº¿t cáº£ ğŸ˜¢!\nNÃªn trong lÃºc lÆ°á»£n lá» má»™t vÃ²ng quanh internet Ä‘á»ƒ tÃ¬m cáº£m há»©ng, vÃ´ tÃ¬nh tÃ¬m tháº¥y má»™t list advisory vÃ  cÅ©ng thÃ´i thÃºc mÃ¬nh thá»­ tÃ¬m hiá»ƒu xem cÃ¡c CVE nÃ y cÃ³ gÃ¬ hay mÃ  Ä‘iá»ƒm CVSS Ä‘áº¿n táº­n 9.9. VÃ¬ tháº¿, nÃªn mÃ¬nh Ä‘Ã£ chá»n CVE-2025-48983 Ä‘á»ƒ phÃ¢n tÃ­ch vÃ  dÃ¹ sao thÃ¬ cÅ©ng má»™t cÃ´ng Ä‘Ã´i viá»‡c, báº¯t Ä‘áº§u thÃ´i nÃ o !\n#Má»Ÿ Ä‘áº§u Veeam Backup \u0026 Replication lÃ  pháº§n má»m sao lÆ°u vÃ  phá»¥c há»“i dá»¯ liá»‡u phá»• biáº¿n dÃ nh cho mÃ´i trÆ°á»ng áº£o hÃ³a, váº­t lÃ½ vÃ  Ä‘Ã¡m mÃ¢y, chá»§ yáº¿u dÃ¹ng trong doanh nghiá»‡p. Trong Ä‘Ã³, á»©ng dá»¥ng tá»“n táº¡i má»™t sá»‘ thÃ nh pháº§n chÃ­nh nhÆ° :\nVeeam Backup Server : server chÃ­nh quáº£n lÃ½ cÃ¡c jobs, repository, proxy, â€¦ Veeam Backup Proxy : giÃºp thá»±c thi Ä‘á»c/ghi dá»¯ liá»‡u, tÄƒng tá»‘c Ä‘á»™ backup, â€¦ Veeam Backup Repository : lÃ  nÆ¡i lÆ°u trá»¯ cÃ¡c file backup Veeam Agent : Ä‘á»ƒ cÃ i lÃªn mÃ¡y host dÃ¹ng cho viá»‡c backup/restore Veeam Console : GUI quáº£n lÃ½ chung, xem cÃ¡c jobs, policy, â€¦ â€¦ Lá»— há»•ng Ä‘Æ°á»£c report bá»Ÿi Code White lÃ  má»™t tá»• chá»©c an ninh máº¡ng ná»•i tiáº¿ng táº¡i Äá»©c, liÃªn quan Ä‘áº¿n dá»‹ch vá»¥ Mount Service trÃªn á»©ng dá»¥ng Veeam Backup \u0026 Replication cho phÃ©p thá»±c thi mÃ£ tá»« xa (RCE) trÃªn cÃ¡c mÃ¡y host náº±m trong Backup Infrastructure vá»›i quyá»n domain user vÃ  nhá»¯ng host khÃ´ng join domain thÃ¬ sáº½ khÃ´ng bá»‹ áº£nh hÆ°á»Ÿng bá»Ÿi lá»— há»•ng nÃ y.\nÄá»c lÆ°á»›t qua nghe thÃ¬ cÃ³ váº» rá»‘i nÃ£o, nhÆ°ng cÃ³ má»™t sá»‘ Ã½ ta cáº§n pháº£i note láº¡i trong quÃ¡ trÃ¬nh phÃ¢n tÃ­ch nhÆ°: Mount Service, RCE, authenticated domain user, Backup Infrastructure vÃ¬ chÃºng cÃ³ thá»ƒ sáº½ giÃºp ta thu háº¹p láº¡i pháº¡m vi code audit trong quÃ¡ trÃ¬nh phÃ¢n tÃ­ch.\n#CÃ¡c version bá»‹ áº£nh hÆ°á»Ÿng Veeam Backup \u0026 Replication \u003c= 12.3.2.3617 #Setup mÃ´i trÆ°á»ng Thá»±c hiá»‡n download cÃ¡c báº£n cÃ i Ä‘áº·t:\nInstaller: https://download2.veeam.com/VBR/v12/VeeamBackup\u0026Replication_12.3.2.3617_20250610.iso Patch: https://www.veeam.com/download_add_packs/vmware-esx-backup/12.3.2.4165_20251014_update_exe/ Sau khi thá»±c hiá»‡n download file cÃ i Ä‘áº·t dáº¡ng .iso xong, thá»±c hiá»‡n mount ra Ä‘Ä©a, run setup.exe vÃ  cÃ i Ä‘áº·t háº¿t cÃ¡c option trong Ä‘Ã³ lÃ  coi nhÆ° viá»‡c cÃ i Ä‘áº·t hoÃ n táº¥t.\nTuy nhiÃªn, cÃ³ má»™t sá»‘ pháº§n service cáº§n license Ä‘á»ƒ cÃ i Ä‘áº·t, thÃ¬ cÃ³ thá»ƒ táº¡o tÃ i khoáº£n táº¡i https://my.veeam.com/ vÃ  vÃ o pháº§n Trial license láº¥y license dÃ¹ng thá»­ Ä‘á»ƒ thá»±c hiá»‡n cÃ i Ä‘áº·t.\n#PhÃ¢n tÃ­ch báº£n vÃ¡ Theo nhÆ° mÃ´ táº£ trÃªn Issue Details, nháº­n tháº¥y ráº±ng lá»— há»•ng chá»§ yáº¿u náº±m táº¡i Mount Service, nÃªn sá»­ dá»¥ng dnspy attach vÃ o process Veeam.Backup.MountService.exe vÃ  sau Ä‘Ã³ thá»±c hiá»‡n load háº¿t cÃ¡c module mÃ  process Ä‘ang sá»­ dá»¥ng trÆ°á»›c khi decompile ra cÃ¡c file csharp, Ä‘áº£m báº£o option Show tokens,... táº¡i Debug \u003e Options \u003e Decompiler Ä‘Æ°á»£c bá» tick, má»¥c Ä‘Ã­ch lÃ  Ä‘á»ƒ bá» bá»›t cÃ¡c thÃ´ng tin mÃ´ táº£ thá»«a hoáº·c byte rÃ¡c Ä‘á»ƒ thuáº­n tiá»‡n cho viá»‡c diff. Sau Ä‘Ã³, táº¡i Assembly Explorer thá»±c hiá»‡n nháº¥n tá»• há»£p phÃ­m Ctrl + A Ä‘á»ƒ chá»n háº¿t cÃ¡c assembly vÃ  sau Ä‘Ã³ chá»n File \u003e Export to Project... Ä‘á»ƒ thá»±c hiá»‡n decompile ra má»™t thÆ° má»¥c chuáº©n bá»‹ cho viá»‡c diff. Vá» pháº§n báº£n vÃ¡, táº¡i folder Fixed ta tháº¥y cÃ³ má»™t báº£n cÃ i Ä‘áº·t riÃªng cho Mount Service lÃ  VeeamMountService.msi, chá»• nÃ y ta thá»±c hiá»‡n cÃ i Ä‘áº·t riÃªng nÃ³ trÃªn má»™t mÃ¡y khÃ¡c hoáº·c á»Ÿ Ä‘Ã¢u Ä‘Ã³ vÃ  thá»±c hiá»‡n decompile tÆ°Æ¡ng tá»± báº±ng dnspy nhÆ° cÃ¡ch trÃªn.\nSau khi decompile version bá»‹ lá»—i vÃ  cáº£ báº£n vÃ¡, viá»‡c cÃ²n láº¡i lÃ  vá»©t vÃ o WinMerge Ä‘á»ƒ diff thÃ´i. VÃ  á»Ÿ cáº£ pháº§n diff nÃ y thÃ¬ mÃ¬nh cÅ©ng sáº½ chá»§ yáº¿u focus táº¡i cÃ¡c namespace cá»§a Mount Service nhÆ°:\nVeeam.Backup.MountServiceLib.* Veeam.Backup.MountService.* Trong lÃºc xem xÃ©t báº£n vÃ¡, táº¡i constructor cá»§a class Veeam.Backup.MountServiceLib.CMountServiceEnvironment cÃ³ má»™t Ä‘iá»ƒm cáº£m tháº¥y báº¥t thÆ°á»ng vÃ  khiáº¿n mÃ¬nh tÃ² mÃ² muá»‘n phÃ¢n tÃ­ch sÃ¢u lÃ  báº£n vÃ¡ Ä‘Ã£ add thÃªm tham sá»‘ thá»© 3 cho hÃ m CCliTcpChannelRegistration.Make() vÃ  force value lÃ  true.\nTheo nhÆ° báº£n gá»‘c, thÃ¬ táº¡i hÃ m Veeam.Common.Remoting.CCliTcpChannelRegistration#Make() chÆ°a define hÃ m nÃ o nháº­n vÃ o tham sá»‘ thá»© 3 lÃ  kiá»ƒu boolean nÃªn hiá»‡n táº¡i chÆ°a biáº¿t tham sá»‘ thá»© ba trÃªn cÃ³ Ã½ nghÄ©a lÃ  gÃ¬ cáº£! Trá»Ÿ vá» xem xÃ©t láº¡i báº£n diff, táº¡i Veeam.Common.Remoting.CCliTcpChannelRegistration Ä‘Ã£ thÃªm má»™t new version cá»§a hÃ m Make() vá»›i thÃªm má»™t argument lÃ  whitelistResponse vÃ  tham sá»‘ whitelistResponse nÃ y, Ä‘Æ°á»£c Ä‘áº·t tháº³ng vÃ o Veeam.Common.Remoting.CBinaryClientFormatterSinkProvider.\nNhÃ¬n sÆ¡ bá»™, náº¿u ai Ä‘Ã£ tá»«ng xem qua thÃ¬ cÃ³ thá»ƒ nháº­n tháº¥y ráº±ng chÆ°Æ¡ng trÃ¬nh Ä‘ang khá»Ÿi táº¡o má»™t .NET Remoting Client service cÃ²n hoáº¡t Ä‘á»™ng nhÆ° nÃ o thÃ¬ mÃ¬nh sáº½ giá»›i thiá»‡u sau nhÆ°ng á»Ÿ Ä‘Ã¢y chÆ°Æ¡ng trÃ¬nh cÃ³ sá»­ dá»¥ng má»™t sink provider lÃ  CBinaryClientFormatterSinkProvider.\nCÃ³ thá»ƒ hiá»ƒu nÃ´m na lÃ  cÃ¡c sink provider dÃ¹ng Ä‘á»ƒ táº¡o hoáº·c cáº¥u hÃ¬nh lÃªn má»™t chuá»—i cÃ¡i sink (sink chain) vÃ  má»—i sink Ä‘Æ°á»£c sinh ra Ä‘á»ƒ thá»±c hiá»‡n xá»­ lÃ½ luá»“ng message Ä‘i qua cÃ¡c channel cho viá»‡c logging, serialzation, decrypt, uncompression, â€¦ cÃ¡c message Ä‘á»ƒ server xá»­ lÃ½ hoáº·c xuá»‘ng táº§ng transport Ä‘á»ƒ gá»­i Ä‘i qua channel khÃ¡c.\nNhÆ° Ä‘Ã£ nÃ³i, viá»‡c táº¡o cÃ¡c sink sáº½ Ä‘Æ°á»£c gá»i qua hÃ m CreateSink(), cá»¥ thá»ƒ táº¡i class Veeam.Common.Remoting.CBinaryClientFormatterSinkProvider nhÆ° sau: sáº½ tráº£ vá» má»™t instance cá»§a CBinaryClientFormatterSink, trong Ä‘Ã³ argument _whitelistResponse lÃ  thá»© mÃ  ta cáº§n quan tÃ¢m. VÃ¬ Ä‘Ã¢y lÃ  má»™t .NET Remoting Client nÃªn cÃ³ thá»ƒ quan sÃ¡t tháº¥y ráº±ng há» khÃ´ng implement cÃ¡c hÃ m xá»­ lÃ½ request message táº¡i hÃ m Veeam.Common.Remoting.CBinaryClientFormatterSink#AsyncProcessResponse() thá»±c hiá»‡n deserialize response stream thÃ´ng qua hÃ m DeserializeMessage() tiáº¿p tá»¥c, gá»i tiáº¿p hÃ m Veeam.Common.Remoting.CCoreChannel#DeserializeBinaryResponseMessage() lÃºc nÃ y biáº¿n whitelistResponse Ä‘Æ°á»£c Ä‘á»•i tÃªn thÃ nh useRestrictedBinder vÃ  Ä‘Ã¢y lÃ  máº¥u chá»‘t cá»§a váº¥n Ä‘á», khi useRestrictedBinder lÃ  true thÃ¬ chÆ°Æ¡ng trÃ¬nh sáº½ sá»­ dá»¥ng class RestrictedSerializationBinder cho BinaryFormatter Ä‘á»ƒ ngÄƒn cháº·n deserialization attack nÃªn Ä‘Ã³ cÅ©ng lÃ  lÃ½ do báº£n vÃ¡ force value lÃ  true cho tham sá»‘ thá»© ba cá»§a hÃ m Veeam.Common.Remoting.CCliTcpChannelRegistration#Make() Táº¡i báº£n cÅ©, by default lÃ  false vÃ¬ cÃ³ thá»ƒ developer nghÄ© ráº±ng client luÃ´n káº¿t ná»‘i Ä‘áº¿n má»i .NET Remoting Server Ä‘Ã¡ng tin cáº­y hoáº·c khÃ´ng thá»ƒ nÃ o modify Ä‘á»ƒ táº¡o ra Ä‘Æ°á»£c má»™t malicious response Ä‘á»ƒ táº¥n cÃ´ng chá»• nÃ y :)) #PhÃ¢n tÃ­ch CÅ©ng khÃ´ng quÃ¡ khÃ³ Ä‘á»ƒ chÃºng ta cÃ³ thá»ƒ tÃ¬m Ä‘Æ°á»£c sink cá»§a lá»— há»•ng nhÆ° bÃªn trÃªn, cÃ²n láº¡i viá»‡c tÃ¬m Ä‘iá»ƒm Ä‘á»ƒ trigger lá»— há»•ng thÃ¬ mÃ¬nh nghÄ© má»›i thá»±c sá»± lÃ  váº¥n Ä‘á» :)). NhÆ°ng trÆ°á»›c khi Ä‘i sÃ¢u vÃ o phÃ¢n tÃ­ch thÃ¬ cÃ³ má»™t sá»‘ khÃ¡i niá»‡m cáº§n pháº£i tÃ¬m hiá»ƒu.\n#.NET Remoting Theo cÃ¡ch hiá»ƒu nÃ´m na cá»§a mÃ¬nh, Ä‘Ã¢y lÃ  má»™t cÃ´ng nghá»‡ cho phÃ©p cÃ¡c Application Domain hoáº·c cÃ¡c process cÃ³ thá»ƒ giao tiáº¿p Ä‘Æ°á»£c vá»›i nhau thÃ´ng qua cÃ¡c channel. ThÃ¬ vá» cÆ¡ báº£n, cÃ¡c Application Domain hoáº·c cÃ¡c process Ä‘Æ°á»£c cÃ´ láº­p vá»›i nhau Ä‘á»ƒ náº¿u cÃ³ xáº£y ra trá»¥c tráº·c sáº½ trÃ¡nh áº£nh hÆ°á»Ÿng Ä‘áº¿n quÃ¡ trÃ¬nh hoáº¡t Ä‘á»™ng cá»§a nhau, vÃ¬ tháº¿ .NET Remoting ra Ä‘á»i nhÆ° má»™t cáº§u ná»‘i Ä‘á»ƒ chÃºng cÃ³ thá»ƒ giao tiáº¿p Ä‘Æ°á»£c vá»›i nhau (hay cÃ²n gá»i lÃ  giao tiáº¿p liÃªn tiáº¿n trÃ¬nh). CÆ¡ cháº¿ hoáº¡t Ä‘á»™ng cá»§a .NET Remoting cÅ©ng na nÃ¡ so vá»›i Java RMI, nghÄ©a lÃ  mÃ´ hÃ¬nh cho phÃ©p server expose má»™t sá»‘ object, Ä‘á»“ng thá»i táº¡o instance cho cÃ¡c object Ä‘Ã³ cho phÃ©p cÃ¡c client cÃ³ thá»ƒ nÃ³ gá»i tá»« xa (remotable object), vÃ  phÃ­a client cÃ³ thá»ƒ gá»i cÃ¡c remotable object Ä‘Ã³ trÃªn process á»Ÿ phÃ­a server thÃ´ng qua giao thá»©c TCP/HTTP/IPC.\nTrÃªn phÃ­a server sáº½ define má»™t táº­p cÃ¡c object Ä‘Æ°á»£c expose ra bÃªn ngoÃ i cho client cÃ³ thá»ƒ gá»i tá»›i, song Ä‘Ã³ thÃ¬ phÃ­a client cÅ©ng pháº£i cÃ³ táº­p cÃ¡c instance vá» nhá»¯ng remotable object Ä‘Ã³ trÆ°á»›c khi call lÃªn server. ThÆ°á»ng thÃ¬ cÃ¡c remotable object nÃ y Ä‘Æ°á»£c gÃ³i vÃ  chia sáº» trong cÃ¡c file dll.\nThÆ°á»ng thÃ¬ cÃ¡c remotable object nÃªn Ä‘Æ°á»£c káº¿ thá»«a tá»« class/interface lÃ  Serializable hoáº·c MarshalByRefObject thÃ¬ cÃ¡c client má»›i cÃ³ thá»ƒ gá»i tá»« xa , kiá»ƒu nhÆ° sau:\nusing System; using System.Collections.Generic; using System.Linq; using System.Text; using System.Threading.Tasks; namespace RemotingSample { public class RemoteMath : MarshalByRefObject { public int Add(int a, int b) // add { Console.WriteLine(\"Add({0},{1}) called\", a, b); return a + b; } public int Sub(int a, int b) // subtract { Console.WriteLine(\"Sub({0},{1}) called\", a, b); return a - b; } } } ThÃ´ng tin vá» cÃ¡c sink provider mÃ¬nh cÅ©ng Ä‘Ã£ nÃ³i sÆ¡ á»Ÿ bÃªn trÃªn, ta cÃ³ thá»ƒ hÃ¬nh dung mÃ´ hÃ¬nh hoáº¡t Ä‘á»™ng nhÆ° á»Ÿ bÃªn dÆ°á»›i: Nguá»“n: https://g7shot.com/posts/net/netremoting101/\nFramework cung cáº¥p 2 cÆ¡ cháº¿ cho phÃ©p cÃ¡c object cÃ³ thá»ƒ Ä‘i qua cÃ¡c domain vá»›i nhau lÃ  Marshalling by reference vÃ  Marshalling by value.\nCÆ¡ cháº¿ Marshalled by value Ä‘Æ°á»£c sá»­ dá»¥ng khi má»™t object Ä‘Æ°á»£c marked lÃ  Serializable attribute, Ä‘á»ƒ há»— trá»£ Ä‘iá»u nÃ y thÃ¬ BinaryFormatter class Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ convert thÃ nh cÃ¡c byte stream Ä‘á»ƒ truyá»n qua cÃ¡c AppDomain khÃ¡c. Náº¿u má»™t object cáº§n Marshalled by reference thÃ¬ nÃ³ cáº§n pháº£i implement tá»« class System.MarshalByRefObject, báº¥t ká»³ object nÃ o báº¯t nguá»“n tá»« type nÃ y thÃ¬ tá»± Ä‘á»™ng Ä‘Æ°á»£c xá»­ lÃ½ bá»Ÿi framework, khi nÃ³ Ä‘i qua Application Domain khÃ¡c thÃ¬ framework sáº½ gá»i hÃ m MarshalByRefObject.CreateObjRef Ä‘á»ƒ tráº£ vá» má»™t instance cá»§a System.Runtime.Remoting.ObjRef , thÃ¬ instance sáº½ chá»©a táº¥t cáº£ cÃ¡c thÃ´ng tin cáº§n Ä‘á»ƒ tham chiáº¿u tá»›i object cáº§n Ä‘Æ°á»£c gá»i vÃ  giao tiáº¿p ngÆ°á»£c láº¡i vá»›i channel. Object ObjRef Ä‘Æ°á»£c truyá»n qua cÃ¡c Application Domain khÃ¡c báº±ng cÃ¡ch serialize thÃ nh dáº¡ng byte stream, bÃªn Application Domain nháº­n sáº½ thá»±c hiá»‡n deserialize vÃ  construct láº¡i object nÃ y. TrÃªn lÃ  theo gÃ³c nhÃ¬n cá»§a mÃ¬nh, tháº­t ra kiáº¿n trÃºc nÃ y phá»©c táº¡p nhiá»u hÆ¡n mÃ¬nh nghÄ© Ä‘á»‘i vá»›i gÃ³c nhÃ¬n cá»§a mÃ¬nh cÃ³ thá»ƒ cÃ³ nhiá»u sai sÃ³t nÃªn Ä‘á»ƒ chi tiáº¿t hÆ¡n thÃ¬ cÃ¡c báº¡n cÃ³ thá»ƒ Ä‘á»c thÃªm táº¡i cÃ¡c tÃ i liá»‡u sau:\nhttps://parsiya.net/blog/2015-11-14-intro-to-.net-remoting-for-hackers/ https://www.codeproject.com/Articles/18997/Remoting-Architecture-in-NET http://rfc.nop.hu/winprot4/MS-NRTP.pdf https://g7shot.com/posts/net/netremoting101/ #Backup Infrastructure Backup Infrastructure trong Veeam Backup \u0026 Replication lÃ  toÃ n bá»™ táº­p há»£p cÃ¡c thÃ nh pháº§n pháº§n cá»©ng vÃ  pháº§n má»m Ä‘Æ°á»£c Veeam sá»­ dá»¥ng Ä‘á»ƒ thá»±c hiá»‡n cÃ¡c hoáº¡t Ä‘á»™ng backup, restore vÃ  replication. Má»¥c Ä‘Ã­ch lÃ  giÃºp Veeam:\nKáº¿t ná»‘i Ä‘áº¿n mÃ´i trÆ°á»ng áº£o hÃ³a (VMware, Hyper-V), mÃ¡y váº­t lÃ½, cloud. Quáº£n lÃ½ luá»“ng dá»¯ liá»‡u (Ä‘á»c â†’ xá»­ lÃ½ â†’ lÆ°u trá»¯). XÃ¡c Ä‘á»‹nh nÆ¡i lÆ°u backup, cÃ¡ch cháº¡y job vÃ  tÃ i nguyÃªn sá»­ dá»¥ng. #Storage Infrastructure Storage Infrastructure trong Veeam lÃ  táº­p há»£p cÃ¡c há»‡ thá»‘ng lÆ°u trá»¯ mÃ  Veeam cÃ³ thá»ƒ káº¿t ná»‘i trá»±c tiáº¿p Ä‘á»ƒ láº¥y snapshot, Ä‘á»c dá»¯ liá»‡u hoáº·c tá»‘i Æ°u hoÃ¡ quÃ¡ trÃ¬nh backup vÃ  restore. GiÃºp Veeam:\nKhai thÃ¡c storage snapshot Ä‘á»ƒ backup nhanh hÆ¡n vÃ  khÃ´ng áº£nh hÆ°á»Ÿng Ä‘áº¿n production. TÄƒng tá»‘c Ä‘á»™ restore (Instant VM Recovery, file/volume recovery). #CVE-2025-48983 NghiÃªn cá»©u láº¡i má»™t xÃ­u vá» Mount Service, ngoÃ i viá»‡c chÆ°Æ¡ng trÃ¬nh táº¡o má»™t .NET Remoting Client (táº¡i line 49) thÃ¬ bÃªn cáº¡nh cÃ²n táº¡o thÃªm má»™t .NET Remoting Server (táº¡i line 48) ná»¯a vá»›i channel name lÃ  rstcp Dá»‹ch vá»¥ nÃ y run táº¡i port 6170 vÃ  cÅ©ng lÃ  port Mount Service Ä‘ang cháº¡y .NET Remoting Server cháº¡y vá»›i má»™t sá»‘ cáº¥u hÃ¬nh nhÆ° sau: dictionary[\"secure\"] = \"true\" cho tháº¥y ráº±ng client cáº§n pháº£i xÃ¡c thá»±c trÆ°á»›c khi truy cáº­p vÃ o dá»‹ch vá»¥ bÃªn trong, Ä‘iá»u nÃ y cÅ©ng gáº§n giá»‘ng vá»›i mÃ´ táº£ cá»§a issue details :))\nNgoÃ i port ra, má»™t thá»© ta cáº§n biáº¿t ná»¯a lÃ  service name, vÃ¬ pháº£i biáº¿t service name thÃ¬ client má»›i connect Ä‘áº¿n chÃ­nh xÃ¡c Ä‘Æ°á»£c. Trace code ngÆ°á»£c láº¡i tá»« lÃºc init enviroment, ta tháº¥y Ä‘Æ°á»£c hÃ m Veeam.Backup.MountService.CMountService#OnStart() sáº½ Ä‘Æ°á»£c gá»i khi Mount Service cháº¡y. bá»Ÿi vÃ¬ class Veeam.Backup.MountService.CMountService Ä‘Æ°á»£c implement tá»« System.ServiceProcess.ServiceBase Theo document: Táº¡i hÃ m Veeam.Backup.MountServiceLib.CRestoreServiceRemotingApiRegistration#RegisterRemotingTypes() sáº½ thá»±c hiá»‡n Ä‘Äƒng kÃ½ má»™t .NET Remoting service VÃ  cuá»‘i cÃ¹ng thÃ¬ mÃ¬nh cÅ©ng tháº¥y Ä‘Æ°á»£c service name Ä‘Æ°á»£c define táº¡i Veeam.Backup.MountServiceLib.CMountServiceImpl#StartLeasing() cÃ³ tÃªn lÃ  RestoreService NhÆ° phÃ¢n tÃ­ch tá»« bÆ°á»›c Ä‘áº§u, sink ta cáº§n reach Ä‘áº¿n lÃ  chá»©c nÄƒng deserialize response á»Ÿ .NET Remoting Client lÃ  phÃ­a Veeam Server. ThÃ¬ mÃ¬nh nghÄ© ráº¥t cÃ³ thá»ƒ Mount Service á»Ÿ phÃ­a Veeam sáº½ gá»i Ä‘áº¿n Mount Service á»Ÿ má»™t host khÃ¡c vÃ  chá»©c nÄƒng cÃ³ liÃªn quan Ä‘áº¿n restore.\nMÃ¬nh Ä‘Ã£ suy nghÄ© ráº¥t nhiá»u vá» Ä‘iá»u nÃ y, Ä‘Ã£ thá»±c hiá»‡n sá»­ dá»¥ng má»™t sá»‘ chá»©c nÄƒng nhÆ° thá»±c hiá»‡n backup má»™t volume trÃªn Windows Server Ä‘Ã£ join domain vÃ  thá»±c hiá»‡n restore, vÃ  7749 láº§n thá»­ khÃ¡c nhÆ°ng váº«n khÃ´ng reach Ä‘Æ°á»£c tá»›i sink deserialize. NhÆ°ng nghÄ© láº¡i thÃ¬ viá»‡c backup khÃ´ng yÃªu cáº§u pháº£i add server Ä‘Ã³ vÃ o trÆ°á»›c (cÃ¡i mÃ  issue detail yÃªu cáº§u), nÃªn mÃ¬nh Ä‘Ã£ suy nghÄ© theo má»™t hÆ°á»›ng khÃ¡c, cÃ³ thá»ƒ liÃªn quan Ä‘áº¿n sá»­ dá»¥ng má»™t mÃ¡y Windows Ä‘Ã£ join domain lÃ m má»™t Storage Infrastructure Ä‘á»ƒ chá»©a cÃ¡c báº£n backup, sau Ä‘Ã³, thá»±c hiá»‡n backup má»™t volume trÃªn mÃ¡y báº¥t ká»³ vÃ  lÆ°u trÃªn mÃ¡y Windows Storage Ä‘Ã³ sau Ä‘Ã³ thá»±c hiá»‡n restore láº¡i vá»›i backup data Ä‘Æ°á»£c láº¥y tá»« remote storage, vÃ  quÃ¡ trÃ¬nh nÃ y cÅ©ng pháº£i Ä‘Ã²i há»i authenticate Ä‘áº¿n server storage (Ä‘áº·c biá»‡t lÃ  náº¿u Ä‘Ã£ join domain).\nLÃ½ thuyáº¿t lÃ  váº­y nhÆ°ng ta pháº£i cáº§n má»™t sá»‘ yáº¿u tá»‘ ná»¯a Ä‘á»ƒ cháº¯c cháº¯n, lÃºc nÃ y thÃ¬ mÃ¬nh chuyá»ƒn qua tÃ¬m nÆ¡i client gá»i lÃªn server, search vá»›i keyword cÆ¡ báº£n nhÆ° RestoreService. Táº¡i sao mÃ¬nh search nhÆ° váº­y? LÃ  táº¡i vÃ¬ nhÆ° Ä‘Ã£ nÃ³i thÃ¬ client muá»‘n káº¿t ná»‘i Ä‘áº¿n server thÃ¬ ngoÃ i pháº£i biáº¿t ip + port ra cÃ²n pháº£i biáº¿t service name, nÃªn náº¿u cÃ³ gá»i Ä‘Ã¢u Ä‘Ã³ trong Mount Service thÃ¬ cháº¯c cháº¯n sáº½ khai bÃ¡o Ä‘Ã¢u Ä‘Ã³ trong Ä‘Ã¢y.\nRáº¥t may máº¯n lÃ  phÃ¡n Ä‘oÃ¡n cá»§a mÃ¬nh chÃ­nh xÃ¡c, táº¡i constructor cá»§a class Veeam.Backup.Interaction.MountService.CVeeamRestoreServiceProxy táº¡o má»™t TCP url cÃ³ chá»©a RestoreService service name Táº¡i Ä‘Ã¢y, ta phÃ¢n tÃ­ch tháº¥y ráº±ng:\nprivate CVeeamRestoreServiceProxy(CConnection connection, string serviceUri, string channelName) { CVeeamRestoreServiceProxy \u003c\u003e4__this = this; this._connection = connection; this._creator = new CMbrCreator\u003cIVeeamRestoreService\u003e(delegate { string saobjectURL = RemotingHelper.GetSAObjectURL(\"tcp\", \u003c\u003e4__this._connection.HostName, \u003c\u003e4__this._connection.HostPort, serviceUri); string spn = SKerberosHelper.GetSpn(\u003c\u003e4__this._connection.HostName, SKerberosHelper.SPN_SERVICE_CLASS_Mount); return (IVeeamRestoreService)new CSecuredProxy(typeof(IVeeamRestoreService), saobjectURL, (\u003c\u003e4__this._connection.Creds == null) ? null : new CNetworkCredential(\u003c\u003e4__this._connection.Creds), spn, \u003c\u003e4__this._connection.RemoteVersion, null, null, channelName).GetTransparentProxy(); }); this._connection.MbrCreators.Add(this._creator); } náº¿u nhÆ° \u003c\u003e4__this._connection.Creds khÃ´ng pháº£i null thÃ¬ sáº½ sá»­ dá»¥ng CNetworkCredential Ä‘á»ƒ authen qua network stream, Ä‘i sÃ¢u vÃ o quan sÃ¡t class Veeam.Common.Remoting.CNetworkCredential, náº¿u nhÆ° khÃ´ng cÃ³ thÃ´ng tin domain thÃ¬ sáº½ throw exception vÃ  cÃ¡c bÆ°á»›c tÃ¡ch username vá»›i domain thá»±c hiá»‡n táº¡i class Veeam.Backup.Common.CCredentials =\u003e Ä‘Ã¢y cÃ³ thá»ƒ lÃ  cÃ¢u tráº£ lá»i cho Backup infrastructure servers that are not domain-joined are not impacted by this vulnerability.\nDo Ä‘Ã³, pháº§n cÃ²n láº¡i cá»§a mÃ¬nh hiá»‡n táº¡i lÃ  á»Ÿ Mount Service tÃ¬m ra chá»©c nÄƒng gá»i Ä‘áº¿n nÃ³, nhÆ° cÃ¡c báº¡n cÃ³ thá»ƒ tháº¥y ráº±ng Ä‘Ã¢y lÃ  má»™t vÃ­ dá»¥ khÃ¡ Ä‘áº¹p: nhÃ¬n sÆ¡ qua, thÃ¬ tháº¥y chá»©c nÄƒng Log Exporter ráº¥t cÃ³ tiá»m nÄƒng, sau Ä‘Ã³ mÃ¬nh Ä‘Ã£ Ä‘áº·t break-point vÃ  search google + chatgpt Ä‘á»§ kiá»ƒu, thÃ¬ chá»‰ tháº¥y Ä‘Æ°á»£c má»™t chá»©c nÄƒng liÃªn quan Ä‘áº¿n log export lÃ  táº¡i Help \u003e Support Information \u003e Export Logs nhÆ°ng cá»© export log mÃ£i trÃªn mÃ¡y Windows Ä‘Ã£ join domain mÃ  khÃ´ng tháº¥y break-point hitğŸ˜¢. Báº¥t lá»±c nÃªn mÃ¬nh quyáº¿t Ä‘á»‹nh kiá»ƒm tra cÃ¡c nhÃ¡nh Find Usage cÃ²n láº¡i.\nLáº¡i thÃªm má»™t chá»©c nÄƒng tÃ¬m nÄƒng khÃ¡c chÃ­nh lÃ  ScanForViruses vÃ  ScanWithYara vÃ  mÃ¬nh nháº­n ra hai chá»©c nÄƒng nÃ y mÃ¬nh Ä‘Ã£ gáº·p nÃ³ á»Ÿ Ä‘Ã¢u Ä‘Ã³ rá»“i thÃ¬ pháº£i :)) vÃ  cá»¥ thá»ƒ lÃ  á»Ÿ chá»©c nÄƒng Restore nÃ y Äá»ƒ kiá»ƒm tra Ä‘iá»u nÃ y, mÃ¬nh thá»±c hiá»‡n Ä‘áº·t break-point táº¡i constructor cá»§a class Veeam.Backup.Interaction.MountService.CVeeamRestoreServiceProxy, sau Ä‘Ã³ thá»±c hiá»‡n restore kÃ¨m theo chá»©c nÄƒng scan content vá»›i antivirus Ä‘á»ƒ debug, nhÆ°ng Ä‘áº¿n khi viá»‡c restore hoÃ n táº¥t mÃ  bp váº«n khÃ´ng hit??? :((\nTá»« Ä‘Ã³ mÃ¬nh Ä‘áº·t ra giáº£ thuyáº¿t ráº±ng cÃ³ thá»ƒ chá»©c nÄƒng nÃ y khÃ´ng Ä‘Æ°á»£c gá»i bá»Ÿi process hiá»‡n táº¡i lÃ  Mount Service vÃ  Ä‘Ã³ cÅ©ng lÃ  lÃ½ do break-point khÃ´ng hit Ä‘Æ°á»£c! Sau Ä‘Ã³, mÃ¬nh Ä‘Ã£ tiáº¿n hÃ nh xem xÃ©t cÃ¡c process cÃ²n láº¡i, kÃ¨m theo má»™t sá»‘ thÃ´ng tin tá»« ChatGPT thÃ¬ nháº­n tháº¥y ráº±ng ráº¥t cÃ³ kháº£ nÄƒng chá»©c nÄƒng nÃ y Ä‘Æ°á»£c gá»i bá»Ÿi process Veeam.Backup.Service.exe, thá»±c hiá»‡n tÆ°Æ¡ng tá»± nhÆ° bÆ°á»›c trÃªn thÃ¬ BOOOOOM! Callstack:\nVeeam.Common.Remoting.dll!Veeam.Common.Remoting.RemotingHelper.GetSAObjectURL(string proto, string machine, int port, string uri) (IL=0x0000, Native=0x00007FFC05D77DE0+0x16) Veeam.Backup.Interaction.MountService.dll!Veeam.Backup.Interaction.MountService.CVeeamRestoreServiceProxy.\u003c\u003ec__DisplayClass3_0.\u003c.ctor\u003eb__0() (ILâ‰ˆ0x0000, Native=0x00007FFC05D77BF0+0x6A) Veeam.Common.Remoting.dll!Veeam.Common.Remoting.CMbrCreator.CMbrCreator(Veeam.Common.Remoting.CreateMbrDelegate dlgCreate) (ILâ‰ˆ0x0018, Native=0x00007FFC0571ABF0+0x3D) Veeam.Backup.Interaction.MountService.dll!Veeam.Backup.Interaction.MountService.CVeeamRestoreServiceProxy.CVeeamRestoreServiceProxy(Veeam.Backup.Interaction.MountService.CConnection connection, string serviceUri, string channelName) (IL=0x003A, Native=0x00007FFC05D77AF0+0xA4) Veeam.Backup.Interaction.MountService.dll!Veeam.Backup.Interaction.MountService.CRemoteRestoreProxyClient.CRemoteRestoreProxyClient(Veeam.Backup.Model.CClientSessionClientInfo clientInfo, Veeam.Backup.Interaction.MountService.CConnection connection) (IL=0x0092, Native=0x00007FFC05D77840+0x1E6) Veeam.Backup.Interaction.MountService.dll!Veeam.Backup.Interaction.MountService.CRemoteRestoreProxyClient.ConnectTo(Veeam.Backup.Model.CClientSessionClientInfo clientInfo, string ipOrDnsName, int port, Veeam.Backup.Common.CCredentials credentialsOrNull) (ILâ‰ˆ0x0034, Native=0x00007FFC05D77180+0x11D) Veeam.Backup.ServiceLib.dll!Veeam.Backup.ServiceLib.CRestoreManagementService.CreateRemoteRestoreProxyClient(Veeam.Backup.Model.CRestoreProxyBinding proxyBinding) (IL=epilog, Native=0x00007FFC05D76FD0+0xC1) Veeam.Backup.ServiceLib.dll!Veeam.Backup.ServiceLib.CRestoreManagementService.FindFirstAvailableAntivirus(Veeam.Backup.Model.CRestoreProxyBinding proxyBinding) (IL=prolog, Native=0x00007FFC05D76F10+0x19) Veeam.Backup.ServiceLib.dll!Veeam.Backup.ServiceLib.CRestoreManagementService.IsAntivirusExists(Veeam.Backup.Model.CRestoreProxyBinding proxyBinding) (ILâ‰ˆ0x0000, Native=0x00007FFC05D76EE0+0x9) ... Yeah, sink Ä‘Ã£ reach vÃ  váº¥n Ä‘á» Ä‘au Ä‘áº§u nháº¥t cÃ³ váº» Ä‘Ã£ giáº£i quyáº¿t xong, giá» thÃ¬ chá»‰ cÃ²n viá»‡c build láº¡i malicious server Ä‘á»ƒ exploit ná»¯a lÃ  xong!\n#Exploit Ã tÆ°á»Ÿng lÃ  chá»‰ cáº§n táº¡o má»™t TcpServerChannel tráº£ vá» má»™t .NET Remoting Message trong Ä‘Ã³ body lÃ  deserialize payload. Trong Ä‘Ã³, server Ä‘áº£m báº£o ráº±ng:\nPort: 6170 Authentication: required Channel Name: rstcp Service Name: RestoreService CÃ³ thá»ƒ cÃ¡c báº¡n tháº¯c máº¯c má»™t sá»‘ chá»• trÃªn poc, nhÆ°ng vÃ¬ Ä‘á»ƒ trÃ¡nh post dÃ i nÃªn cÃ¡c báº¡n cÃ³ thá»ƒ tá»± tÃ¬m hiá»ƒu qua cÃ¡c tÃ i liá»‡u mÃ¬nh Ä‘Ã­nh kÃ¨m trÃªn bÃ i nÃ y nhÃ©!\n#PoC #References https://www.veeam.com/kb4771 https://helpcenter.veeam.com/docs/backup/vsphere/components.html?ver=120 https://helpcenter.veeam.com/docs/backup/vsphere/add_windows_server.html?ver=120 ",
  "wordCount" : "2864",
  "inLanguage": "en",
  "image": "https://nhienit2010.github.io/images/papermod-cover.png","datePublished": "2025-11-28T21:34:54+07:00",
  "dateModified": "2025-11-28T21:34:54+07:00",
  "author":[{
    "@type": "Person",
    "name": "nhienit"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://nhienit2010.github.io/posts/story-about-veeam-and-dotnet-remoting/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "nhienit",
    "logo": {
      "@type": "ImageObject",
      "url": "https://nhienit2010.github.io/favicon.ico"
    }
  }
}
</script>
</head>
<body id="top">
    <header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://nhienit2010.github.io/" accesskey="h" title="nhienit (Alt + H)">nhienit</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://nhienit2010.github.io/archives/" title="Archive">
                    <span>Archive</span>
                </a>
            </li>
            <li>
                <a href="https://nhienit2010.github.io/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://nhienit2010.github.io/">Home</a>&nbsp;Â»&nbsp;<a href="https://nhienit2010.github.io/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      CÃ¢u chuyá»‡n vá» Veeam vÃ  .NET Remoting (CVE-2025-48983)
    </h1>
    <div class="post-meta"><span title='2025-11-28 21:34:54 +0700 +07'>November 28, 2025</span>&nbsp;Â·&nbsp;<span>14 min</span>&nbsp;Â·&nbsp;<span>nhienit</span>&nbsp;|&nbsp;<span>
    <a href="https://github.com/adityatelange/hugo-PaperMod/tree/exampleSite/content/posts/story-about-veeam-and-dotnet-remoting.md" rel="noopener noreferrer edit" target="_blank">Suggest Changes</a>
</span>

</div>
  </header> <div class="toc">
    <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#m%e1%bb%9f-%c4%91%e1%ba%a7u" aria-label="#Má»Ÿ Ä‘áº§u">#Má»Ÿ Ä‘áº§u</a></li>
                <li>
                    <a href="#c%c3%a1c-version-b%e1%bb%8b-%e1%ba%a3nh-h%c6%b0%e1%bb%9fng" aria-label="#CÃ¡c version bá»‹ áº£nh hÆ°á»Ÿng">#CÃ¡c version bá»‹ áº£nh hÆ°á»Ÿng</a></li>
                <li>
                    <a href="#setup-m%c3%b4i-tr%c6%b0%e1%bb%9dng" aria-label="#Setup mÃ´i trÆ°á»ng">#Setup mÃ´i trÆ°á»ng</a></li>
                <li>
                    <a href="#ph%c3%a2n-t%c3%adch-b%e1%ba%a3n-v%c3%a1" aria-label="#PhÃ¢n tÃ­ch báº£n vÃ¡">#PhÃ¢n tÃ­ch báº£n vÃ¡</a></li>
                <li>
                    <a href="#ph%c3%a2n-t%c3%adch" aria-label="#PhÃ¢n tÃ­ch">#PhÃ¢n tÃ­ch</a><ul>
                        
                <li>
                    <a href="#net-remoting" aria-label="#.NET Remoting">#.NET Remoting</a></li>
                <li>
                    <a href="#backup-infrastructure" aria-label="#Backup Infrastructure">#Backup Infrastructure</a></li>
                <li>
                    <a href="#storage-infrastructure" aria-label="#Storage Infrastructure">#Storage Infrastructure</a></li>
                <li>
                    <a href="#cve-2025-48983" aria-label="#CVE-2025-48983">#CVE-2025-48983</a></li></ul>
                </li>
                <li>
                    <a href="#exploit" aria-label="#Exploit">#Exploit</a></li>
                <li>
                    <a href="#poc" aria-label="#PoC">#PoC</a></li>
                <li>
                    <a href="#references" aria-label="#References">#References</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><p>CÃ³ thá»ƒ xem nhÆ° Ä‘Ã¢y lÃ  bÃ i post Ä‘áº§u tiÃªn cá»§a mÃ¬nh trong nÄƒm nay, cÅ©ng gáº§n cuá»‘i nÄƒm má»›i cÃ³ há»©ng Ä‘á»ƒ viáº¿t bÃ i vÃ  má»™t pháº§n cÅ©ng vÃ¬ dáº¡o nÃ y cÅ©ng cáº£m tháº¥y khÃ´ng cÃ³ gÃ¬ hay ho Ä‘á»ƒ viáº¿t háº¿t cáº£ ğŸ˜¢!</p>
<p>NÃªn trong lÃºc lÆ°á»£n lá» má»™t vÃ²ng quanh internet Ä‘á»ƒ tÃ¬m cáº£m há»©ng, vÃ´ tÃ¬nh tÃ¬m tháº¥y má»™t list <a href="https://www.veeam.com/kb4771">advisory</a> vÃ  cÅ©ng thÃ´i thÃºc mÃ¬nh thá»­ tÃ¬m hiá»ƒu xem cÃ¡c CVE nÃ y cÃ³ gÃ¬ hay mÃ  Ä‘iá»ƒm CVSS Ä‘áº¿n táº­n 9.9. VÃ¬ tháº¿, nÃªn mÃ¬nh Ä‘Ã£ chá»n CVE-2025-48983 Ä‘á»ƒ phÃ¢n tÃ­ch vÃ  dÃ¹ sao thÃ¬ cÅ©ng má»™t cÃ´ng Ä‘Ã´i viá»‡c, báº¯t Ä‘áº§u thÃ´i nÃ o !</p>
<h3 id="má»Ÿ-Ä‘áº§u">#Má»Ÿ Ä‘áº§u<a hidden class="anchor" aria-hidden="true" href="#má»Ÿ-Ä‘áº§u">#</a></h3>
<p>Veeam Backup &amp; Replication lÃ  pháº§n má»m sao lÆ°u vÃ  phá»¥c há»“i dá»¯ liá»‡u phá»• biáº¿n dÃ nh cho mÃ´i trÆ°á»ng áº£o hÃ³a, váº­t lÃ½ vÃ  Ä‘Ã¡m mÃ¢y, chá»§ yáº¿u dÃ¹ng trong doanh nghiá»‡p. Trong Ä‘Ã³, á»©ng dá»¥ng tá»“n táº¡i má»™t sá»‘ thÃ nh pháº§n chÃ­nh nhÆ° :</p>
<ul>
<li>Veeam Backup Server : server chÃ­nh quáº£n lÃ½ cÃ¡c jobs, repository, proxy, &hellip;</li>
<li>Veeam Backup Proxy : giÃºp thá»±c thi Ä‘á»c/ghi dá»¯ liá»‡u, tÄƒng tá»‘c Ä‘á»™ backup, &hellip;</li>
<li>Veeam Backup Repository : lÃ  nÆ¡i lÆ°u trá»¯ cÃ¡c file backup</li>
<li>Veeam Agent : Ä‘á»ƒ cÃ i lÃªn mÃ¡y host dÃ¹ng cho viá»‡c backup/restore</li>
<li>Veeam Console : GUI quáº£n lÃ½ chung, xem cÃ¡c jobs, policy, &hellip;</li>
<li>&hellip;</li>
</ul>
<p><img loading="lazy" src="/images/story-about-veeam-and-dotnet-remoting/1.png">
Lá»— há»•ng Ä‘Æ°á»£c report bá»Ÿi <a href="https://code-white.com/">Code White</a> lÃ  má»™t tá»• chá»©c an ninh máº¡ng ná»•i tiáº¿ng táº¡i Äá»©c, liÃªn quan Ä‘áº¿n dá»‹ch vá»¥ <code>Mount Service</code> trÃªn á»©ng dá»¥ng <code>Veeam Backup &amp; Replication</code> cho phÃ©p thá»±c thi mÃ£ tá»« xa (RCE) trÃªn cÃ¡c mÃ¡y host náº±m trong Backup Infrastructure vá»›i quyá»n domain user vÃ  nhá»¯ng host khÃ´ng join domain thÃ¬ sáº½ khÃ´ng bá»‹ áº£nh hÆ°á»Ÿng bá»Ÿi lá»— há»•ng nÃ y.</p>
<p>Äá»c lÆ°á»›t qua nghe thÃ¬ cÃ³ váº» rá»‘i nÃ£o, nhÆ°ng cÃ³ má»™t sá»‘ Ã½ ta cáº§n pháº£i note láº¡i trong quÃ¡ trÃ¬nh phÃ¢n tÃ­ch nhÆ°: <code>Mount Service</code>, <code>RCE</code>, <code>authenticated domain user</code>, <code>Backup Infrastructure</code> vÃ¬ chÃºng cÃ³ thá»ƒ sáº½ giÃºp ta thu háº¹p láº¡i pháº¡m vi code audit trong quÃ¡ trÃ¬nh phÃ¢n tÃ­ch.</p>
<h3 id="cÃ¡c-version-bá»‹-áº£nh-hÆ°á»Ÿng">#CÃ¡c version bá»‹ áº£nh hÆ°á»Ÿng<a hidden class="anchor" aria-hidden="true" href="#cÃ¡c-version-bá»‹-áº£nh-hÆ°á»Ÿng">#</a></h3>
<ul>
<li>Veeam Backup &amp; Replication &lt;= 12.3.2.3617</li>
</ul>
<h3 id="setup-mÃ´i-trÆ°á»ng">#Setup mÃ´i trÆ°á»ng<a hidden class="anchor" aria-hidden="true" href="#setup-mÃ´i-trÆ°á»ng">#</a></h3>
<p>Thá»±c hiá»‡n download cÃ¡c báº£n cÃ i Ä‘áº·t:</p>
<ul>
<li>Installer: <a href="https://download2.veeam.com/VBR/v12/VeeamBackup&amp;Replication_12.3.2.3617_20250610.iso">https://download2.veeam.com/VBR/v12/VeeamBackup&Replication_12.3.2.3617_20250610.iso</a></li>
<li>Patch: <a href="https://www.veeam.com/download_add_packs/vmware-esx-backup/12.3.2.4165_20251014_update_exe/">https://www.veeam.com/download_add_packs/vmware-esx-backup/12.3.2.4165_20251014_update_exe/</a></li>
</ul>
<p>Sau khi thá»±c hiá»‡n download file cÃ i Ä‘áº·t dáº¡ng .iso xong, thá»±c hiá»‡n mount ra Ä‘Ä©a, run <code>setup.exe</code> vÃ  cÃ i Ä‘áº·t háº¿t cÃ¡c option trong Ä‘Ã³ lÃ  coi nhÆ° viá»‡c cÃ i Ä‘áº·t hoÃ n táº¥t.</p>
<p>Tuy nhiÃªn, cÃ³ má»™t sá»‘ pháº§n service cáº§n license Ä‘á»ƒ cÃ i Ä‘áº·t, thÃ¬ cÃ³ thá»ƒ táº¡o tÃ i khoáº£n táº¡i <a href="https://my.veeam.com/">https://my.veeam.com/</a> vÃ  vÃ o pháº§n <code>Trial license</code> láº¥y license dÃ¹ng thá»­ Ä‘á»ƒ thá»±c hiá»‡n cÃ i Ä‘áº·t.</p>
<p><img loading="lazy" src="/images/story-about-veeam-and-dotnet-remoting/2.png"></p>
<h3 id="phÃ¢n-tÃ­ch-báº£n-vÃ¡">#PhÃ¢n tÃ­ch báº£n vÃ¡<a hidden class="anchor" aria-hidden="true" href="#phÃ¢n-tÃ­ch-báº£n-vÃ¡">#</a></h3>
<p>Theo nhÆ° mÃ´ táº£ trÃªn Issue Details, nháº­n tháº¥y ráº±ng lá»— há»•ng chá»§ yáº¿u náº±m táº¡i <code>Mount Service</code>, nÃªn sá»­ dá»¥ng dnspy attach vÃ o process <code>Veeam.Backup.MountService.exe</code>
<img loading="lazy" src="/images/story-about-veeam-and-dotnet-remoting/3.png"></p>
<p>vÃ  sau Ä‘Ã³ thá»±c hiá»‡n load háº¿t cÃ¡c module mÃ  process Ä‘ang sá»­ dá»¥ng
<img loading="lazy" src="/images/story-about-veeam-and-dotnet-remoting/4.png"></p>
<p>trÆ°á»›c khi decompile ra cÃ¡c file csharp, Ä‘áº£m báº£o option <code>Show tokens,...</code> táº¡i <code>Debug &gt; Options &gt; Decompiler</code> Ä‘Æ°á»£c bá» tick, má»¥c Ä‘Ã­ch lÃ  Ä‘á»ƒ bá» bá»›t cÃ¡c thÃ´ng tin mÃ´ táº£ thá»«a hoáº·c byte rÃ¡c Ä‘á»ƒ thuáº­n tiá»‡n cho viá»‡c diff.
<img loading="lazy" src="/images/story-about-veeam-and-dotnet-remoting/7.png"></p>
<p>Sau Ä‘Ã³, táº¡i <code>Assembly Explorer</code> thá»±c hiá»‡n nháº¥n tá»• há»£p phÃ­m <code>Ctrl + A</code> Ä‘á»ƒ chá»n háº¿t cÃ¡c assembly vÃ  sau Ä‘Ã³ chá»n <code>File &gt; Export to Project...</code> Ä‘á»ƒ thá»±c hiá»‡n decompile ra má»™t thÆ° má»¥c chuáº©n bá»‹ cho viá»‡c diff.
<img loading="lazy" src="/images/story-about-veeam-and-dotnet-remoting/6.png"></p>
<p>Vá» pháº§n báº£n vÃ¡, táº¡i folder <code>Fixed</code> ta tháº¥y cÃ³ má»™t báº£n cÃ i Ä‘áº·t riÃªng cho <code>Mount Service</code> lÃ  <code>VeeamMountService.msi</code>,
<img loading="lazy" src="/images/story-about-veeam-and-dotnet-remoting/8.png">
chá»• nÃ y ta thá»±c hiá»‡n cÃ i Ä‘áº·t riÃªng nÃ³ trÃªn má»™t mÃ¡y khÃ¡c hoáº·c á»Ÿ Ä‘Ã¢u Ä‘Ã³ vÃ  thá»±c hiá»‡n decompile tÆ°Æ¡ng tá»± báº±ng dnspy nhÆ° cÃ¡ch trÃªn.</p>
<p>Sau khi decompile version bá»‹ lá»—i vÃ  cáº£ báº£n vÃ¡, viá»‡c cÃ²n láº¡i lÃ  vá»©t vÃ o <code>WinMerge</code> Ä‘á»ƒ diff thÃ´i. VÃ  á»Ÿ cáº£ pháº§n diff nÃ y thÃ¬ mÃ¬nh cÅ©ng sáº½ chá»§ yáº¿u focus táº¡i cÃ¡c namespace cá»§a Mount Service nhÆ°:</p>
<ul>
<li><code>Veeam.Backup.MountServiceLib.*</code></li>
<li><code>Veeam.Backup.MountService.*</code></li>
</ul>
<p>Trong lÃºc xem xÃ©t báº£n vÃ¡, táº¡i constructor cá»§a class <code>Veeam.Backup.MountServiceLib.CMountServiceEnvironment</code> cÃ³ má»™t Ä‘iá»ƒm cáº£m tháº¥y báº¥t thÆ°á»ng vÃ  khiáº¿n mÃ¬nh tÃ² mÃ² muá»‘n phÃ¢n tÃ­ch sÃ¢u lÃ  báº£n vÃ¡ Ä‘Ã£ add thÃªm tham sá»‘ thá»© 3 cho hÃ m <code>CCliTcpChannelRegistration.Make()</code> vÃ  force value lÃ  <code>true</code>.<br>
<img loading="lazy" src="/images/story-about-veeam-and-dotnet-remoting/9.png"></p>
<p>Theo nhÆ° báº£n gá»‘c, thÃ¬ táº¡i hÃ m <code>Veeam.Common.Remoting.CCliTcpChannelRegistration#Make()</code> chÆ°a define hÃ m nÃ o nháº­n vÃ o tham sá»‘ thá»© 3 lÃ  kiá»ƒu boolean nÃªn hiá»‡n táº¡i chÆ°a biáº¿t tham sá»‘ thá»© ba trÃªn cÃ³ Ã½ nghÄ©a lÃ  gÃ¬ cáº£!
<img loading="lazy" src="/images/story-about-veeam-and-dotnet-remoting/10.png"></p>
<p>Trá»Ÿ vá» xem xÃ©t láº¡i báº£n diff, táº¡i <code>Veeam.Common.Remoting.CCliTcpChannelRegistration</code> Ä‘Ã£ thÃªm má»™t new version cá»§a hÃ m <code>Make()</code> vá»›i thÃªm má»™t argument lÃ  <code>whitelistResponse</code>
<img loading="lazy" src="/images/story-about-veeam-and-dotnet-remoting/11.png">
<img loading="lazy" src="/images/story-about-veeam-and-dotnet-remoting/12.png"></p>
<p>vÃ  tham sá»‘ <code>whitelistResponse</code> nÃ y, Ä‘Æ°á»£c Ä‘áº·t tháº³ng vÃ o <code>Veeam.Common.Remoting.CBinaryClientFormatterSinkProvider</code>.</p>
<p>NhÃ¬n sÆ¡ bá»™, náº¿u ai Ä‘Ã£ tá»«ng xem qua thÃ¬ cÃ³ thá»ƒ nháº­n tháº¥y ráº±ng chÆ°Æ¡ng trÃ¬nh Ä‘ang khá»Ÿi táº¡o má»™t <code>.NET Remoting Client</code> service cÃ²n hoáº¡t Ä‘á»™ng nhÆ° nÃ o thÃ¬ mÃ¬nh sáº½ giá»›i thiá»‡u sau nhÆ°ng á»Ÿ Ä‘Ã¢y chÆ°Æ¡ng trÃ¬nh cÃ³ sá»­ dá»¥ng má»™t sink provider lÃ  <code>CBinaryClientFormatterSinkProvider</code>.</p>
<p>CÃ³ thá»ƒ hiá»ƒu nÃ´m na lÃ  cÃ¡c sink provider dÃ¹ng Ä‘á»ƒ táº¡o hoáº·c cáº¥u hÃ¬nh lÃªn má»™t chuá»—i cÃ¡i sink (sink chain) vÃ  má»—i sink Ä‘Æ°á»£c sinh ra Ä‘á»ƒ thá»±c hiá»‡n xá»­ lÃ½ luá»“ng message Ä‘i qua cÃ¡c channel cho viá»‡c logging, serialzation, decrypt, uncompression, &hellip; cÃ¡c message Ä‘á»ƒ server xá»­ lÃ½ hoáº·c xuá»‘ng táº§ng transport Ä‘á»ƒ gá»­i Ä‘i qua channel khÃ¡c.</p>
<p>NhÆ° Ä‘Ã£ nÃ³i, viá»‡c táº¡o cÃ¡c sink sáº½ Ä‘Æ°á»£c gá»i qua hÃ m <code>CreateSink()</code>, cá»¥ thá»ƒ táº¡i class <code>Veeam.Common.Remoting.CBinaryClientFormatterSinkProvider</code> nhÆ° sau:
<img loading="lazy" src="/images/story-about-veeam-and-dotnet-remoting/13.png"></p>
<p>sáº½ tráº£ vá» má»™t instance cá»§a <code>CBinaryClientFormatterSink</code>, trong Ä‘Ã³ argument <code>_whitelistResponse</code> lÃ  thá»© mÃ  ta cáº§n quan tÃ¢m. VÃ¬ Ä‘Ã¢y lÃ  má»™t <code>.NET Remoting Client</code> nÃªn cÃ³ thá»ƒ quan sÃ¡t tháº¥y ráº±ng há» khÃ´ng implement cÃ¡c hÃ m xá»­ lÃ½ request message
<img loading="lazy" src="/images/story-about-veeam-and-dotnet-remoting/14.png">
<img loading="lazy" src="/images/story-about-veeam-and-dotnet-remoting/15.png"></p>
<p>táº¡i hÃ m <code>Veeam.Common.Remoting.CBinaryClientFormatterSink#AsyncProcessResponse()</code> thá»±c hiá»‡n deserialize response stream thÃ´ng qua hÃ m <code>DeserializeMessage()</code>
<img loading="lazy" src="/images/story-about-veeam-and-dotnet-remoting/16.png"></p>
<p>tiáº¿p tá»¥c, gá»i tiáº¿p hÃ m <code>Veeam.Common.Remoting.CCoreChannel#DeserializeBinaryResponseMessage()</code>
<img loading="lazy" src="/images/story-about-veeam-and-dotnet-remoting/17.png"></p>
<p>lÃºc nÃ y biáº¿n <code>whitelistResponse</code> Ä‘Æ°á»£c Ä‘á»•i tÃªn thÃ nh <code>useRestrictedBinder</code>
<img loading="lazy" src="/images/story-about-veeam-and-dotnet-remoting/18.png"></p>
<p>vÃ  Ä‘Ã¢y lÃ  máº¥u chá»‘t cá»§a váº¥n Ä‘á», khi <code>useRestrictedBinder</code> lÃ  <code>true</code> thÃ¬ chÆ°Æ¡ng trÃ¬nh sáº½ sá»­ dá»¥ng class <code>RestrictedSerializationBinder</code> cho <code>BinaryFormatter</code> Ä‘á»ƒ ngÄƒn cháº·n deserialization attack nÃªn Ä‘Ã³ cÅ©ng lÃ  lÃ½ do báº£n vÃ¡ force value lÃ  <code>true</code> cho tham sá»‘ thá»© ba cá»§a hÃ m <code>Veeam.Common.Remoting.CCliTcpChannelRegistration#Make()</code>
<img loading="lazy" src="/images/story-about-veeam-and-dotnet-remoting/19.png"></p>
<p>Táº¡i báº£n cÅ©, by default lÃ  <code>false</code> vÃ¬ cÃ³ thá»ƒ developer nghÄ© ráº±ng client luÃ´n káº¿t ná»‘i Ä‘áº¿n má»i <code>.NET Remoting Server</code> Ä‘Ã¡ng tin cáº­y hoáº·c khÃ´ng thá»ƒ nÃ o modify Ä‘á»ƒ táº¡o ra Ä‘Æ°á»£c má»™t malicious response Ä‘á»ƒ táº¥n cÃ´ng chá»• nÃ y :))
<img loading="lazy" src="/images/story-about-veeam-and-dotnet-remoting/20.png"></p>
<h3 id="phÃ¢n-tÃ­ch">#PhÃ¢n tÃ­ch<a hidden class="anchor" aria-hidden="true" href="#phÃ¢n-tÃ­ch">#</a></h3>
<p>CÅ©ng khÃ´ng quÃ¡ khÃ³ Ä‘á»ƒ chÃºng ta cÃ³ thá»ƒ tÃ¬m Ä‘Æ°á»£c sink cá»§a lá»— há»•ng nhÆ° bÃªn trÃªn, cÃ²n láº¡i viá»‡c tÃ¬m Ä‘iá»ƒm Ä‘á»ƒ trigger lá»— há»•ng thÃ¬ mÃ¬nh nghÄ© má»›i thá»±c sá»± lÃ  váº¥n Ä‘á» :)). NhÆ°ng trÆ°á»›c khi Ä‘i sÃ¢u vÃ o phÃ¢n tÃ­ch thÃ¬ cÃ³ má»™t sá»‘ khÃ¡i niá»‡m cáº§n pháº£i tÃ¬m hiá»ƒu.</p>
<h4 id="net-remoting">#.NET Remoting<a hidden class="anchor" aria-hidden="true" href="#net-remoting">#</a></h4>
<p>Theo cÃ¡ch hiá»ƒu nÃ´m na cá»§a mÃ¬nh, Ä‘Ã¢y lÃ  má»™t cÃ´ng nghá»‡ cho phÃ©p cÃ¡c Application Domain hoáº·c cÃ¡c process cÃ³ thá»ƒ giao tiáº¿p Ä‘Æ°á»£c vá»›i nhau thÃ´ng qua cÃ¡c channel. ThÃ¬ vá» cÆ¡ báº£n, cÃ¡c Application Domain hoáº·c cÃ¡c process Ä‘Æ°á»£c cÃ´ láº­p vá»›i nhau Ä‘á»ƒ náº¿u cÃ³ xáº£y ra trá»¥c tráº·c sáº½ trÃ¡nh áº£nh hÆ°á»Ÿng Ä‘áº¿n quÃ¡ trÃ¬nh hoáº¡t Ä‘á»™ng cá»§a nhau, vÃ¬ tháº¿ .NET Remoting ra Ä‘á»i nhÆ° má»™t cáº§u ná»‘i Ä‘á»ƒ chÃºng cÃ³ thá»ƒ giao tiáº¿p Ä‘Æ°á»£c vá»›i nhau (hay cÃ²n gá»i lÃ  giao tiáº¿p liÃªn tiáº¿n trÃ¬nh). CÆ¡ cháº¿ hoáº¡t Ä‘á»™ng cá»§a .NET Remoting cÅ©ng na nÃ¡ so vá»›i Java RMI, nghÄ©a lÃ  mÃ´ hÃ¬nh cho phÃ©p server expose má»™t sá»‘ object, Ä‘á»“ng thá»i táº¡o instance cho cÃ¡c object Ä‘Ã³ cho phÃ©p cÃ¡c client cÃ³ thá»ƒ nÃ³ gá»i tá»« xa (remotable object), vÃ  phÃ­a client cÃ³ thá»ƒ gá»i cÃ¡c remotable object Ä‘Ã³ trÃªn process á»Ÿ phÃ­a server thÃ´ng qua giao thá»©c TCP/HTTP/IPC.</p>
<p>TrÃªn phÃ­a server sáº½ define má»™t táº­p cÃ¡c object Ä‘Æ°á»£c expose ra bÃªn ngoÃ i cho client cÃ³ thá»ƒ gá»i tá»›i, song Ä‘Ã³ thÃ¬ phÃ­a client cÅ©ng pháº£i cÃ³ táº­p cÃ¡c instance vá» nhá»¯ng remotable object Ä‘Ã³ trÆ°á»›c khi call lÃªn server. ThÆ°á»ng thÃ¬ cÃ¡c remotable object nÃ y Ä‘Æ°á»£c gÃ³i vÃ  chia sáº» trong cÃ¡c file dll.</p>
<p>ThÆ°á»ng thÃ¬ cÃ¡c remotable object nÃªn Ä‘Æ°á»£c káº¿ thá»«a tá»« class/interface lÃ  <code>Serializable</code> hoáº·c <code>MarshalByRefObject</code> thÃ¬ cÃ¡c client má»›i cÃ³ thá»ƒ gá»i tá»« xa , kiá»ƒu nhÆ° sau:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Linq</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Text</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Threading.Tasks</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">namespace</span> <span class="nn">RemotingSample</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kd">public</span> <span class="k">class</span> <span class="nc">RemoteMath</span> <span class="p">:</span> <span class="n">MarshalByRefObject</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">int</span> <span class="n">Add</span><span class="p">(</span><span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">)</span>    <span class="c1">// add</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&#34;Add({0},{1}) called&#34;</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="n">a</span> <span class="p">+</span> <span class="n">b</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">int</span> <span class="n">Sub</span><span class="p">(</span><span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">)</span>    <span class="c1">// subtract</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&#34;Sub({0},{1}) called&#34;</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="n">a</span> <span class="p">-</span> <span class="n">b</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>ThÃ´ng tin vá» cÃ¡c sink provider mÃ¬nh cÅ©ng Ä‘Ã£ nÃ³i sÆ¡ á»Ÿ bÃªn trÃªn, ta cÃ³ thá»ƒ hÃ¬nh dung mÃ´ hÃ¬nh hoáº¡t Ä‘á»™ng nhÆ° á»Ÿ bÃªn dÆ°á»›i:
<figure>
    <img loading="lazy" src="/images/story-about-veeam-and-dotnet-remoting/21.webp"
         alt="Nguá»“n: https://g7shot.com/posts/net/netremoting101/"/> <figcaption>
            <p>Nguá»“n: <a href="https://g7shot.com/posts/net/netremoting101/">https://g7shot.com/posts/net/netremoting101/</a></p>
        </figcaption>
</figure>
</p>
<p>Framework cung cáº¥p 2 cÆ¡ cháº¿ cho phÃ©p cÃ¡c object cÃ³ thá»ƒ Ä‘i qua cÃ¡c domain vá»›i nhau lÃ  <code>Marshalling by reference</code> vÃ  <code>Marshalling by value</code>.</p>
<ul>
<li>CÆ¡ cháº¿ <code>Marshalled by value</code> Ä‘Æ°á»£c sá»­ dá»¥ng khi má»™t object Ä‘Æ°á»£c marked lÃ  <code>Serializable</code> attribute, Ä‘á»ƒ há»— trá»£ Ä‘iá»u nÃ y thÃ¬ BinaryFormatter class Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ convert thÃ nh cÃ¡c byte stream Ä‘á»ƒ truyá»n qua cÃ¡c AppDomain khÃ¡c.</li>
<li>Náº¿u má»™t object cáº§n <code>Marshalled by reference</code> thÃ¬ nÃ³ cáº§n pháº£i implement tá»« class <code>System.MarshalByRefObject</code>, báº¥t ká»³ object nÃ o báº¯t nguá»“n tá»« type nÃ y thÃ¬ tá»± Ä‘á»™ng Ä‘Æ°á»£c xá»­ lÃ½ bá»Ÿi framework, khi nÃ³ Ä‘i qua Application Domain khÃ¡c thÃ¬ framework sáº½ gá»i hÃ m <code>MarshalByRefObject.CreateObjRef</code> Ä‘á»ƒ tráº£ vá» má»™t instance cá»§a <code>System.Runtime.Remoting.ObjRef</code> , thÃ¬ instance sáº½ chá»©a táº¥t cáº£ cÃ¡c thÃ´ng tin cáº§n Ä‘á»ƒ tham chiáº¿u tá»›i object cáº§n Ä‘Æ°á»£c gá»i vÃ  giao tiáº¿p ngÆ°á»£c láº¡i vá»›i channel. Object <code>ObjRef</code> Ä‘Æ°á»£c truyá»n qua cÃ¡c Application Domain khÃ¡c báº±ng cÃ¡ch serialize thÃ nh dáº¡ng byte stream, bÃªn Application Domain nháº­n sáº½ thá»±c hiá»‡n deserialize vÃ  construct láº¡i object nÃ y.</li>
</ul>
<p>TrÃªn lÃ  theo gÃ³c nhÃ¬n cá»§a mÃ¬nh, tháº­t ra kiáº¿n trÃºc nÃ y phá»©c táº¡p nhiá»u hÆ¡n mÃ¬nh nghÄ© Ä‘á»‘i vá»›i gÃ³c nhÃ¬n cá»§a mÃ¬nh cÃ³ thá»ƒ cÃ³ nhiá»u sai sÃ³t nÃªn Ä‘á»ƒ chi tiáº¿t hÆ¡n thÃ¬ cÃ¡c báº¡n cÃ³ thá»ƒ Ä‘á»c thÃªm táº¡i cÃ¡c tÃ i liá»‡u sau:</p>
<ul>
<li><a href="https://parsiya.net/blog/2015-11-14-intro-to-.net-remoting-for-hackers/">https://parsiya.net/blog/2015-11-14-intro-to-.net-remoting-for-hackers/</a></li>
<li><a href="https://www.codeproject.com/Articles/18997/Remoting-Architecture-in-NET">https://www.codeproject.com/Articles/18997/Remoting-Architecture-in-NET</a></li>
<li><a href="http://rfc.nop.hu/winprot4/MS-NRTP.pdf">http://rfc.nop.hu/winprot4/MS-NRTP.pdf</a></li>
<li><a href="https://g7shot.com/posts/net/netremoting101/">https://g7shot.com/posts/net/netremoting101/</a></li>
</ul>
<h4 id="backup-infrastructure">#Backup Infrastructure<a hidden class="anchor" aria-hidden="true" href="#backup-infrastructure">#</a></h4>
<p>Backup Infrastructure trong Veeam Backup &amp; Replication lÃ  toÃ n bá»™ táº­p há»£p cÃ¡c thÃ nh pháº§n pháº§n cá»©ng vÃ  pháº§n má»m Ä‘Æ°á»£c Veeam sá»­ dá»¥ng Ä‘á»ƒ thá»±c hiá»‡n cÃ¡c hoáº¡t Ä‘á»™ng backup, restore vÃ  replication. Má»¥c Ä‘Ã­ch lÃ  giÃºp Veeam:</p>
<ul>
<li>Káº¿t ná»‘i Ä‘áº¿n mÃ´i trÆ°á»ng áº£o hÃ³a (VMware, Hyper-V), mÃ¡y váº­t lÃ½, cloud.</li>
<li>Quáº£n lÃ½ luá»“ng dá»¯ liá»‡u (Ä‘á»c â†’ xá»­ lÃ½ â†’ lÆ°u trá»¯).</li>
<li>XÃ¡c Ä‘á»‹nh nÆ¡i lÆ°u backup, cÃ¡ch cháº¡y job vÃ  tÃ i nguyÃªn sá»­ dá»¥ng.</li>
</ul>
<p><img loading="lazy" src="/images/story-about-veeam-and-dotnet-remoting/22.png"></p>
<h4 id="storage-infrastructure">#Storage Infrastructure<a hidden class="anchor" aria-hidden="true" href="#storage-infrastructure">#</a></h4>
<p>Storage Infrastructure trong Veeam lÃ  táº­p há»£p cÃ¡c há»‡ thá»‘ng lÆ°u trá»¯ mÃ  Veeam cÃ³ thá»ƒ káº¿t ná»‘i trá»±c tiáº¿p Ä‘á»ƒ láº¥y snapshot, Ä‘á»c dá»¯ liá»‡u hoáº·c tá»‘i Æ°u hoÃ¡ quÃ¡ trÃ¬nh backup vÃ  restore. GiÃºp Veeam:</p>
<ul>
<li>Khai thÃ¡c storage snapshot Ä‘á»ƒ backup nhanh hÆ¡n vÃ  khÃ´ng áº£nh hÆ°á»Ÿng Ä‘áº¿n production.</li>
<li>TÄƒng tá»‘c Ä‘á»™ restore (Instant VM Recovery, file/volume recovery).</li>
</ul>
<p><img loading="lazy" src="/images/story-about-veeam-and-dotnet-remoting/23.png"></p>
<h4 id="cve-2025-48983">#CVE-2025-48983<a hidden class="anchor" aria-hidden="true" href="#cve-2025-48983">#</a></h4>
<p>NghiÃªn cá»©u láº¡i má»™t xÃ­u vá» Mount Service, ngoÃ i viá»‡c chÆ°Æ¡ng trÃ¬nh táº¡o má»™t .NET Remoting Client (táº¡i line 49) thÃ¬ bÃªn cáº¡nh cÃ²n táº¡o thÃªm má»™t .NET Remoting Server (táº¡i line 48) ná»¯a vá»›i channel name lÃ  <code>rstcp</code>
<img loading="lazy" src="/images/story-about-veeam-and-dotnet-remoting/24.png"></p>
<p>Dá»‹ch vá»¥ nÃ y run táº¡i port <code>6170</code>
<img loading="lazy" src="/images/story-about-veeam-and-dotnet-remoting/25.png">
<img loading="lazy" src="/images/story-about-veeam-and-dotnet-remoting/26.png"></p>
<p>vÃ  cÅ©ng lÃ  port <code>Mount Service</code> Ä‘ang cháº¡y
<img loading="lazy" src="/images/story-about-veeam-and-dotnet-remoting/27.png"></p>
<p>.NET Remoting Server cháº¡y vá»›i má»™t sá»‘ cáº¥u hÃ¬nh nhÆ° sau:
<img loading="lazy" src="/images/story-about-veeam-and-dotnet-remoting/28.png"></p>
<p><code>dictionary[&quot;secure&quot;] = &quot;true&quot;</code> cho tháº¥y ráº±ng client cáº§n pháº£i xÃ¡c thá»±c trÆ°á»›c khi truy cáº­p vÃ o dá»‹ch vá»¥ bÃªn trong, Ä‘iá»u nÃ y cÅ©ng gáº§n giá»‘ng vá»›i mÃ´ táº£ cá»§a issue details :))</p>
<p>NgoÃ i port ra, má»™t thá»© ta cáº§n biáº¿t ná»¯a lÃ  service name, vÃ¬ pháº£i biáº¿t service name thÃ¬ client má»›i connect Ä‘áº¿n chÃ­nh xÃ¡c Ä‘Æ°á»£c. Trace code ngÆ°á»£c láº¡i tá»« lÃºc init enviroment, ta tháº¥y Ä‘Æ°á»£c hÃ m <code>Veeam.Backup.MountService.CMountService#OnStart()</code> sáº½ Ä‘Æ°á»£c gá»i khi Mount Service cháº¡y.
<img loading="lazy" src="/images/story-about-veeam-and-dotnet-remoting/30.png"></p>
<p>bá»Ÿi vÃ¬ class <code>Veeam.Backup.MountService.CMountService</code> Ä‘Æ°á»£c implement tá»« <code>System.ServiceProcess.ServiceBase</code>
<img loading="lazy" src="/images/story-about-veeam-and-dotnet-remoting/31.png"></p>
<p>Theo document:
<img loading="lazy" src="/images/story-about-veeam-and-dotnet-remoting/32.png"></p>
<p>Táº¡i hÃ m <code>Veeam.Backup.MountServiceLib.CRestoreServiceRemotingApiRegistration#RegisterRemotingTypes()</code> sáº½ thá»±c hiá»‡n Ä‘Äƒng kÃ½ má»™t .NET Remoting service
<img loading="lazy" src="/images/story-about-veeam-and-dotnet-remoting/33.png"></p>
<p>VÃ  cuá»‘i cÃ¹ng thÃ¬ mÃ¬nh cÅ©ng tháº¥y Ä‘Æ°á»£c service name Ä‘Æ°á»£c define táº¡i <code>Veeam.Backup.MountServiceLib.CMountServiceImpl#StartLeasing()</code> cÃ³ tÃªn lÃ  <code>RestoreService</code>
<img loading="lazy" src="/images/story-about-veeam-and-dotnet-remoting/29.png"></p>
<p>NhÆ° phÃ¢n tÃ­ch tá»« bÆ°á»›c Ä‘áº§u, sink ta cáº§n reach Ä‘áº¿n lÃ  chá»©c nÄƒng deserialize response á»Ÿ .NET Remoting Client lÃ  phÃ­a Veeam Server. ThÃ¬ mÃ¬nh nghÄ© ráº¥t cÃ³ thá»ƒ Mount Service á»Ÿ phÃ­a Veeam sáº½ gá»i Ä‘áº¿n Mount Service á»Ÿ má»™t host khÃ¡c vÃ  chá»©c nÄƒng cÃ³ liÃªn quan Ä‘áº¿n restore.</p>
<p>MÃ¬nh Ä‘Ã£ suy nghÄ© ráº¥t nhiá»u vá» Ä‘iá»u nÃ y, Ä‘Ã£ thá»±c hiá»‡n sá»­ dá»¥ng má»™t sá»‘ chá»©c nÄƒng nhÆ° thá»±c hiá»‡n backup má»™t volume trÃªn Windows Server Ä‘Ã£ join domain vÃ  thá»±c hiá»‡n restore, vÃ  7749 láº§n thá»­ khÃ¡c nhÆ°ng váº«n khÃ´ng reach Ä‘Æ°á»£c tá»›i sink deserialize. NhÆ°ng nghÄ© láº¡i thÃ¬ viá»‡c backup khÃ´ng yÃªu cáº§u pháº£i add server Ä‘Ã³ vÃ o trÆ°á»›c (cÃ¡i mÃ  issue detail yÃªu cáº§u), nÃªn mÃ¬nh Ä‘Ã£ suy nghÄ© theo má»™t hÆ°á»›ng khÃ¡c, cÃ³ thá»ƒ liÃªn quan Ä‘áº¿n sá»­ dá»¥ng má»™t mÃ¡y Windows Ä‘Ã£ join domain lÃ m má»™t <code>Storage Infrastructure</code> Ä‘á»ƒ chá»©a cÃ¡c báº£n backup,
<img loading="lazy" src="/images/story-about-veeam-and-dotnet-remoting/34.png"></p>
<p>sau Ä‘Ã³, thá»±c hiá»‡n backup má»™t volume trÃªn mÃ¡y báº¥t ká»³ vÃ  lÆ°u trÃªn mÃ¡y Windows Storage Ä‘Ã³
<img loading="lazy" src="/images/story-about-veeam-and-dotnet-remoting/35.png"></p>
<p>sau Ä‘Ã³ thá»±c hiá»‡n restore láº¡i vá»›i backup data Ä‘Æ°á»£c láº¥y tá»« remote storage, vÃ  quÃ¡ trÃ¬nh nÃ y cÅ©ng pháº£i Ä‘Ã²i há»i authenticate Ä‘áº¿n server storage (Ä‘áº·c biá»‡t lÃ  náº¿u Ä‘Ã£ join domain).</p>
<p>LÃ½ thuyáº¿t lÃ  váº­y nhÆ°ng ta pháº£i cáº§n má»™t sá»‘ yáº¿u tá»‘ ná»¯a Ä‘á»ƒ cháº¯c cháº¯n, lÃºc nÃ y thÃ¬ mÃ¬nh chuyá»ƒn qua tÃ¬m nÆ¡i client gá»i lÃªn server, search vá»›i keyword cÆ¡ báº£n nhÆ° <code>RestoreService</code>. Táº¡i sao mÃ¬nh search nhÆ° váº­y? LÃ  táº¡i vÃ¬ nhÆ° Ä‘Ã£ nÃ³i thÃ¬ client muá»‘n káº¿t ná»‘i Ä‘áº¿n server thÃ¬ ngoÃ i pháº£i biáº¿t ip + port ra  cÃ²n pháº£i biáº¿t service name, nÃªn náº¿u cÃ³ gá»i Ä‘Ã¢u Ä‘Ã³ trong Mount Service thÃ¬ cháº¯c cháº¯n sáº½ khai bÃ¡o Ä‘Ã¢u Ä‘Ã³ trong Ä‘Ã¢y.</p>
<p>Ráº¥t may máº¯n lÃ  phÃ¡n Ä‘oÃ¡n cá»§a mÃ¬nh chÃ­nh xÃ¡c, táº¡i constructor cá»§a class <code>Veeam.Backup.Interaction.MountService.CVeeamRestoreServiceProxy</code> táº¡o má»™t TCP url cÃ³ chá»©a <code>RestoreService</code> service name
<img loading="lazy" src="/images/story-about-veeam-and-dotnet-remoting/36.png"></p>
<p>Táº¡i Ä‘Ã¢y, ta phÃ¢n tÃ­ch tháº¥y ráº±ng:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="kd">private</span> <span class="n">CVeeamRestoreServiceProxy</span><span class="p">(</span><span class="n">CConnection</span> <span class="n">connection</span><span class="p">,</span> <span class="kt">string</span> <span class="n">serviceUri</span><span class="p">,</span> <span class="kt">string</span> <span class="n">channelName</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">CVeeamRestoreServiceProxy</span> <span class="p">&lt;&gt;</span><span class="m">4__</span><span class="k">this</span> <span class="p">=</span> <span class="k">this</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="n">_connection</span> <span class="p">=</span> <span class="n">connection</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="n">_creator</span> <span class="p">=</span> <span class="k">new</span> <span class="n">CMbrCreator</span><span class="p">&lt;</span><span class="n">IVeeamRestoreService</span><span class="p">&gt;(</span><span class="k">delegate</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">string</span> <span class="n">saobjectURL</span> <span class="p">=</span> <span class="n">RemotingHelper</span><span class="p">.</span><span class="n">GetSAObjectURL</span><span class="p">(</span><span class="s">&#34;tcp&#34;</span><span class="p">,</span> <span class="p">&lt;&gt;</span><span class="m">4__</span><span class="k">this</span><span class="p">.</span><span class="n">_connection</span><span class="p">.</span><span class="n">HostName</span><span class="p">,</span> <span class="p">&lt;&gt;</span><span class="m">4__</span><span class="k">this</span><span class="p">.</span><span class="n">_connection</span><span class="p">.</span><span class="n">HostPort</span><span class="p">,</span> <span class="n">serviceUri</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="kt">string</span> <span class="n">spn</span> <span class="p">=</span> <span class="n">SKerberosHelper</span><span class="p">.</span><span class="n">GetSpn</span><span class="p">(&lt;&gt;</span><span class="m">4__</span><span class="k">this</span><span class="p">.</span><span class="n">_connection</span><span class="p">.</span><span class="n">HostName</span><span class="p">,</span> <span class="n">SKerberosHelper</span><span class="p">.</span><span class="n">SPN_SERVICE_CLASS_Mount</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">(</span><span class="n">IVeeamRestoreService</span><span class="p">)</span><span class="k">new</span> <span class="n">CSecuredProxy</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">IVeeamRestoreService</span><span class="p">),</span> <span class="n">saobjectURL</span><span class="p">,</span> <span class="p">(&lt;&gt;</span><span class="m">4__</span><span class="k">this</span><span class="p">.</span><span class="n">_connection</span><span class="p">.</span><span class="n">Creds</span> <span class="p">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">?</span> <span class="kc">null</span> <span class="p">:</span> <span class="k">new</span> <span class="n">CNetworkCredential</span><span class="p">(&lt;&gt;</span><span class="m">4__</span><span class="k">this</span><span class="p">.</span><span class="n">_connection</span><span class="p">.</span><span class="n">Creds</span><span class="p">),</span> <span class="n">spn</span><span class="p">,</span> <span class="p">&lt;&gt;</span><span class="m">4__</span><span class="k">this</span><span class="p">.</span><span class="n">_connection</span><span class="p">.</span><span class="n">RemoteVersion</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="n">channelName</span><span class="p">).</span><span class="n">GetTransparentProxy</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">});</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="n">_connection</span><span class="p">.</span><span class="n">MbrCreators</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">_creator</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>náº¿u nhÆ° <code>&lt;&gt;4__this._connection.Creds</code> khÃ´ng pháº£i  <code>null</code> thÃ¬ sáº½ sá»­ dá»¥ng <code>CNetworkCredential</code> Ä‘á»ƒ authen qua network stream, Ä‘i sÃ¢u vÃ o quan sÃ¡t class <code>Veeam.Common.Remoting.CNetworkCredential</code>, náº¿u nhÆ° khÃ´ng cÃ³ thÃ´ng tin domain thÃ¬ sáº½ throw exception
<img loading="lazy" src="/images/story-about-veeam-and-dotnet-remoting/37.png"></p>
<p>vÃ  cÃ¡c bÆ°á»›c tÃ¡ch username vá»›i domain thá»±c hiá»‡n táº¡i class <code>Veeam.Backup.Common.CCredentials</code>
<img loading="lazy" src="/images/story-about-veeam-and-dotnet-remoting/38.png"></p>
<p>=&gt; Ä‘Ã¢y cÃ³ thá»ƒ lÃ  cÃ¢u tráº£ lá»i cho <code>Backup infrastructure servers that are not domain-joined are not impacted by this vulnerability.</code></p>
<p>Do Ä‘Ã³, pháº§n cÃ²n láº¡i cá»§a mÃ¬nh hiá»‡n táº¡i lÃ  á»Ÿ Mount Service tÃ¬m ra chá»©c nÄƒng gá»i Ä‘áº¿n nÃ³, nhÆ° cÃ¡c báº¡n cÃ³ thá»ƒ tháº¥y ráº±ng Ä‘Ã¢y lÃ  má»™t vÃ­ dá»¥ khÃ¡ Ä‘áº¹p:
<img loading="lazy" src="/images/story-about-veeam-and-dotnet-remoting/39.png"></p>
<p>nhÃ¬n sÆ¡ qua, thÃ¬ tháº¥y chá»©c nÄƒng Log Exporter ráº¥t cÃ³ tiá»m nÄƒng, sau Ä‘Ã³ mÃ¬nh Ä‘Ã£ Ä‘áº·t break-point vÃ  search google + chatgpt Ä‘á»§ kiá»ƒu, thÃ¬ chá»‰ tháº¥y Ä‘Æ°á»£c má»™t chá»©c nÄƒng liÃªn quan Ä‘áº¿n log export lÃ  táº¡i <code>Help &gt; Support Information &gt; Export Logs</code>
<img loading="lazy" src="/images/story-about-veeam-and-dotnet-remoting/40.png"></p>
<p>nhÆ°ng cá»© export log mÃ£i trÃªn mÃ¡y Windows Ä‘Ã£ join domain mÃ  khÃ´ng tháº¥y break-point hitğŸ˜¢. Báº¥t lá»±c nÃªn mÃ¬nh quyáº¿t Ä‘á»‹nh kiá»ƒm tra cÃ¡c nhÃ¡nh Find Usage cÃ²n láº¡i.</p>
<p>Láº¡i thÃªm má»™t chá»©c nÄƒng tÃ¬m nÄƒng khÃ¡c chÃ­nh lÃ  <code>ScanForViruses</code> vÃ  <code>ScanWithYara</code>
<img loading="lazy" src="/images/story-about-veeam-and-dotnet-remoting/41.png"></p>
<p>vÃ  mÃ¬nh nháº­n ra hai chá»©c nÄƒng nÃ y mÃ¬nh Ä‘Ã£ gáº·p nÃ³ á»Ÿ Ä‘Ã¢u Ä‘Ã³ rá»“i thÃ¬ pháº£i :)) vÃ  cá»¥ thá»ƒ lÃ  á»Ÿ chá»©c nÄƒng <code>Restore</code> nÃ y
<img loading="lazy" src="/images/story-about-veeam-and-dotnet-remoting/42.png"></p>
<p>Äá»ƒ kiá»ƒm tra Ä‘iá»u nÃ y, mÃ¬nh thá»±c hiá»‡n Ä‘áº·t break-point táº¡i constructor cá»§a class <code>Veeam.Backup.Interaction.MountService.CVeeamRestoreServiceProxy</code>,
<img loading="lazy" src="/images/story-about-veeam-and-dotnet-remoting/43.png"></p>
<p>sau Ä‘Ã³ thá»±c hiá»‡n restore kÃ¨m theo chá»©c nÄƒng scan content vá»›i antivirus Ä‘á»ƒ debug, nhÆ°ng Ä‘áº¿n khi viá»‡c restore hoÃ n táº¥t mÃ  bp váº«n khÃ´ng hit??? :((</p>
<p>Tá»« Ä‘Ã³ mÃ¬nh Ä‘áº·t ra giáº£ thuyáº¿t ráº±ng cÃ³ thá»ƒ chá»©c nÄƒng nÃ y khÃ´ng Ä‘Æ°á»£c gá»i bá»Ÿi process hiá»‡n táº¡i lÃ  Mount Service vÃ  Ä‘Ã³ cÅ©ng lÃ  lÃ½ do break-point khÃ´ng hit Ä‘Æ°á»£c! Sau Ä‘Ã³, mÃ¬nh Ä‘Ã£ tiáº¿n hÃ nh xem xÃ©t cÃ¡c process cÃ²n láº¡i, kÃ¨m theo má»™t sá»‘ thÃ´ng tin tá»« ChatGPT thÃ¬ nháº­n tháº¥y ráº±ng ráº¥t cÃ³ kháº£ nÄƒng chá»©c nÄƒng nÃ y Ä‘Æ°á»£c gá»i bá»Ÿi process <code>Veeam.Backup.Service.exe</code>, thá»±c hiá»‡n tÆ°Æ¡ng tá»± nhÆ° bÆ°á»›c trÃªn thÃ¬ <strong>BOOOOOM</strong>!
<img loading="lazy" src="/images/story-about-veeam-and-dotnet-remoting/44.png"></p>
<p>Callstack:</p>
<pre tabindex="0"><code>Veeam.Common.Remoting.dll!Veeam.Common.Remoting.RemotingHelper.GetSAObjectURL(string proto, string machine, int port, string uri) (IL=0x0000, Native=0x00007FFC05D77DE0+0x16)
Veeam.Backup.Interaction.MountService.dll!Veeam.Backup.Interaction.MountService.CVeeamRestoreServiceProxy.&lt;&gt;c__DisplayClass3_0.&lt;.ctor&gt;b__0() (ILâ‰ˆ0x0000, Native=0x00007FFC05D77BF0+0x6A)
Veeam.Common.Remoting.dll!Veeam.Common.Remoting.CMbrCreator&lt;Veeam.Backup.Interaction.MountService.IVeeamRestoreService&gt;.CMbrCreator(Veeam.Common.Remoting.CreateMbrDelegate&lt;Veeam.Backup.Interaction.MountService.IVeeamRestoreService&gt; dlgCreate) (ILâ‰ˆ0x0018, Native=0x00007FFC0571ABF0+0x3D)
Veeam.Backup.Interaction.MountService.dll!Veeam.Backup.Interaction.MountService.CVeeamRestoreServiceProxy.CVeeamRestoreServiceProxy(Veeam.Backup.Interaction.MountService.CConnection connection, string serviceUri, string channelName) (IL=0x003A, Native=0x00007FFC05D77AF0+0xA4)
Veeam.Backup.Interaction.MountService.dll!Veeam.Backup.Interaction.MountService.CRemoteRestoreProxyClient.CRemoteRestoreProxyClient(Veeam.Backup.Model.CClientSessionClientInfo clientInfo, Veeam.Backup.Interaction.MountService.CConnection connection) (IL=0x0092, Native=0x00007FFC05D77840+0x1E6)
Veeam.Backup.Interaction.MountService.dll!Veeam.Backup.Interaction.MountService.CRemoteRestoreProxyClient.ConnectTo(Veeam.Backup.Model.CClientSessionClientInfo clientInfo, string ipOrDnsName, int port, Veeam.Backup.Common.CCredentials credentialsOrNull) (ILâ‰ˆ0x0034, Native=0x00007FFC05D77180+0x11D)
Veeam.Backup.ServiceLib.dll!Veeam.Backup.ServiceLib.CRestoreManagementService.CreateRemoteRestoreProxyClient(Veeam.Backup.Model.CRestoreProxyBinding proxyBinding) (IL=epilog, Native=0x00007FFC05D76FD0+0xC1)
Veeam.Backup.ServiceLib.dll!Veeam.Backup.ServiceLib.CRestoreManagementService.FindFirstAvailableAntivirus(Veeam.Backup.Model.CRestoreProxyBinding proxyBinding) (IL=prolog, Native=0x00007FFC05D76F10+0x19)
Veeam.Backup.ServiceLib.dll!Veeam.Backup.ServiceLib.CRestoreManagementService.IsAntivirusExists(Veeam.Backup.Model.CRestoreProxyBinding proxyBinding) (ILâ‰ˆ0x0000, Native=0x00007FFC05D76EE0+0x9)
...
</code></pre><p>Yeah, sink Ä‘Ã£ reach vÃ  váº¥n Ä‘á» Ä‘au Ä‘áº§u nháº¥t cÃ³ váº» Ä‘Ã£ giáº£i quyáº¿t xong, giá» thÃ¬ chá»‰ cÃ²n viá»‡c build láº¡i malicious server Ä‘á»ƒ exploit ná»¯a lÃ  xong!</p>
<h3 id="exploit">#Exploit<a hidden class="anchor" aria-hidden="true" href="#exploit">#</a></h3>
<p>Ã tÆ°á»Ÿng lÃ  chá»‰ cáº§n táº¡o má»™t TcpServerChannel tráº£ vá» má»™t .NET Remoting Message trong Ä‘Ã³ body lÃ  deserialize payload. Trong Ä‘Ã³, server Ä‘áº£m báº£o ráº±ng:</p>
<ul>
<li>Port: 6170</li>
<li>Authentication: required</li>
<li>Channel Name: rstcp</li>
<li>Service Name: RestoreService</li>
</ul>
<script src="https://gist.github.com/nhienit2010/9ab201df36b03c099670e90f94d6252c.js"></script>
<p>CÃ³ thá»ƒ cÃ¡c báº¡n tháº¯c máº¯c má»™t sá»‘ chá»• trÃªn poc, nhÆ°ng vÃ¬ Ä‘á»ƒ trÃ¡nh post dÃ i nÃªn cÃ¡c báº¡n cÃ³ thá»ƒ tá»± tÃ¬m hiá»ƒu qua cÃ¡c tÃ i liá»‡u mÃ¬nh Ä‘Ã­nh kÃ¨m trÃªn bÃ i nÃ y nhÃ©!</p>
<h3 id="poc">#PoC<a hidden class="anchor" aria-hidden="true" href="#poc">#</a></h3>
<div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
      <iframe allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share; fullscreen" loading="eager" referrerpolicy="strict-origin-when-cross-origin" src="https://www.youtube.com/embed/HlfDOg8DSRQ?autoplay=0&amp;controls=1&amp;end=0&amp;loop=0&amp;mute=0&amp;start=0" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;" title="YouTube video"></iframe>
    </div>

<h3 id="references">#References<a hidden class="anchor" aria-hidden="true" href="#references">#</a></h3>
<ul>
<li><a href="https://www.veeam.com/kb4771">https://www.veeam.com/kb4771</a></li>
<li><a href="https://helpcenter.veeam.com/docs/backup/vsphere/components.html?ver=120">https://helpcenter.veeam.com/docs/backup/vsphere/components.html?ver=120</a></li>
<li><a href="https://helpcenter.veeam.com/docs/backup/vsphere/add_windows_server.html?ver=120">https://helpcenter.veeam.com/docs/backup/vsphere/add_windows_server.html?ver=120</a></li>
</ul>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://nhienit2010.github.io/tags/research/">Research</a></li>
    </ul>
<nav class="paginav">
  <a class="next" href="https://nhienit2010.github.io/posts/me_sqli_to_rce/">
    <span class="title">Next Â»</span>
    <br>
    <span>ManageEngine Adaudit Plus â€“ From SQLi to RCE</span>
  </a>
</nav>



  </footer><div id="disqus_thread"></div>
<script>
(function() {
var d = document, s = d.createElement('script');
s.src = 'https://nhienit.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

</article>
    </main>
    
<footer class="footer">
        <span>Â©nhienit</span> Â· 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu');
    if (menu) {
        
        const scrollPosition = localStorage.getItem("menu-scroll-position");
        if (scrollPosition) {
            menu.scrollLeft = parseInt(scrollPosition, 10);
        }
        
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        const html = document.querySelector("html");
        if (html.dataset.theme === "dark") {
            html.dataset.theme = 'light';
            localStorage.setItem("pref-theme", 'light');
        } else {
            html.dataset.theme = 'dark';
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
